<<<<<<< HEAD
ï»¿<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì´ìŠ¤ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ ì‹¤ìŠµ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --border: #cbd5e1;
            --danger: #ef4444;
            --success: #22c55e;
            --dark: #1e293b;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 20px;
            color: #1e293b;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .tabs {
            display: flex;
            background: #334155;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 20px;
            color: #cbd5e1;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.95rem;
            white-space: nowrap;
            transition: 0.2s;
        }

        .tab:hover {
            color: #fbbf24;
            background: #475569;
        }

        .tab.active {
            color: #1e293b;
            background: #fbbf24;
            font-weight: bold;
            border-bottom: 3px solid #60a5fa;
        }

        .content {
            padding: 25px;
            display: none;
            min-height: 500px;
        }

        .content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .section-box {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fff;
        }

        .section-title {
            font-weight: bold;
            font-size: 1.05rem;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            padding-left: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        th,
        td {
            border: 1px solid var(--border);
            padding: 10px;
            text-align: center;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
        }

        input,
        select {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            text-align: center;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            border: none;
            color: white;
            transition: 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-dark {
            background: var(--dark);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .grid-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .info-box {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            color: #0369a1;
            font-size: 0.9rem;
        }

        .warning-box {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            color: #92400e;
        }

        .summary-card {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #bfdbfe;
            text-align: center;
        }

        .score-val {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .ratio-ok {
            background: #dcfce7;
            color: #166534;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .ratio-warn {
            background: #fef9c3;
            color: #854d0e;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .ratio-error {
            background: #fee2e2;
            color: #991b1b;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .sub-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .sub-tab {
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .sub-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .sub-tab.completed {
            background: #dcfce7;
            color: #166534;
            border-color: #86efac;
        }

        .invalid-input {
            background: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #dc2626 !important;
        }

        .warning-diff {
            background: #fef3c7 !important;
            border-color: #f59e0b !important;
        }

        .diff-alert {
            color: #dc2626;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        .radio-label input {
            margin-right: 10px;
        }

        .teacher-control {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .round-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .round-tab {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: bold;
            color: #64748b;
        }

        .round-tab.active {
            background: white;
            color: var(--primary);
            border-color: var(--primary);
        }

        .round-tab.add-btn {
            background: #ecfdf5;
            color: #059669;
            border-color: #a7f3d0;
        }

        .badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div>
                <h1>ğŸ“Š ë‚˜ì´ìŠ¤ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ ì‹¤ìŠµ (ver 1.0)</h1>
                <div style="font-size:0.85rem;opacity:0.8;margin-top:5px;">ë§Œë“ ì´ : ì‚¬ê³¡ê³  ìˆ˜ì„êµì‚¬ ìµœì—°í˜¸</div>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="btn btn-success" onclick="saveFullProject()">ğŸ’¾ ì „ì²´ ì €ì¥</button>
                <button class="btn btn-dark" onclick="document.getElementById('fullLoad').click()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <input type="file" id="fullLoad" style="display:none" accept=".json" onchange="loadFullProject(event)">
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">1. í‰ê°€êµ¬ì¡°</button>
            <button class="tab" onclick="switchTab(1)">2. ì •ê¸°ì‹œí—˜ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ</button>
            <button class="tab" onclick="switchTab(2)">3. ìˆ˜í–‰í‰ê°€ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ</button>
            <button class="tab" onclick="switchTab(3)">4. í•™ê¸°ë§ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ</button>
        </div>

        <!-- íƒ­ 0: í‰ê°€êµ¬ì¡° ì„¤ì • -->
        <div id="tab-0" class="content active">
            <div class="section-box">
                <div class="section-title">ğŸ“ ê¸°ë³¸ ì •ë³´</div>
                <div class="grid-3">
                    <div><label>í•™ë…„ë„</label><select id="year" style="width:100%" onchange="project.info.year=this.value">
                            <option>2026</option>
                            <option>2025</option>
                        </select></div>
                    <div><label>í•™ê¸°</label><select id="semester" style="width:100%"
                            onchange="project.info.semester=this.value">
                            <option>1í•™ê¸°</option>
                            <option>2í•™ê¸°</option>
                        </select></div>
                    <div><label>ê³¼ëª©ëª…</label><input type="text" id="subject" style="width:100%" placeholder="ì˜ˆ: ë¬¼ë¦¬í•™â… "
                            oninput="project.info.subject=this.value">
                    </div>
                </div>
            </div>

            <div class="section-box">
                <div class="section-title">ğŸ‘¥ êµì‚¬ ë“±ë¡ <span class="badge" id="teacherCount">0ëª…</span></div>
                <div class="teacher-control">
                    <input type="text" id="newTeacherName" placeholder="êµì‚¬ëª… ì…ë ¥"
                        onkeypress="if(event.key==='Enter')addTeacher()">
                    <button class="btn btn-primary btn-sm" onclick="addTeacher()">+ ì¶”ê°€</button>
                </div>
                <div id="teacherList" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
            </div>

            <div class="section-box">
                <div class="section-title">ğŸ“‹ ì •ê¸°ì‹œí—˜ êµ¬ì„± <span>í•©ê³„: <span id="paperRatioTotal"
                            class="ratio-warn">0%</span></span>
                    <button class="btn btn-primary btn-sm" onclick="addPaper()">+ ì¶”ê°€</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>êµ¬ë¶„</th>
                            <th>ë°°ì </th>
                            <th>ë°˜ì˜ë¹„ìœ¨(%)</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="paperTbody"></tbody>
                </table>
            </div>

            <div class="section-box">
                <div class="section-title">ğŸ“‹ ìˆ˜í–‰í‰ê°€ êµ¬ì„± <span>í•©ê³„: <span id="perfRatioTotal"
                            class="ratio-warn">0%</span></span>
                    <button class="btn btn-primary btn-sm" onclick="addPerf()">+ ì¶”ê°€</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ì˜ì—­ëª…</th>
                            <th>ë°°ì </th>
                            <th>ë°˜ì˜ë¹„ìœ¨(%)</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="perfTbody"></tbody>
                </table>
            </div>
            <div class="info-box">ğŸ’¡ ë°˜ì˜ë¹„ìœ¨ í•©ê³„: <strong id="totalRatio">0%</strong> (100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤)</div>
        </div>

        <!-- íƒ­ 1: ì •ê¸°ì‹œí—˜ -->
        <div id="tab-1" class="content">
            <div class="info-box">ğŸ“Œ ê° ì •ê¸°ì‹œí—˜ë³„ë¡œ ë¬¸í•­ì •ë³´í‘œë¥¼ ì—…ë¡œë“œí•˜ê³ , êµì‚¬ë³„ ì˜ˆìƒì •ë‹µë¥ ì„ ì…ë ¥í•©ë‹ˆë‹¤.</div>
            <div class="sub-tabs" id="paperSubTabs"></div>
            <div id="paperContent"></div>
        </div>

        <!-- íƒ­ 2: ìˆ˜í–‰í‰ê°€ -->
        <div id="tab-2" class="content">
            <div class="info-box">ğŸ“Œ ìˆ˜í–‰í‰ê°€ ì „ì²´ ì˜ì—­ê³¼ ì˜ì—­ë³„ ì¤‘ ì„ íƒ í›„ A~E ì„±ì·¨ìˆ˜ì¤€ë³„ ë¶„í• ì ìˆ˜ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</div>
            <div class="section-box">
                <div class="section-title">ğŸ“ ìˆ˜í–‰í‰ê°€ ë“±ê¸‰ë³„ ì ìˆ˜ ì…ë ¥</div>
                <table>
                    <thead id="perfCutsThead">
                        <tr>
                            <th>ì˜ì—­ëª…</th>
                            <th>ë§Œì </th>
                            <th>A</th>
                            <th>B</th>
                            <th>C</th>
                            <th>D</th>
                            <th>E</th>
                        </tr>
                    </thead>
                    <tbody id="perfCutsTbody"></tbody>
                </table>
            </div>
            <div class="section-box">
                <div class="section-title">ğŸ“Š ìˆ˜í–‰í‰ê°€ ë°˜ì˜ë¹„ìœ¨ ì ìš© ê²°ê³¼</div>
                <div class="grid-5" id="perfResultGrid"></div>
            </div>
        </div>

        <!-- íƒ­ 3: ìµœì¢…ê²°ê³¼ -->
        <div id="tab-3" class="content">
            <div class="section-box">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="section-title">ğŸ“Š ìƒì„¸ ì‚°ì¶œ ë‚´ì—­</div>
                </div>
                <!-- ìƒì„¸ ì‚°ì¶œ ë‚´ì—­ í…Œì´ë¸”ì€ calculateFinal() í˜¸ì¶œ ì‹œ ë Œë”ë§ë¨ -->
                <div id="detailBreakdown"></div>
            </div>

            <div
                style="position:relative; text-align:center; margin: 20px 0; display:flex; justify-content:center; align-items:center;">
                <button class="btn btn-primary" style="padding:15px 40px;font-size:1.1rem;"
                    onclick="calculateFinal()">ğŸ“Š ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ</button>
                <div style="position:absolute; right:0;">
                    <button class="btn btn-warning" onclick="alert('ë‚˜ì´ìŠ¤ì—ì„œ ê²°ì¬ë¥¼ ìƒì‹ í•©ë‹ˆë‹¤.')">ìŠ¹ì¸ ìš”ì²­</button>
                    <button class="btn btn-danger" onclick="alert('ë§ˆê°í•©ë‹ˆë‹¤.')">ë§ˆê°</button>
                </div>
            </div>

            <!-- ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ ê²°ê³¼ëŠ” ë²„íŠ¼ ëˆ„ë¥´ê¸° ì „ì—ë„ ë³´ì¼ ìˆ˜ ìˆìœ¼ë‚˜, ë¬¸ë§¥ìƒ 'ìƒì„¸ ì‚°ì¶œ ë‚´ì—­'ì€ í•­ìƒ ë³´ì´ê³  ê²°ê³¼ëŠ” ë²„íŠ¼ ëˆŒëŸ¬ ê°±ì‹ /í™•ì¸í•˜ëŠ” êµ¬ì¡°ê°€ ìì—°ìŠ¤ëŸ¬ì›€. -->
            <!-- í•˜ì§€ë§Œ ìš”ì²­ì‚¬í•­ì€ "ìƒì„¸ ì‚°ì¶œ ë‚´ì—­ì€ ë²„íŠ¼ì„ ëˆ„ë¥´ì§€ ì•Šì•„ë„ í‘œì‹œ"ì„. -->
            <!-- ë”°ë¼ì„œ ì´ˆê¸° ë¡œë”© ì‹œ í˜¹ì€ íƒ­ ì§„ì… ì‹œ calculateFinalì´ í˜¸ì¶œë˜ì–´ ì´ë¯¸ ê·¸ë ¤ì ¸ ìˆì„ ê²ƒì„. -->
            <!-- ë²„íŠ¼ì€ 'ì¬ì‚°ì¶œ' ë˜ëŠ” 'í™•ì¸' ì°¨ì›ì—ì„œ ì¡´ì¬í•˜ê±°ë‚˜, í•˜ë‹¨ ê²°ê³¼ì˜ì—­ ê°±ì‹ ìš©ì¼ ìˆ˜ ìˆìŒ. -->
            <div class="section-box">
                <div class="section-title">ğŸ† ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ ê²°ê³¼</div>
                <div class="grid-5" id="finalResultGrid"></div>
            </div>

            <!-- ê²°ê³¼ ì €ì¥ ë²„íŠ¼ ì‚­ì œë¨ -->
        </div>
    </div>

    <!-- ìŠ¹ì¸ìš”ì²­ ëª¨ë‹¬ -->
    <div id="approvalModal" class="modal">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">ğŸ“ ìŠ¹ì¸ ìš”ì²­</h2>
                <button onclick="closeModal('approvalModal')"
                    style="background:none;border:none;font-size:1.5rem;cursor:pointer;">âœ•</button>
            </div>
            <div style="margin-bottom:15px;"><label>ë¼ìš´ë“œ ì„ íƒ:</label><select id="approvalRoundSelect"
                    style="width:100%;margin-top:5px;"></select></div>
            <div class="warning-box">âš ï¸ ë‚˜ì´ìŠ¤ì—ì„œ ì„ íƒ í›„ ìƒì‹ í•¨</div>
            <div style="text-align:right;"><button class="btn btn-dark"
                    onclick="closeModal('approvalModal')">ë‹«ê¸°</button></div>
        </div>
    </div>

    <!-- ë§ˆê°ì·¨ì†Œ ëª¨ë‹¬ -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">ğŸ”“ ì…ë ¥ë§ˆê° ì·¨ì†Œ</h2>
                <button onclick="closeModal('cancelModal')"
                    style="background:none;border:none;font-size:1.5rem;cursor:pointer;">âœ•</button>
            </div>
            <div class="warning-box">âš ï¸ ë§ˆê°ì„ ì·¨ì†Œí•˜ë©´ í•´ë‹¹ ë¼ìš´ë“œë¥¼ ë‹¤ì‹œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            <div class="radio-group" style="margin-bottom:15px;">
                <label class="radio-label"><input type="radio" name="cancelReason" value="ë¬¸í•­ ì˜¤ë¥˜ë¡œ ì¸í•œ ë§Œì  ë³€ë™">ë¬¸í•­ ì˜¤ë¥˜ë¡œ ì¸í•œ ë§Œì 
                    ë³€ë™</label>
                <label class="radio-label"><input type="radio" name="cancelReason" value="ì „ë©´ ì¬ì‹œí—˜">ì „ë©´ ì¬ì‹œí—˜</label>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button class="btn btn-dark" onclick="closeModal('cancelModal')">ì·¨ì†Œ</button>
                <button class="btn btn-danger" onclick="confirmCancelFinalize()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œê²°ê³¼ ëª¨ë‹¬ -->
    <div id="resultModal" class="modal">
        <div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">ğŸ“Š ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œê²°ê³¼</h2>
                <button onclick="closeModal('resultModal')"
                    style="background:none;border:none;font-size:1.5rem;cursor:pointer;">âœ•</button>
            </div>
            <div id="resultModalContent"></div>
            <div
                style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;border-top:1px solid #e2e8f0;padding-top:15px;">
                <button class="btn btn-primary" onclick="exportRoundResultsToExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-success" onclick="openApprovalFromResult()">ğŸ“ ìŠ¹ì¸ìš”ì²­</button>
                <button class="btn btn-dark" onclick="closeModal('resultModal')">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // === ì „ì—­ ë°ì´í„° ===
        let project = {
            info: { year: '2026', semester: '1í•™ê¸°', subject: '' },
            teachers: [],
            papers: [{ name: '1íšŒ ì •ê¸°ì‹œí—˜', score: 100, ratio: 30, excelData: [], categories: [], teacherData: {}, currentRound: 0, scoreMode: 5 }],
            perfs: [{ name: 'ìˆ˜í–‰í‰ê°€1', score: 100, ratio: 40, cuts: [null, null, null, null, null] }],
            perfInputMode: 'all', // 'all' or 'each'
            perfTotalCuts: [null, null, null, null, null] // ì „ì²´ì˜ì—­ì¼ ë•Œ ì‚¬ìš©í•  ì ìˆ˜
        };
        let currentTab = 0;
        let currentPaperIdx = 0;

        // === íƒ­ ì „í™˜ ===
        function switchTab(idx) {
            currentTab = idx;
            document.querySelectorAll('.tab').forEach((t, i) => { if (i === idx) t.classList.add('active'); else t.classList.remove('active'); });
            document.querySelectorAll('.content').forEach((c, i) => { if (i === idx) c.style.display = 'block'; else c.style.display = 'none'; });
            if (idx === 0) renderSetup();
            else if (idx === 1) renderPaperTab();
            else if (idx === 2) renderPerfTab();
            else if (idx === 3) {
                calculateFinal();
            }
        }

        // === êµì‚¬ ê´€ë¦¬ ===
        function addTeacher() {
            const name = document.getElementById('newTeacherName').value.trim();
            if (!name) { alert('êµì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            if (project.teachers.includes(name)) { alert('ì´ë¯¸ ë“±ë¡ëœ êµì‚¬ì…ë‹ˆë‹¤.'); return; }
            project.teachers.push(name);
            document.getElementById('newTeacherName').value = '';
            renderTeacherList();
            // ê° ì§€í•„í‰ê°€ì— êµì‚¬ ë°ì´í„° ì´ˆê¸°í™”
            project.papers.forEach(p => { if (!p.teacherData[name]) p.teacherData[name] = { rounds: [[]], completedRounds: [] }; });
        }
        function removeTeacher(name) {
            if (!confirm(`'${name}' êµì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            project.teachers = project.teachers.filter(t => t !== name);
            project.papers.forEach(p => delete p.teacherData[name]);
            renderTeacherList();
        }
        function renderTeacherList() {
            document.getElementById('teacherCount').textContent = project.teachers.length + 'ëª…';
            document.getElementById('teacherList').innerHTML = project.teachers.map(t =>
                `<span style="background:#e0f2fe;padding:6px 12px;border-radius:20px;display:flex;align-items:center;gap:5px;">${t}<button onclick="removeTeacher('${t}')" style="background:none;border:none;cursor:pointer;color:#dc2626;">âœ•</button></span>`
            ).join('');
        }

        // === í‰ê°€êµ¬ì¡° ì„¤ì • ===
        function addPaper() { project.papers.push({ name: `${project.papers.length + 1}íšŒ ì •ê¸°ì‹œí—˜`, score: 100, ratio: 0, excelData: [], categories: [], teacherData: {}, currentRound: 0, scoreMode: 5 }); renderSetup(); }
        function addPerf() { project.perfs.push({ name: `ìˆ˜í–‰í‰ê°€${project.perfs.length + 1}`, score: 100, ratio: 0, cuts: [null, null, null, null, null] }); renderSetup(); }
        function removePaper(i) { if (project.papers.length <= 1) return alert('ìµœì†Œ 1ê°œ í•„ìš”'); project.papers.splice(i, 1); renderSetup(); }
        function removePerf(i) { if (project.perfs.length <= 1) return alert('ìµœì†Œ 1ê°œ í•„ìš”'); project.perfs.splice(i, 1); renderSetup(); }

        function renderSetup() {
            renderTeacherList();
            let pSum = 0, fSum = 0;
            document.getElementById('paperTbody').innerHTML = project.papers.map((p, i) => {
                pSum += p.ratio;
                return `<tr><td><input value="${p.name}" onchange="project.papers[${i}].name=this.value" style="width:150px"></td>
        <td><input type="number" value="${p.score}" onchange="project.papers[${i}].score=Number(this.value)" style="width:80px"></td>
        <td><input type="number" value="${p.ratio}" onchange="project.papers[${i}].ratio=Number(this.value);renderSetup()" style="width:80px"></td>
        <td><button class="btn btn-danger btn-sm" onclick="removePaper(${i})">ì‚­ì œ</button></td></tr>`;
            }).join('');
            document.getElementById('perfTbody').innerHTML = project.perfs.map((p, i) => {
                fSum += p.ratio;
                return `<tr><td><input value="${p.name}" onchange="project.perfs[${i}].name=this.value" style="width:150px"></td>
        <td><input type="number" value="${p.score}" onchange="project.perfs[${i}].score=Number(this.value)" style="width:80px"></td>
        <td><input type="number" value="${p.ratio}" onchange="project.perfs[${i}].ratio=Number(this.value);renderSetup()" style="width:80px"></td>
        <td><button class="btn btn-danger btn-sm" onclick="removePerf(${i})">ì‚­ì œ</button></td></tr>`;
            }).join('');
            const total = pSum + fSum;
            document.getElementById('paperRatioTotal').textContent = pSum + '%';
            document.getElementById('paperRatioTotal').className = pSum > 0 ? 'ratio-ok' : 'ratio-warn';
            document.getElementById('perfRatioTotal').textContent = fSum + '%';
            document.getElementById('perfRatioTotal').className = fSum > 0 ? 'ratio-ok' : 'ratio-warn';
            document.getElementById('totalRatio').textContent = total + '%';
        }

        // === ì •ê¸°ì‹œí—˜ íƒ­ ===
        function renderPaperTab() {
            document.getElementById('paperSubTabs').innerHTML = project.papers.map((p, i) =>
                `<div class="sub-tab ${i === currentPaperIdx ? 'active' : ''} ${p.excelData.length > 0 ? 'completed' : ''}" onclick="currentPaperIdx=${i};renderPaperTab()">${p.name}</div>`
            ).join('');
            renderPaperContent();
        }

        function renderPaperContent() {
            const paper = project.papers[currentPaperIdx];
            const fileName = paper.fileName || 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
            let html = `<div class="section-box"><div class="section-title">ğŸ“ ë¬¸í•­ì •ë³´í‘œ ì—…ë¡œë“œ</div>
        <input type="file" id="fileInput_${currentPaperIdx}" accept=".xlsx,.xls" onchange="handleExcelUpload(event,${currentPaperIdx})" style="display:none">
        <div style="display:flex;align-items:center;gap:10px;">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput_${currentPaperIdx}').click()">íŒŒì¼ ì„ íƒ</button>
            <span id="fileName_${currentPaperIdx}" style="color:#64748b;">${fileName}</span>
        </div>
        <p style="font-size:0.85rem;color:#64748b;margin-top:5px;">* ë‚˜ì´ìŠ¤ ì–‘ì‹ì˜ ë¬¸í•­ì •ë³´í‘œ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p></div>`;

            if (paper.excelData.length > 0) {
                // ë¬¸í•­ì •ë³´í‘œ ìƒì„¸ í…Œì´ë¸”
                const selCount = paper.excelData.filter(d => d.type === 'ì„ íƒí˜•').length;
                const subCount = paper.excelData.filter(d => d.type === 'ì„œë‹µí˜•').length;
                const totalScore = paper.excelData.reduce((s, d) => s + d.score, 0);

                html += `<div class="section-box" style="background:#f8fafc;">
                    <div class="section-title" style="border-color:#22c55e;">âœ… ë¬¸í•­ì •ë³´í‘œ ë°ì´í„°</div>
                    <div style="margin-bottom:10px;padding:10px;background:#f0fdf4;border-radius:6px;border:1px solid #bbf7d0;">
                        <span style="font-size:1.1rem;font-weight:bold;color:#15803d;">ì´ ${paper.excelData.length}ë¬¸í•­ ë¡œë“œ ì™„ë£Œ</span>
                        <span style="font-size:0.9rem;color:#334155;margin-left:10px;">(ì„ íƒí˜•: <b>${selCount}</b> / ì„œë‹µí˜•: <b>${subCount}</b> / ì´ë°°ì : <b>${totalScore.toFixed(1)}</b>ì )</span>
                    </div>
                    <div style="font-size:0.85rem;color:#64748b;margin-bottom:5px;">ì „ì²´ ë¬¸í•­ ë¦¬ìŠ¤íŠ¸ (ìŠ¤í¬ë¡¤í•˜ì—¬ í™•ì¸):</div>
                    <div style="max-height:250px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;">
                        <table style="font-size:0.85rem;background:white;">
                            <thead style="position:sticky;top:0;background:#f1f5f9;z-index:1;">
                                <tr><th style="padding:8px;border-bottom:2px solid #cbd5e1;width:50px;">ë²ˆí˜¸</th>
                                <th style="padding:8px;border-bottom:2px solid #cbd5e1;">ë¬¸í•­ìœ í˜•</th>
                                <th style="padding:8px;border-bottom:2px solid #cbd5e1;">ë‚œì´ë„</th>
                                <th style="padding:8px;border-bottom:2px solid #cbd5e1;">ë°°ì </th></tr>
                            </thead>
                            <tbody>
                                ${paper.excelData.map((item, idx) => `
                                    <tr style="border-bottom:1px solid #f1f5f9;background:${item.type === 'ì„œë‹µí˜•' ? '#fff7ed' : 'white'};">
                                        <td style="padding:6px;text-align:center;color:#64748b;">${idx + 1}</td>
                                        <td style="padding:6px;text-align:center;font-weight:${item.type === 'ì„œë‹µí˜•' ? 'bold' : 'normal'};color:${item.type === 'ì„œë‹µí˜•' ? '#d97706' : 'inherit'}">${item.type}</td>
                                        <td style="padding:6px;text-align:center;">${item.difficulty}</td>
                                        <td style="padding:6px;text-align:center;">${item.score}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;

                html += `<div class="section-box"><div class="section-title">ğŸ‘¥ êµì‚¬ ì„ íƒ</div>
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
                <select id="currentTeacher" onchange="loadTeacherInput()" style="min-width:150px;"><option value="">êµì‚¬ ì„ íƒ</option>${project.teachers.map(t => `<option value="${t}">${t}</option>`).join('')}</select>
                <span id="currentTeacherLabel" style="color:var(--primary);font-weight:bold;"></span>
            </div></div>`;

                html += `<div class="section-box"><div class="section-title">ğŸ“ ìµœì†ŒëŠ¥ë ¥ì ì˜ˆìƒì •ë‹µë¥  ì…ë ¥</div>
            <div style="display:flex;gap:15px;align-items:center;margin-bottom:15px;flex-wrap:wrap;">
                <div style="display:flex;gap:15px;align-items:center;background:#f1f5f9;padding:8px 15px;border-radius:8px;">
                    <span style="font-weight:bold;color:#334155;">ì„±ì·¨ìˆ˜ì¤€:</span>
                    <label style="cursor:pointer;"><input type="radio" name="scoreMode" value="5" ${paper.scoreMode === 5 ? 'checked' : ''} onchange="changeScoreMode(5)"> 5ìˆ˜ì¤€(A-E)+ë¯¸ì´ìˆ˜(I)</label>
                    <label style="cursor:pointer;"><input type="radio" name="scoreMode" value="4" ${paper.scoreMode === 4 ? 'checked' : ''} onchange="changeScoreMode(4)"> 5ìˆ˜ì¤€(A-E)</label>
                </div>
            </div>
            <div id="roundTabsContainer"></div>
            <div id="inputTableContainer"></div>
            <div id="inputButtons" style="display:none;text-align:right;margin-top:15px;">
                <button class="btn btn-primary" onclick="exportTeacherInputToExcel()" style="float:left;">ğŸ“¥ ì…ë ¥ê°’ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-dark" onclick="saveTeacherData()">ğŸ’¾ ì„ì‹œ ì €ì¥</button>
                <button class="btn btn-success" onclick="finalizeRound()">âœ… ì…ë ¥ë§ˆê°</button>
                <button class="btn btn-danger" onclick="openCancelModal()">ğŸ”“ ì…ë ¥ë§ˆê° ì·¨ì†Œ</button>
            </div></div>`;
                html += `<div class="section-box"><div class="section-title">ğŸ“‹ ì¡°íšŒ</div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:15px;">
                <label style="font-weight:bold;">ë¼ìš´ë“œ ì„ íƒ:</label>
                <select id="viewRoundSelect" onchange="refreshViewByRound()" style="min-width:120px;">
                    ${(() => {
                        let opts = '';
                        const maxRounds = Math.max(...project.teachers.map(t => paper.teacherData[t]?.rounds?.length || 0));
                        for (let r = 0; r < maxRounds; r++) {
                            opts += `<option value="${r}" ${r === paper.currentRound ? 'selected' : ''}>${r + 1}ë¼ìš´ë“œ</option>`;
                        }
                        return opts || '<option value="0">1ë¼ìš´ë“œ</option>';
                    })()}
                </select>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="showTeacherView()">êµì‚¬ë³„ì…ë ¥ì •ë³´ì¡°íšŒ</button>
                <button class="btn btn-primary" onclick="showCategoryView()">ë¬¸í•­ë²”ì£¼ë³„ì¡°íšŒ</button>
                <button class="btn btn-primary" onclick="showFinalView()">ì˜ˆìƒì¶”ì •ë¶„í• ì ìˆ˜ì¡°íšŒ</button>
                <button class="btn btn-success" style="font-weight:bold;" onclick="openResultModal()">ğŸ“Š ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œê²°ê³¼</button>
            </div>

            <div id="viewContainer" style="margin-top:15px;"></div></div>`;
            }
            document.getElementById('paperContent').innerHTML = html;
        }

        // === ì—‘ì…€ íŒŒì‹± ===
        function handleExcelUpload(event, paperIdx) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const ws = workbook.Sheets[workbook.SheetNames[0]];
                const raw = XLSX.utils.sheet_to_json(ws, { header: 1 });

                let headerRow = -1, scoreIdx = -1;
                for (let i = 0; i < Math.min(raw.length, 30); i++) {
                    const row = raw[i];
                    if (!row) continue;
                    const str = row.map(c => String(c).replace(/\s/g, '')).join(' ');
                    if (str.includes('ë°°ì ') && str.includes('ë¬¸í•­ë²ˆí˜¸')) {
                        headerRow = i;
                        scoreIdx = row.findIndex(c => String(c).trim() === 'ë°°ì ');
                        break;
                    }
                }
                if (headerRow < 0) { alert('ì–‘ì‹ ì¸ì‹ ì‹¤íŒ¨'); return; }

                let hardIdx = -1, midIdx = -1, easyIdx = -1;
                for (let r = headerRow; r <= headerRow + 1; r++) {
                    const row = raw[r]; if (!row) continue;
                    row.forEach((c, idx) => {
                        const v = String(c).trim().replace(/\s/g, '');
                        if (v === 'ì–´ë ¤ì›€') hardIdx = idx;
                        else if (v === 'ë³´í†µ') midIdx = idx;
                        else if (v === 'ì‰¬ì›€') easyIdx = idx;
                    });
                }
                if (hardIdx < 0) { alert('ë‚œì´ë„ ì—´ ì°¾ê¸° ì‹¤íŒ¨'); return; }

                const excelData = [];
                let currentType = '';
                for (let i = headerRow + 2; i < raw.length; i++) {
                    const row = raw[i]; if (!row) continue;
                    const txt = row.map(c => String(c)).join('');
                    if (txt.includes('ì„ íƒí˜•')) { currentType = 'ì„ íƒí˜•'; continue; }
                    if (txt.includes('ì„œë‹µí˜•')) { currentType = 'ì„œë‹µí˜•'; continue; }
                    const sc = row[scoreIdx];
                    if (sc === undefined || sc === '' || isNaN(sc)) continue;
                    let diff = '';
                    if (String(row[hardIdx] || '').includes('O') || String(row[hardIdx] || '').includes('â—‹')) diff = 'ì–´ë ¤ì›€';
                    else if (String(row[midIdx] || '').includes('O') || String(row[midIdx] || '').includes('â—‹')) diff = 'ë³´í†µ';
                    else if (String(row[easyIdx] || '').includes('O') || String(row[easyIdx] || '').includes('â—‹')) diff = 'ì‰¬ì›€';
                    else continue;
                    excelData.push({ type: currentType || 'ì„ íƒí˜•', difficulty: diff, score: parseFloat(sc) });
                }
                if (excelData.length === 0) { alert('ë¬¸í•­ ì¸ì‹ ì‹¤íŒ¨'); return; }

                project.papers[paperIdx].excelData = excelData;
                project.papers[paperIdx].fileName = file.name;
                processCategories(paperIdx);
                project.teachers.forEach(t => {
                    if (!project.papers[paperIdx].teacherData[t]) {
                        project.papers[paperIdx].teacherData[t] = { rounds: [[]], completedRounds: [] };
                    }
                });
                renderPaperTab();
            };
            reader.readAsArrayBuffer(file);
        }

        function processCategories(paperIdx) {
            const paper = project.papers[paperIdx];
            const catMap = new Map();
            paper.excelData.forEach(item => {
                const key = `${item.type}|${item.difficulty}`;
                if (!catMap.has(key)) catMap.set(key, { type: item.type, difficulty: item.difficulty, count: 0, totalScore: 0 });
                const cat = catMap.get(key);
                cat.count++; cat.totalScore += item.score;
            });
            const cats = Array.from(catMap.values());
            const order = { 'ì‰¬ì›€': 1, 'ë³´í†µ': 2, 'ì–´ë ¤ì›€': 3 };
            cats.sort((a, b) => { if (a.type !== b.type) return a.type === 'ì„ íƒí˜•' ? -1 : 1; return (order[a.difficulty] || 9) - (order[b.difficulty] || 9); });
            paper.categories = cats;
        }

        // === êµì‚¬ ì…ë ¥ ===
        function loadTeacherInput() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) { document.getElementById('roundTabsContainer').innerHTML = ''; document.getElementById('inputTableContainer').innerHTML = ''; document.getElementById('inputButtons').style.display = 'none'; return; }
            document.getElementById('currentTeacherLabel').textContent = `- ${name} ì„ ìƒë‹˜`;
            document.getElementById('inputButtons').style.display = 'block';
            renderRoundTabs();
            renderInputTable();
        }

        function renderRoundTabs() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) return;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            if (!td) return;
            let html = '';
            for (let i = 0; i < td.rounds.length; i++) {
                const done = td.completedRounds.includes(i);
                const isActive = i === paper.currentRound;
                html += `<button class="round-tab ${isActive ? 'active' : ''}" onclick="switchRound(${i})">${i + 1}ë¼ìš´ë“œ${done ? ' âœ“' : ''}</button>`;
            }
            html += `<button class="round-tab add-btn" onclick="addRound()">+ ì¶”ê°€</button>`;
            if (td.rounds.length > 1) {
                html += `<button class="round-tab" style="background:#fee2e2;color:#dc2626;border-color:#fca5a5;margin-left:auto;" onclick="deleteRound()">ğŸ—‘ï¸ ì‚­ì œ</button>`;
            }
            document.getElementById('roundTabsContainer').innerHTML = `<div class="round-tabs" style="display:flex;gap:8px;flex-wrap:wrap;">${html}</div>`;
        }

        function switchRound(idx) { project.papers[currentPaperIdx].currentRound = idx; renderRoundTabs(); renderInputTable(); }
        function addRound() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) { alert('êµì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];

            // ëª¨ë“  êµì‚¬ì—ê²Œ ìƒˆ ë¼ìš´ë“œ ì¶”ê°€ (í˜„ì¬ êµì‚¬ë§Œ ì¶”ê°€í•˜ë©´ ë™ê¸°í™” ë¬¸ì œ ë°œìƒ)
            const useCopy = confirm('ì´ì „ ë¼ìš´ë“œ ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì—¬ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n[í™•ì¸]: ë³µì‚¬í•¨ / [ì·¨ì†Œ]: ë¹ˆ ê°’ìœ¼ë¡œ ì‹œì‘');

            project.teachers.forEach(t => {
                const teacherData = paper.teacherData[t];
                if (!teacherData) return;

                let newRoundData;
                if (useCopy && teacherData.rounds.length > 0) {
                    // ì´ì „ ë¼ìš´ë“œ ë°ì´í„° ë³µì‚¬
                    const prevRound = teacherData.rounds[teacherData.rounds.length - 1];
                    newRoundData = JSON.parse(JSON.stringify(prevRound));
                } else {
                    // ë¹ˆ ê°’ìœ¼ë¡œ ì‹œì‘
                    newRoundData = paper.categories.map(() => Array(5).fill(null));
                }
                teacherData.rounds.push(newRoundData);
            });

            paper.currentRound = td.rounds.length - 1;
            renderRoundTabs(); renderInputTable();
            renderViewRoundSelect();
        }

        function deleteRound() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) return;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];

            if (td.rounds.length <= 1) {
                alert('ìµœì†Œ 1ê°œì˜ ë¼ìš´ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const roundToDelete = paper.currentRound;
            if (!confirm(`${roundToDelete + 1}ë¼ìš´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ ë¼ìš´ë“œì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

            // ëª¨ë“  êµì‚¬ì˜ í•´ë‹¹ ë¼ìš´ë“œ ì‚­ì œ
            project.teachers.forEach(t => {
                const teacherData = paper.teacherData[t];
                if (!teacherData) return;
                if (teacherData.rounds.length > roundToDelete) {
                    teacherData.rounds.splice(roundToDelete, 1);
                }
                // completedRounds ì—…ë°ì´íŠ¸
                const compIdx = teacherData.completedRounds.indexOf(roundToDelete);
                if (compIdx > -1) teacherData.completedRounds.splice(compIdx, 1);
                // ì¸ë±ìŠ¤ ì¡°ì •
                teacherData.completedRounds = teacherData.completedRounds.map(r => r > roundToDelete ? r - 1 : r);
            });

            // í˜„ì¬ ë¼ìš´ë“œ ì¡°ì •
            if (paper.currentRound >= td.rounds.length) {
                paper.currentRound = Math.max(0, td.rounds.length - 1);
            }

            alert('ë¼ìš´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            renderRoundTabs(); renderInputTable();
            renderViewRoundSelect();
        }

        function renderInputTable() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) return;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const round = paper.currentRound;
            const isCompleted = td.completedRounds.includes(round);
            const cats = paper.categories;
            const mode = paper.scoreMode || 5;
            const colCount = mode;

            if (!td.rounds[round]) td.rounds[round] = [];
            while (td.rounds[round].length < cats.length) td.rounds[round].push(Array(5).fill(null));

            // í—¤ë” ìƒì„± (4ë‹¨ê³„ vs 5ë‹¨ê³„)
            const headers4 = ['A/B(%)', 'B/C(%)', 'C/D(%)', 'D/E(%)'];
            const headers5 = ['A/B(%)', 'B/C(%)', 'C/D(%)', 'D/E(%)', 'E/ë¯¸ë„ë‹¬(%)'];
            const headers = mode === 5 ? headers5 : headers4;

            let html = `<table><thead><tr><th>ìœ í˜•</th><th>ë‚œì´ë„</th><th>ë¬¸í•­ìˆ˜</th><th>ë°°ì í•©</th>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
            cats.forEach((cat, ci) => {
                const vals = td.rounds[round][ci] || Array(5).fill(null);
                html += `<tr><td>${cat.type}</td><td>${cat.difficulty}</td><td>${cat.count}</td><td>${cat.totalScore.toFixed(1)}</td>`;
                for (let i = 0; i < colCount; i++) {
                    const v = vals[i] !== null ? vals[i] : '';
                    const dis = isCompleted ? 'disabled' : '';
                    // ë§ˆì§€ë§‰ ì»¬ëŸ¼(5ë‹¨ê³„ì˜ E/ë¯¸ë„ë‹¬)ë§Œ 1% ë‹¨ìœ„ ì…ë ¥, ë‚˜ë¨¸ì§€ëŠ” 5% ë‹¨ìœ„ select
                    if (mode === 5 && i === 4) {
                        html += `<td><input type="number" class="inp-rate" data-cat="${ci}" data-idx="${i}" value="${v}" min="20" max="100" step="1" style="width:60px" oninput="validateInputs()" ${dis}></td>`;
                    } else {
                        html += `<td><select class="inp-rate" data-cat="${ci}" data-idx="${i}" onchange="validateInputs()" ${dis}><option value="">ì„ íƒ</option>`;
                        for (let o = 0; o <= 100; o += 5) html += `<option value="${o}" ${v === o ? 'selected' : ''}>${o}</option>`;
                        html += `</select></td>`;
                    }
                }
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('inputTableContainer').innerHTML = html;
        }

        function changeScoreMode(mode) {
            project.papers[currentPaperIdx].scoreMode = mode;
            renderInputTable();
        }

        function validateInputs() {
            const inputs = document.querySelectorAll('.inp-rate');
            let valid = true;
            inputs.forEach(inp => { inp.classList.remove('invalid-input', 'warning-diff'); });

            const paper = project.papers[currentPaperIdx];
            const mode = paper.scoreMode || 5;
            const cats = paper.categories;

            // 1. Row check: ìƒìœ„ìˆ˜ì¤€ >= í•˜ìœ„ìˆ˜ì¤€ + 20% ì°¨ì´ ê²½ê³ 
            cats.forEach((cat, ci) => {
                for (let c = 0; c < mode - 1; c++) {
                    const left = document.querySelector(`.inp-rate[data-cat="${ci}"][data-idx="${c}"]`);
                    const right = document.querySelector(`.inp-rate[data-cat="${ci}"][data-idx="${c + 1}"]`);
                    if (left && right && left.value !== '' && right.value !== '') {
                        const leftVal = parseFloat(left.value);
                        const rightVal = parseFloat(right.value);
                        // ìƒìœ„ < í•˜ìœ„ì´ë©´ ì˜¤ë¥˜
                        if (leftVal < rightVal) {
                            left.classList.add('invalid-input');
                            right.classList.add('invalid-input');
                            valid = false;
                        }
                        // ì°¨ì´ê°€ 20% ì´ìƒì´ë©´ ê²½ê³  (ì°¨í•˜ìœ„ì— í‘œì‹œ)
                        if (leftVal - rightVal >= 20) {
                            right.classList.add('warning-diff');
                        }
                    }
                }
            });

            // 2. Column check: ë‚œì´ë„ë³„ (ì‰¬ì›€ >= ë³´í†µ >= ì–´ë ¤ì›€) - ê°™ì€ ìœ í˜• ë‚´
            const types = ['ì„ íƒí˜•', 'ì„œë‹µí˜•'];
            const diffOrder = ['ì‰¬ì›€', 'ë³´í†µ', 'ì–´ë ¤ì›€'];

            for (let c = 0; c < mode; c++) {
                types.forEach(type => {
                    // í•´ë‹¹ ìœ í˜•ì˜ ë‚œì´ë„ë³„ í–‰ ì¸ë±ìŠ¤ ì°¾ê¸°
                    const catIndices = {};
                    cats.forEach((cat, idx) => {
                        if (cat.type === type) catIndices[cat.difficulty] = idx;
                    });

                    // ì‰¬ì›€ >= ë³´í†µ, ë³´í†µ >= ì–´ë ¤ì›€ ë¹„êµ
                    const comparePairs = [['ì‰¬ì›€', 'ë³´í†µ'], ['ë³´í†µ', 'ì–´ë ¤ì›€'], ['ì‰¬ì›€', 'ì–´ë ¤ì›€']];
                    comparePairs.forEach(([easy, hard]) => {
                        if (catIndices[easy] !== undefined && catIndices[hard] !== undefined) {
                            const easyInp = document.querySelector(`.inp-rate[data-cat="${catIndices[easy]}"][data-idx="${c}"]`);
                            const hardInp = document.querySelector(`.inp-rate[data-cat="${catIndices[hard]}"][data-idx="${c}"]`);
                            if (easyInp && hardInp && easyInp.value !== '' && hardInp.value !== '') {
                                if (parseFloat(easyInp.value) < parseFloat(hardInp.value)) {
                                    easyInp.classList.add('invalid-input');
                                    hardInp.classList.add('invalid-input');
                                    valid = false;
                                }
                            }
                        }
                    });
                });
            }

            return valid;
        }

        function saveTeacherData() {
            if (!validateInputs()) { alert('ì…ë ¥ê°’ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.'); return; }
            const name = document.getElementById('currentTeacher').value;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const round = paper.currentRound;
            const inputs = document.querySelectorAll('.inp-rate');
            let complete = true;
            inputs.forEach(inp => {
                const ci = parseInt(inp.dataset.cat), vi = parseInt(inp.dataset.idx);
                const v = inp.value;
                td.rounds[round][ci][vi] = v === '' ? null : parseFloat(v);
                if (v === '') complete = false;
            });
            if (!complete) { alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function finalizeRound() {
            if (!validateInputs()) { alert('ì…ë ¥ê°’ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.'); return; }
            const name = document.getElementById('currentTeacher').value;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const round = paper.currentRound;
            if (td.completedRounds.includes(round)) { alert('ì´ë¯¸ ë§ˆê°ë¨'); return; }
            saveTeacherData();
            if (!confirm(`${name} ì„ ìƒë‹˜ì˜ ${round + 1}ë¼ìš´ë“œë¥¼ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            td.completedRounds.push(round);
            alert('ë§ˆê° ì™„ë£Œ');
            renderRoundTabs(); renderInputTable();
            renderViewRoundSelect();
        }

        function openCancelModal() { document.getElementById('cancelModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function confirmCancelFinalize() {
            const reason = document.querySelector('input[name="cancelReason"]:checked');
            if (!reason) { alert('ì‚¬ìœ  ì„ íƒ í•„ìš”'); return; }
            const name = document.getElementById('currentTeacher').value;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const round = paper.currentRound;
            const idx = td.completedRounds.indexOf(round);
            if (idx > -1) td.completedRounds.splice(idx, 1);
            alert('ë§ˆê° ì·¨ì†Œë¨');
            closeModal('cancelModal');
            renderRoundTabs(); renderInputTable();
            renderViewRoundSelect();
        }

        // === ì¡°íšŒ ê¸°ëŠ¥ ===
        function showTeacherView() {
            const paper = project.papers[currentPaperIdx];
            const cats = paper.categories;
            const mode = paper.scoreMode || 5;
            const headers = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E'] : ['A/B', 'B/C', 'C/D', 'D/E'];
            const viewRound = document.getElementById('viewRoundSelect')?.value ?? paper.currentRound;
            const roundIdx = parseInt(viewRound);

            let html = '<div class="info-box" style="background:#fef3c7;border-color:#fcd34d;color:#92400e;margin-bottom:15px;">âš ï¸ <strong>ì ìƒ‰ í‘œì‹œ</strong>: ë™ì¼ ë¬¸í•­ë²”ì£¼ ë‚´ êµì‚¬ê°„ ì •ë‹µë¥  ì°¨ì´ê°€ 20% ì´ìƒì¸ ê²½ìš°ì…ë‹ˆë‹¤.</div>';
            html += `<h4>ğŸ“‹ êµì‚¬ë³„ ì…ë ¥ì •ë³´ (${roundIdx + 1}ë¼ìš´ë“œ)</h4><table><thead><tr><th>ìœ í˜•</th><th>ë‚œì´ë„</th><th>êµì‚¬</th>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;

            cats.forEach((cat, ci) => {
                // ê° ì»¬ëŸ¼ë³„ ëª¨ë“  êµì‚¬ì˜ ê°’ ìˆ˜ì§‘
                const colValues = [];
                for (let c = 0; c < mode; c++) colValues.push([]);

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td || !td.rounds[roundIdx] || !td.rounds[roundIdx][ci]) return;
                    const vals = td.rounds[roundIdx][ci];
                    for (let c = 0; c < mode; c++) {
                        if (vals[c] !== null && vals[c] !== undefined) {
                            colValues[c].push(parseFloat(vals[c]));
                        }
                    }
                });

                // ìµœëŒ€-ìµœì†Œ ì°¨ì´ ê³„ì‚°í•˜ì—¬ 20 ì´ìƒì´ë©´ í”Œë˜ê·¸
                const diffFlags = colValues.map(arr => {
                    if (arr.length < 2) return false;
                    return (Math.max(...arr) - Math.min(...arr)) >= 20;
                });

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td) return;
                    const vals = td.rounds[roundIdx] && td.rounds[roundIdx][ci] ? td.rounds[roundIdx][ci] : Array(mode).fill('-');
                    html += `<tr><td>${cat.type}</td><td>${cat.difficulty}</td><td>${t}</td>`;
                    for (let c = 0; c < mode; c++) {
                        const v = vals[c] !== null && vals[c] !== undefined ? vals[c] : '-';
                        const cellClass = diffFlags[c] ? 'diff-alert' : '';
                        html += `<td class="${cellClass}">${v}</td>`;
                    }
                    html += '</tr>';
                });
            });
            html += '</tbody></table>';
            document.getElementById('viewContainer').innerHTML = html;
        }

        function showCategoryView() {
            const paper = project.papers[currentPaperIdx];
            const cats = paper.categories;
            const viewRound = document.getElementById('viewRoundSelect')?.value ?? paper.currentRound;
            const roundIdx = parseInt(viewRound);
            const mode = paper.scoreMode || 5;
            const levels = mode === 5 ? ['A', 'B', 'C', 'D', 'E'] : ['A', 'B', 'C', 'D'];

            let html = `<h4>ğŸ“Š ë¬¸í•­ ë²”ì£¼ë³„ ìƒì„¸ í†µê³„ (${roundIdx + 1}ë¼ìš´ë“œ)</h4>`;
            html += '<div style="overflow-x:auto;"><table><thead><tr><th rowspan="2">ë¬¸í•­ìœ í˜•</th><th rowspan="2">ë‚œì´ë„</th>';
            levels.forEach(lv => {
                html += `<th colspan="4" style="text-align:center;background:#e0f2fe;">${lv}</th>`;
            });
            html += '</tr><tr>';
            levels.forEach(() => {
                html += '<th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th><th>ìµœì†Ÿê°’</th><th>ìµœëŒ“ê°’</th>';
            });
            html += '</tr></thead><tbody>';

            cats.forEach((cat, ci) => {
                // ê° ë ˆë²¨ë³„ ë°ì´í„° ìˆ˜ì§‘
                const levelData = levels.map(() => []);

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td || !td.rounds[roundIdx] || !td.rounds[roundIdx][ci]) return;
                    const vals = td.rounds[roundIdx][ci];
                    for (let c = 0; c < levels.length; c++) {
                        if (vals[c] !== null && vals[c] !== undefined) {
                            levelData[c].push(parseFloat(vals[c]));
                        }
                    }
                });

                html += `<tr><td>${cat.type}</td><td>${cat.difficulty}</td>`;
                levelData.forEach(arr => {
                    if (arr.length === 0) {
                        html += '<td>-</td><td>-</td><td>-</td><td>-</td>';
                    } else {
                        const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
                        const std = Math.sqrt(arr.reduce((a, b) => a + (b - avg) ** 2, 0) / arr.length);
                        const min = Math.min(...arr);
                        const max = Math.max(...arr);
                        html += `<td>${avg.toFixed(2)}</td><td>${std.toFixed(2)}</td><td>${min.toFixed(0)}</td><td>${max.toFixed(0)}</td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            document.getElementById('viewContainer').innerHTML = html;
        }

        function showFinalView() {
            const paper = project.papers[currentPaperIdx];
            const cats = paper.categories;
            const viewRound = document.getElementById('viewRoundSelect')?.value ?? paper.currentRound;
            const roundIdx = parseInt(viewRound);
            const mode = paper.scoreMode || 5;
            const headers = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E/ë¯¸ë„ë‹¬'] : ['A/B', 'B/C', 'C/D', 'D/E'];

            // ê° êµì‚¬ë³„ë¡œ ì „ì²´ ì ìˆ˜ ê³„ì‚°
            const teacherScores = headers.map(() => []);

            project.teachers.forEach(t => {
                const td = paper.teacherData[t];
                if (!td || !td.rounds[roundIdx]) return;

                // í•´ë‹¹ ëª¨ë“œ(4/5)ì— í•„ìš”í•œ ì»¬ëŸ¼ë“¤ì´ ëª¨ë‘ ì±„ì›Œì¡ŒëŠ”ì§€ í™•ì¸
                const isComplete = td.rounds[roundIdx].length >= cats.length && td.rounds[roundIdx].every(row => {
                    if (!row) return false;
                    for (let n = 0; n < headers.length; n++) {
                        if (row[n] === null || row[n] === undefined || row[n] === '') return false;
                    }
                    return true;
                });

                if (!isComplete) return;

                const scores = headers.map(() => 0);
                cats.forEach((cat, ci) => {
                    const vals = td.rounds[roundIdx][ci];
                    for (let vi = 0; vi < headers.length; vi++) {
                        scores[vi] += cat.totalScore * (parseFloat(vals[vi]) / 100);
                    }
                });
                scores.forEach((s, i) => teacherScores[i].push(s));
            });

            let html = `<h4>ğŸ† ìµœì¢… ì˜ˆìƒ ì¶”ì •ë¶„í• ì ìˆ˜ (${roundIdx + 1}ë¼ìš´ë“œ)</h4>`;
            html += '<table><thead><tr><th>êµ¬ë¶„</th>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';

            // í‰ê· 
            html += '<tr><td style="font-weight:bold;">í‰ê· </td>';
            teacherScores.forEach(arr => {
                const avg = arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
                html += `<td style="font-weight:bold;color:#1e40af;">${avg.toFixed(2)}</td>`;
            });
            html += '</tr>';

            // í‘œì¤€í¸ì°¨
            html += '<tr><td style="font-weight:bold;">í‘œì¤€í¸ì°¨</td>';
            teacherScores.forEach(arr => {
                if (arr.length === 0) { html += '<td>-</td>'; return; }
                const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
                const std = Math.sqrt(arr.reduce((a, b) => a + (b - avg) ** 2, 0) / arr.length);
                html += `<td>${std.toFixed(2)}</td>`;
            });
            html += '</tr>';

            // ìµœì†Ÿê°’
            html += '<tr><td style="font-weight:bold;">ìµœì†Ÿê°’</td>';
            teacherScores.forEach(arr => {
                html += `<td>${arr.length > 0 ? Math.min(...arr).toFixed(2) : '-'}</td>`;
            });
            html += '</tr>';

            // ìµœëŒ“ê°’
            html += '<tr><td style="font-weight:bold;">ìµœëŒ“ê°’</td>';
            teacherScores.forEach(arr => {
                html += `<td>${arr.length > 0 ? Math.max(...arr).toFixed(2) : '-'}</td>`;
            });
            html += '</tr>';

            html += '</tbody></table>';
            document.getElementById('viewContainer').innerHTML = html;
        }

        // === ë¼ìš´ë“œë³„ ì¡°íšŒ ê¸°ëŠ¥ ===
        function refreshViewByRound() {
            const select = document.getElementById('viewRoundSelect');
            if (!select) return;
            project.papers[currentPaperIdx].currentRound = parseInt(select.value);
            // í˜„ì¬ ë³´ì´ëŠ” ë·°ê°€ ìˆìœ¼ë©´ ê°±ì‹ 
            const vc = document.getElementById('viewContainer');
            if (vc && vc.innerHTML.includes('êµì‚¬ë³„')) showTeacherView();
            else if (vc && vc.innerHTML.includes('ì˜ˆìƒ')) showFinalView();
        }

        function getViewRound() {
            const select = document.getElementById('viewRoundSelect');
            return select ? parseInt(select.value) : project.papers[currentPaperIdx].currentRound;
        }

        // === ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œê²°ê³¼ ëª¨ë‹¬ ===
        function calculateRoundResult(roundIdx) {
            const paper = project.papers[currentPaperIdx];
            const cats = paper.categories;
            const mode = paper.scoreMode || 5;
            const cols = mode === 5 ? 5 : 4;
            const sums = Array(cols).fill(0);
            let cnt = 0;

            project.teachers.forEach(t => {
                const td = paper.teacherData[t];
                if (!td || !td.rounds[roundIdx]) return;

                const isComplete = td.rounds[roundIdx].length >= cats.length && td.rounds[roundIdx].every(row => {
                    if (!row) return false;
                    for (let n = 0; n < cols; n++) {
                        if (row[n] === null || row[n] === undefined || row[n] === '') return false;
                    }
                    return true;
                });

                if (isComplete) {
                    cats.forEach((cat, ci) => {
                        const vals = td.rounds[roundIdx][ci];
                        for (let vi = 0; vi < cols; vi++) {
                            sums[vi] += cat.totalScore * (parseFloat(vals[vi]) / 100);
                        }
                    });
                    cnt++;
                }
            });
            return { avgs: sums.map(s => cnt > 0 ? (s / cnt) : 0), cnt };
        }

        function openResultModal() {
            const paper = project.papers[currentPaperIdx];
            const maxRounds = Math.max(...project.teachers.map(t => paper.teacherData[t]?.rounds?.length || 0));

            if (maxRounds === 0) {
                alert('ì…ë ¥ëœ ë¼ìš´ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let html = '<div style="overflow-x:auto;">';
            html += '<table><thead><tr><th>ë¼ìš´ë“œ</th><th>ì°¸ì—¬êµì‚¬</th><th>A/B</th><th>B/C</th><th>C/D</th><th>D/E</th><th>E/ë¯¸ë„ë‹¬</th><th>ì„ íƒ</th></tr></thead><tbody>';

            for (let r = 0; r < maxRounds; r++) {
                const result = calculateRoundResult(r);
                const isSelected = paper.selectedResultRound === r;
                html += `<tr style="${isSelected ? 'background:#dbeafe;' : ''}">
                    <td style="font-weight:bold;">${r + 1}ë¼ìš´ë“œ</td>
                    <td>${result.cnt}ëª…</td>
                    ${result.avgs.map(a => `<td style="font-weight:bold;color:#1e40af;">${a.toFixed(2)}</td>`).join('')}
                    <td><button class="btn ${isSelected ? 'btn-success' : 'btn-dark'}" onclick="selectResultRound(${r})">${isSelected ? 'âœ“ ì„ íƒë¨' : 'ì„ íƒ'}</button></td>
                </tr>`;
            }
            html += '</tbody></table></div>';

            // ì„ íƒëœ ë¼ìš´ë“œ ì •ë³´
            if (paper.selectedResultRound !== undefined) {
                const selResult = calculateRoundResult(paper.selectedResultRound);
                html += `<div class="info-box" style="margin-top:15px;background:#dcfce7;border-color:#86efac;">
                    âœ… <strong>${paper.selectedResultRound + 1}ë¼ìš´ë“œ</strong>ê°€ ìµœì¢… ê²°ê³¼ë¡œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.
                </div>`;
            }

            document.getElementById('resultModalContent').innerHTML = html;
            document.getElementById('resultModal').style.display = 'flex';
        }

        function selectResultRound(roundIdx) {
            project.papers[currentPaperIdx].selectedResultRound = roundIdx;
            openResultModal(); // ëª¨ë‹¬ ê°±ì‹ 
        }

        function exportRoundResultsToExcel() {
            const paper = project.papers[currentPaperIdx];
            const maxRounds = Math.max(...project.teachers.map(t => paper.teacherData[t]?.rounds?.length || 0));

            const data = [['ë¼ìš´ë“œ', 'ì°¸ì—¬êµì‚¬', 'A/B', 'B/C', 'C/D', 'D/E', 'E/ë¯¸ë„ë‹¬']];
            for (let r = 0; r < maxRounds; r++) {
                const result = calculateRoundResult(r);
                data.push([`${r + 1}ë¼ìš´ë“œ`, `${result.cnt}ëª…`, ...result.avgs.map(a => a.toFixed(2))]);
            }

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ì¶”ì •ë¶„í• ì ìˆ˜');

            const now = new Date();
            const filename = `ì¶”ì •ë¶„í• ì ìˆ˜_${paper.name}_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function openApprovalFromResult() {
            const paper = project.papers[currentPaperIdx];
            if (paper.selectedResultRound === undefined) {
                alert('ë¨¼ì € ìŠ¹ì¸ìš”ì²­í•  ë¼ìš´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            closeModal('resultModal');
            // ìŠ¹ì¸ìš”ì²­ ëª¨ë‹¬ ì—´ê¸°
            const select = document.getElementById('approvalRoundSelect');
            select.innerHTML = `<option value="${paper.selectedResultRound}">${paper.selectedResultRound + 1}ë¼ìš´ë“œ (ì„ íƒë¨)</option>`;
            document.getElementById('approvalModal').style.display = 'flex';
        }

        // === ì—‘ì…€ ì¶œë ¥ ê°œì„ : ëª¨ë“  ë¼ìš´ë“œ ì¶œë ¥ ===
        function exportTeacherInputToExcel() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) return;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const mode = paper.scoreMode || 5;
            const headers = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E/ë¯¸ë„ë‹¬'] : ['A/B', 'B/C', 'C/D', 'D/E'];

            const wb = XLSX.utils.book_new();
            td.rounds.forEach((roundData, rIdx) => {
                const data = [['ìœ í˜•', 'ë‚œì´ë„', ...headers]];
                paper.categories.forEach((cat, ci) => {
                    const vals = roundData[ci] || Array(mode).fill('');
                    data.push([cat.type, cat.difficulty, ...vals]);
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, `${rIdx + 1}ë¼ìš´ë“œ`);
            });
            XLSX.writeFile(wb, `ì…ë ¥ê°’_${name}_${paper.name}.xlsx`);
        }

        // === ìˆ˜í–‰í‰ê°€ íƒ­ ===
        // === ìˆ˜í–‰í‰ê°€ íƒ­ ===
        function renderPerfTab() {
            const paper = project.papers[currentPaperIdx] || project.papers[0];
            const mode = paper.scoreMode || 5;
            // % ì œê±° ë° ë‹¨ìˆœ ëª…ì¹­ ì‚¬ìš©
            const headerLabels = mode === 5 ? ['A', 'B', 'C', 'D', 'E'] : ['A', 'B', 'C', 'D'];
            const indices = mode === 5 ? [0, 1, 2, 3, 4] : [0, 1, 2, 3];

            let html = `
            <div style="margin-bottom:15px; display:flex; gap:20px; align-items:center;">
                <label style="cursor:pointer; font-weight:bold;">
                    <input type="radio" name="perfInputMode" value="all" ${(!project.perfInputMode || project.perfInputMode === 'all') ? 'checked' : ''} onchange="changePerfMode('all')"> ì „ì²´ì˜ì—­
                </label>
                <label style="cursor:pointer; font-weight:bold;">
                    <input type="radio" name="perfInputMode" value="each" ${(project.perfInputMode === 'each') ? 'checked' : ''} onchange="changePerfMode('each')"> ì˜ì—­ë³„
                </label>
            </div>`;

            html += `<table>
                <thead id="perfCutsThead">
                    <tr><th>ì˜ì—­ëª…</th><th>ë°°ì </th>${headerLabels.map(h => `<th>${h}</th>`).join('')}</tr>
                </thead>
                <tbody id="perfCutsTbody">`;

            if (!project.perfInputMode || project.perfInputMode === 'all') {
                // ì „ì²´ì˜ì—­ ëª¨ë“œ: 1ì¤„ë§Œ í‘œì‹œ, ì˜ì—­ëª…ì€ 'ì „ì²´ ì˜ì—­', ë°°ì ì€ ì „ì²´ ë°°ì  í•©ê³„
                const totalScore = project.perfs.reduce((s, p) => s + p.score, 0);
                // project.perfTotalCuts ì´ˆê¸°í™” í™•ì¸
                if (!project.perfTotalCuts) project.perfTotalCuts = Array(5).fill(null);

                html += `<tr>
                    <td>ì „ì²´ ì˜ì—­</td>
                    <td>${totalScore}</td>
                    ${indices.map(j => {
                    const val = project.perfTotalCuts[j];
                    return `<td><input type="number" value="${val === null ? '' : val}" style="width:80px" onchange="updatePerfTotalCut(${j}, this.value)"></td>`;
                }).join('')}
                </tr>`;
            } else {
                // ì˜ì—­ë³„ ëª¨ë“œ: ê° ìˆ˜í–‰í‰ê°€ë³„ë¡œ í‘œì‹œ
                html += project.perfs.map((p, i) =>
                    `<tr>
                        <td>${p.name}</td>
                        <td>${p.score}</td>
                        ${indices.map(j => {
                        const val = p.cuts[j];
                        return `<td><input type="number" value="${val === null ? '' : val}" style="width:60px" onchange="updatePerfCut(${i}, ${j}, this.value)"></td>`;
                    }).join('')}
                    </tr>`
                ).join('');
            }
            html += `</tbody></table>`;

            // ê¸°ì¡´ í…Œì´ë¸” ë®ì–´ì“°ê¸° ìœ„í•´ section-box ë‚´ë¶€ êµ¬ì¡° ë³€ê²½ì´ í•„ìš”í•˜ì§€ë§Œ, 
            // ì—¬ê¸°ì„œëŠ” ê¸°ì¡´ table íƒœê·¸ë¥¼ í¬í•¨í•˜ì—¬ ë‹¤ì‹œ ê·¸ë¦¼.
            // ê¸°ì¡´ HTML êµ¬ì¡°ìƒ tableì´ ì´ë¯¸ ìˆìœ¼ë¯€ë¡œ, wrapper divë¥¼ ì¡°ì‘í•˜ê±°ë‚˜ table innerHTMLë§Œ ë°”ê¾¸ëŠ” ê²ƒë³´ë‹¤
            // section-box ë‚´ìš©ì„ ì „ì²´ ì¬êµ¬ì„±í•˜ëŠ” ê²ƒì´ ê¹”ë”í•¨.
            // ì´ë¥¼ ìœ„í•´ renderPerfTabì—ì„œëŠ” section-boxì˜ ë‚´ìš©ì„ ì§ì ‘ ìˆ˜ì •í•˜ë„ë¡ ë³€ê²½ í•„ìš”.
            // í•˜ì§€ë§Œ í˜„ì¬ êµ¬ì¡°ìƒ innerHTML ì¡°ì‘ì´ ë³µì¡í•˜ë¯€ë¡œ, 
            // ê¸°ì¡´ id="perfCutsThead", id="perfCutsTbody"ë¥¼ ì‚¬ìš©í•˜ëŠ” ëŒ€ì‹ 
            // ìƒìœ„ ì»¨í…Œì´ë„ˆë¥¼ íƒ€ê²ŸíŒ…í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ. HTML êµ¬ì¡°ìƒ "ğŸ“ ìˆ˜í–‰í‰ê°€ ë“±ê¸‰ë³„ ì ìˆ˜ ì…ë ¥" ì„¹ì…˜ ë°•ìŠ¤ ë‚´ë¶€ë¥¼ ê°±ì‹ í•´ì•¼í•¨.
            // í¸ì˜ìƒ section-title ë‹¤ìŒ ìš”ì†Œë“¤ì„ ê°±ì‹ í•˜ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ì ‘ê·¼.

            const container = document.querySelector('#tab-2 .section-box table').parentNode; // tableì˜ ë¶€ëª¨ div ì°¾ì•„ì•¼ í•¨
            // ìœ„ ë°©ë²•ì´ ë¶ˆí™•ì‹¤í•˜ë¯€ë¡œ, perfCutsTheadê°€ ìˆëŠ” tableì„ ì°¾ì•„ êµì²´í•˜ëŠ” ë°©ì‹ ì‚¬ìš©.
            const oldTable = document.getElementById('perfCutsThead').parentNode;
            const parentDiv = oldTable.parentNode;

            // ëª¨ë“œ ì„ íƒ ë¼ë””ì˜¤ ë²„íŠ¼ì´ ë“¤ì–´ê°ˆ ê³µê°„ í™•ë³´ë¥¼ ìœ„í•´ parentDivì˜ ì²«ë²ˆì§¸ ìì‹(title) ë’¤ì— div ì‚½ì…, 
            // tableì€ ê·¸ ë’¤ì—.

            // ë” ê°„ë‹¨í•˜ê²Œ: HTML ë¬¸ìì—´ì„ ì™„ì „íˆ ìƒˆë¡œ êµ¬ì„±í•´ì„œ parentDiv.innerHTMLì— ë„£ìŒ (title í¬í•¨)
            parentDiv.innerHTML = `
                <div class="section-title">ğŸ“ ìˆ˜í–‰í‰ê°€ ë“±ê¸‰ë³„ ì ìˆ˜ ì…ë ¥</div>
                <div style="margin-bottom:15px; display:flex; gap:20px; align-items:center;">
                    <label style="cursor:pointer; font-weight:bold;">
                        <input type="radio" name="perfInputMode" value="all" ${(!project.perfInputMode || project.perfInputMode === 'all') ? 'checked' : ''} onchange="changePerfMode('all')"> ì „ì²´ì˜ì—­
                    </label>
                    <label style="cursor:pointer; font-weight:bold;">
                        <input type="radio" name="perfInputMode" value="each" ${(project.perfInputMode === 'each') ? 'checked' : ''} onchange="changePerfMode('each')"> ì˜ì—­ë³„
                    </label>
                </div>
                <table>
                    <thead id="perfCutsThead">
                        <tr><th>ì˜ì—­ëª…</th><th>ë°°ì </th>${headerLabels.map(h => `<th>${h}</th>`).join('')}</tr>
                    </thead>
                    <tbody id="perfCutsTbody">
                        ${(!project.perfInputMode || project.perfInputMode === 'all') ?
                    `<tr>
                                <td>ì „ì²´ ì˜ì—­</td>
                                <td>${project.perfs.reduce((s, p) => s + p.score, 0)}</td>
                                ${indices.map(j => {
                        const val = (project.perfTotalCuts && project.perfTotalCuts[j] !== undefined) ? project.perfTotalCuts[j] : null;
                        return `<td><input type="number" value="${val === null ? '' : val}" style="width:80px" onchange="updatePerfTotalCut(${j}, this.value)"></td>`;
                    }).join('')}
                            </tr>`
                    :
                    project.perfs.map((p, i) =>
                        `<tr>
                                    <td>${p.name}</td>
                                    <td>${p.score}</td>
                                    ${indices.map(j => {
                            const val = p.cuts[j];
                            return `<td><input type="number" value="${val === null ? '' : val}" style="width:60px" onchange="updatePerfCut(${i}, ${j}, this.value)"></td>`;
                        }).join('')}
                                </tr>`
                    ).join('')
                }
                    </tbody>
                </table>
            `;

            calcPerfResult();
        }

        function changePerfMode(mode) {
            project.perfInputMode = mode;
            if (mode === 'all' && !project.perfTotalCuts) {
                project.perfTotalCuts = Array(5).fill(null);
            }
            renderPerfTab();
        }

        function updatePerfTotalCut(idx, val) {
            if (!project.perfTotalCuts) project.perfTotalCuts = Array(5).fill(null);
            project.perfTotalCuts[idx] = val === '' ? null : Number(val);
            calcPerfResult();
        }

        function updatePerfCut(perfIdx, cutIdx, val) {
            project.perfs[perfIdx].cuts[cutIdx] = val === '' ? null : Number(val);
            calcPerfResult();
        }

        function calcPerfResult() {
            const paper = project.papers[currentPaperIdx] || project.papers[0];
            const mode = paper.scoreMode || 5;
            const levels = mode === 5 ? ['A', 'B', 'C', 'D', 'E'] : ['A', 'B', 'C', 'D']; // A/B, B/C ëŒ€ì‹  A, B, C, D ì‚¬ìš© (ìš”ì²­ì‚¬í•­)
            // ìš”ì•½ ì¹´ë“œ ì œëª©ì€ A, B, C... ë¡œ í‘œì‹œ (ìš”ì²­ì‚¬í•­ ë°˜ì˜)
            const displayLevels = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E/ë¯¸ë„ë‹¬'] : ['A/B', 'B/C', 'C/D', 'D/E']; // ê²°ê³¼ì°½ì€ ìœ ì§€? ìš”ì²­ì€ "ì œëª©ì„ ... ì…ë ¥ì¹¸ì—ëŠ”" ì´ì—ˆìŒ. 
            // ì‚¬ìš©ì ìš”ì²­: "ìˆ˜í–‰í‰ê°€ëŠ” A/B... ì•„ë‹ˆë¼ A, B, C, D, Eë¡œ ì œëª©ì„ ë§Œë“¤ê³ ... ì ìˆ˜ ì…ë ¥ì¹¸ì—ëŠ”..." 
            // -> ì…ë ¥ í…Œì´ë¸” í—¤ë”ëŠ” A, B... ë¡œ ë³€ê²½í•¨.
            // "ë˜í•œ ìˆ˜í–‰í‰ê°€ëŠ” ì „ì²´ì˜ì—­ê³¼... ì…ë ¥ëœ ìˆ˜í–‰í‰ê°€ëª…(ë§Œì )ìœ¼ë¡œ í‘œê¸°í•  ê²ƒ."

            // ê²°ê³¼ ê·¸ë¦¬ë“œ(ìš”ì•½ ì¹´ë“œ)ëŠ” "A/B" ë“±ì„ ìœ ì§€í•´ì•¼ í•˜ëŠ”ì§€, "A"ë¡œ ë°”ê¿”ì•¼ í•˜ëŠ”ì§€ ëª…í™•í•˜ì§€ ì•Šìœ¼ë‚˜,
            // "ì œëª©ì„ ...ìœ¼ë¡œ ë§Œë“¤ê³ " ê°€ ì…ë ¥ í…Œì´ë¸” í—¤ë”ë¥¼ ì˜ë¯¸í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì„.
            // ì¼ë‹¨ ê²°ê³¼ ì¹´ë“œëŠ” ì„±ì·¨ìˆ˜ì¤€ ëª…ì¹­(A/B ë“±)ì„ ê·¸ëŒ€ë¡œ ë‘ëŠ” ê²ƒì´ ë…¼ë¦¬ì ìœ¼ë¡œ ë§ìŒ(ì»·ì˜¤í”„ ì ìˆ˜ì´ë¯€ë¡œ).
            // í•˜ì§€ë§Œ ë§Œì•½ ì‚¬ìš©ìê°€ ê²°ê³¼ ì¹´ë“œë„ A, B, C.. ë¥¼ ì›í•œë‹¤ë©´ ìˆ˜ì • í•„ìš”. 
            // ë¬¸ë§¥ìƒ ì…ë ¥ í…Œì´ë¸” í—¤ë” ë³€ê²½ ìš”ì²­ì´ ê°•ë ¥í•˜ë¯€ë¡œ ê²°ê³¼ ì¹´ë“œëŠ” ì»·ì˜¤í”„ ì˜ë¯¸ë¥¼ ì‚´ë ¤ A/B ìœ ì§€ í˜¹ì€ Aë¡œ ë³€ê²½?
            // "ìˆ˜í–‰í‰ê°€ ì˜ì—­ë³„ A~E ë“±ê¸‰ ì ìˆ˜ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤" ë¬¸êµ¬ë¡œ ë³´ì•„ Aë“±ê¸‰ ì»·, Bë“±ê¸‰ ì»·... ì˜ ì˜ë¯¸ë¡œ A, B, C.. ë¥¼ ì“°ëŠ” ë“¯í•¨.
            // ì•ˆì „í•˜ê²Œ ê²°ê³¼ ì¹´ë“œë„ A, B... ë¡œ í†µì¼í•˜ëŠ” ê²ƒì´ ì¢‹ì•„ë³´ì„ (ì…ë ¥ê°’ê³¼ ì¼ì¹˜).
            // ê·¸ëŸ¬ë‚˜ ê¸°ì¡´ ë¡œì§ìƒ A/Bê°€ ì»·ì˜¤í”„ë¥¼ ì˜ë¯¸í•¨. 
            // ì¼ë‹¨ ì…ë ¥ í…Œì´ë¸”ì€ í™•ì‹¤íˆ A, B.. ë¡œ ë³€ê²½í–ˆìŒ. ê²°ê³¼ ì¹´ë“œëŠ” ê¸°ì¡´ ìœ ì§€í•˜ë˜ í—¤ë”ë§Œ ë³€ê²½ ê³ ë ¤.
            // ì—¬ê¸°ì„œëŠ” ê²°ê³¼ ì¹´ë“œë„ A, B... ë¡œ ë³€ê²½í•˜ì—¬ ì¼ê´€ì„± ìœ ì§€.

            const grid = document.getElementById('perfResultGrid');
            let html = '';

            levels.forEach((lv, i) => { // levelsëŠ” ì´ë¯¸ A, B... ë¡œ ì„¤ì •ë¨ (renderPerfTab ìƒë‹¨ì—ì„œ)
                // ê³„ì‚° ë¡œì§
                let total = 0;
                if (!project.perfInputMode || project.perfInputMode === 'all') {
                    // ì „ì²´ì˜ì—­ì¼ ë•Œ ì „ì œ ë§Œì  ëŒ€ë¹„ ë¹„ìœ¨ë¡œ í™˜ì‚°?
                    // ë³´í†µ ì „ì²´ì˜ì—­ ì…ë ¥ì€ "ì „ì²´ ë§Œì ì— ëŒ€í•œ ì»·ì˜¤í”„ ì ìˆ˜"ë¥¼ ì…ë ¥í•¨.
                    // ë”°ë¼ì„œ ì…ë ¥ëœ ì ìˆ˜ ê·¸ëŒ€ë¡œê°€ í•´ë‹¹ ìˆ˜ì¤€ì˜ ì»·ì˜¤í”„ì„.
                    // í•˜ì§€ë§Œ "ë°˜ì˜ë¹„ìœ¨"ì„ ê³ ë ¤í•´ì•¼ í•¨.
                    // ì „ì²´ì˜ì—­ ëª¨ë“œì¼ ë•ŒëŠ” ê° ìˆ˜í–‰í‰ê°€ì˜ ë¹„ìœ¨ í•©ê³„(ë³´í†µ 100%ë¼ ê°€ì •í•˜ê±°ë‚˜, ìˆ˜í–‰í‰ê°€ ë¹„ì¤‘ë§Œí¼)ê°€ ì ìš©ë˜ì–´ì•¼ í•˜ë‚˜?
                    // ì•„ë‹ˆë©´ ì…ë ¥ëœ ì ìˆ˜ ìì²´ê°€ 'í™˜ì‚° ì ìˆ˜'ì¸ê°€ 'ì›ì ìˆ˜'ì¸ê°€?
                    // ë¬¸í•­ì •ë³´í‘œ ë“±ì˜ íë¦„ìƒ "ì›ì ìˆ˜ ì»·"ì„ ì…ë ¥í•˜ë©´ "í™˜ì‚° ì ìˆ˜"ë¥¼ ê³„ì‚°í•´ì£¼ëŠ” êµ¬ì¡°ì„.
                    // ì „ì²´ì˜ì—­ ì›ì ìˆ˜ ì»·ì„ ì…ë ¥í–ˆë‹¤ë©´, (ì›ì ìˆ˜ / ì „ì²´ë°°ì ) * ìˆ˜í–‰í‰ê°€ë¹„ìœ¨ì´í•©?

                    const totalScore = project.perfs.reduce((s, p) => s + p.score, 0);
                    const totalRatio = project.perfs.reduce((s, p) => s + p.ratio, 0);
                    const cutScore = (project.perfTotalCuts && project.perfTotalCuts[i] !== null) ? project.perfTotalCuts[i] : 0;

                    // ì ìˆ˜ê°€ 0ì´ë©´ ê³„ì‚° 0
                    if (totalScore > 0 && cutScore !== null) {
                        total = (cutScore / totalScore) * totalRatio;
                    }
                } else {
                    // ì˜ì—­ë³„ ì…ë ¥
                    total = project.perfs.reduce((s, p) => {
                        const cut = (p.cuts[i] !== null) ? p.cuts[i] : 0;
                        return s + (cut * p.ratio / 100); // 100ì  ë§Œì  ê¸°ì¤€ì´ ì•„ë‹ˆë¼ p.score ê¸°ì¤€ ë¹„ë¡€ì‹?
                        // ê¸°ì¡´ ë¡œì§: s + (p.cuts[i] * p.ratio / 100) -> ì´ê±´ p.cuts[i]ê°€ 100ì  ë§Œì  í™˜ì‚°ì ìˆ˜ì¼ ë•Œ ì‹ì„?
                        // ì•„ë‹ˆë©´ p.cuts[i]ê°€ ì›ì ìˆ˜ì¼ ë•Œ?
                        // ê¸°ì¡´ ì½”ë“œ: p.scoreëŠ” ë°°ì (ì˜ˆ: 100). p.cuts[i]ëŠ” ì ìˆ˜.
                        // ë§Œì•½ ë°°ì ì´ 100ì´ë©´ (ì ìˆ˜ * ë¹„ìœ¨ / 100) ë§ìŒ.
                        // ë§Œì•½ ë°°ì ì´ 20ì ì´ë©´? (20ì  ë§Œì ì— 18ì  ì…ë ¥) -> (18 / 20) * ë¹„ìœ¨ ì´ì–´ì•¼ í•¨.
                        // í•˜ì§€ë§Œ ê¸°ì¡´ ì½”ë“œëŠ” `c * p.ratio / 100` ì˜€ìŒ. ì´ëŠ” "ì…ë ¥ê°’ì„ 100ì  ë§Œì  ê¸°ì¤€ ì ìˆ˜"ë¡œ ê°€ì •í–ˆê±°ë‚˜ "ë°°ì ì´ 100"ì´ë¼ ê°€ì •í•œ ê²ƒ.
                        // ì‚¬ìš©ìëŠ” "ë°°ì " ì»¬ëŸ¼ì´ ìˆê³  100ì´ë¼ ë˜ì–´ ìˆìŒ.
                        // ì¼ë°˜ì ì¸ ê³µì‹: (íšë“ì ìˆ˜ / ë°°ì ) * ë°˜ì˜ë¹„ìœ¨
                        // ë”°ë¼ì„œ (p.cuts[i] / p.score) * p.ratio ê°€ ì •í™•í•¨.
                        // ê¸°ì¡´ ì½”ë“œê°€ `c * p.ratio / 100` ì¸ ì´ìœ ëŠ” p.scoreê°€ ë¶„ëª¨ì— ì•ˆ ë“¤ì–´ê°€ê³  100ì´ ë“¤ì–´ê°”ê¸° ë•Œë¬¸.
                        // ì´ë²ˆ ê¸°íšŒì— (cut / p.score) * p.ratio ë¡œ ìˆ˜ì •í•˜ëŠ” ê²ƒì´ ì •í™•í•¨. (p.scoreê°€ 0ì´ë©´ 0)

                        if (p.score === 0) return s;
                        return s + ((cut / p.score) * p.ratio);
                    }, 0);
                }

                // í‘œì‹œìš© ë¼ë²¨: ì»·ì˜¤í”„ì˜ ì˜ë¯¸ë¥¼ ì‚´ë¦¬ê¸° ìœ„í•´ A/B ë“±ìœ¼ë¡œ ì¬ë§¤í•‘í•˜ê±°ë‚˜ A, B ê·¸ëŒ€ë¡œ ì‚¬ìš©.
                // ì‚¬ìš©ì ìš”ì²­ì€ "ìˆ˜í–‰í‰ê°€ëŠ” A/B... ì•„ë‹ˆë¼ A, B...ë¡œ ì œëª©ì„ ë§Œë“¤ê³ " ì˜€ìœ¼ë¯€ë¡œ A, B.. ì‚¬ìš©
                html += `<div class="summary-card"><div style="font-weight:bold;color:#1e40af;margin-bottom:8px;">${displayLevels[i]}</div><div class="score-val">${total.toFixed(2)}</div></div>`;
            });
            grid.innerHTML = html;
        }

        // === ìµœì¢…ê²°ê³¼ ===
        function calculateFinal() {
            const grid = document.getElementById('finalResultGrid');
            const breakdown = document.getElementById('detailBreakdown');

            const paper = project.papers[currentPaperIdx] || project.papers[0];
            const mode = paper.scoreMode || 5;
            const levels = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E/ë¯¸ë„ë‹¬'] : ['A/B', 'B/C', 'C/D', 'D/E'];

            let paperTotals = [0, 0, 0, 0, 0], perfTotals = [0, 0, 0, 0, 0];
            let paperRows = '';

            // ì§€í•„í‰ê°€ í•©ì‚°
            project.papers.forEach(paper => {
                if (paper.categories.length === 0) {
                    paperRows += `<tr><td>${paper.name}</td><td>${paper.ratio}%</td><td colspan="5">-</td></tr>`;
                    return;
                }

                // ì„ íƒëœ ë¼ìš´ë“œê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„, ì—†ìœ¼ë©´ í˜„ì¬ ë¼ìš´ë“œë¥¼ ì‚¬ìš©
                const targetRound = paper.selectedResultRound !== undefined ? paper.selectedResultRound : paper.currentRound;

                let cnt = 0;
                const sums = [0, 0, 0, 0, 0];
                const mode = paper.scoreMode || 5;
                const cols = mode === 5 ? 5 : 4;

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td || !td.rounds[targetRound]) return;

                    const isComplete = td.rounds[targetRound].length >= paper.categories.length && td.rounds[targetRound].every(row => {
                        if (!row) return false;
                        for (let n = 0; n < cols; n++) {
                            if (row[n] === null || row[n] === undefined || row[n] === '') return false;
                        }
                        return true;
                    });

                    if (isComplete) {
                        paper.categories.forEach((cat, ci) => {
                            const vals = td.rounds[targetRound][ci];
                            for (let vi = 0; vi < cols; vi++) {
                                sums[vi] += cat.totalScore * (parseFloat(vals[vi]) / 100);
                            }
                        });
                        cnt++;
                    }
                });

                if (cnt > 0) {
                    const avgs = sums.map(s => s / cnt);
                    avgs.forEach((s, i) => paperTotals[i] += s * paper.ratio / 100);

                    paperRows += `<tr><td>${paper.name} <span style="font-size:0.8em;color:#666;">(${targetRound + 1}R)</span></td><td>${paper.ratio}%</td>`;
                    avgs.forEach((v, i) => {
                        if (mode === 4 && i === 4) paperRows += '<td>-</td>';
                        else paperRows += `<td>${v.toFixed(2)}</td>`;
                    });
                    paperRows += '</tr>';
                } else {
                    paperRows += `<tr><td>${paper.name}</td><td>${paper.ratio}%</td><td colspan="5">-</td></tr>`;
                }
            });

            // ìˆ˜í–‰í‰ê°€ í•©ì‚°
            perfTotals.fill(0);

            if (!project.perfInputMode || project.perfInputMode === 'all') {
                // ì „ì²´ì˜ì—­ ëª¨ë“œ ê³„ì‚°
                const totalScore = project.perfs.reduce((s, p) => s + p.score, 0);
                const totalRatio = project.perfs.reduce((s, p) => s + p.ratio, 0);

                levels.forEach((lv, i) => {
                    // 4ë‹¨ê³„ ëª¨ë“œì¼ ë•Œ 5ë²ˆì§¸(E) ì²˜ë¦¬
                    const curPaper = project.papers[currentPaperIdx] || project.papers[0];
                    const mode = curPaper.scoreMode || 5;
                    if (mode === 4 && i === 4) return;

                    const cutScore = (project.perfTotalCuts && project.perfTotalCuts[i] !== null) ? project.perfTotalCuts[i] : 0;
                    if (totalScore > 0) {
                        perfTotals[i] = (cutScore / totalScore) * totalRatio;
                    }
                });
            } else {
                // ì˜ì—­ë³„ ëª¨ë“œ ê³„ì‚°
                project.perfs.forEach(p => {
                    p.cuts.forEach((c, i) => {
                        // mode 4ì¼ ë•Œ E(index 4)ëŠ” í•©ì‚°í•˜ì§€ ì•ŠìŒ
                        const curPaper = project.papers[currentPaperIdx] || project.papers[0];
                        const mode = curPaper.scoreMode || 5;
                        if (mode === 4 && i === 4) return;

                        const val = (c !== null) ? c : 0;
                        if (p.score > 0) {
                            perfTotals[i] += (val / p.score) * p.ratio;
                        }
                    });
                });
            }

            const finals = paperTotals.map((p, i) => p + perfTotals[i]);

            grid.innerHTML = levels.map((lv, i) =>
                `<div class="summary-card"><div style="font-weight:bold;color:#1e40af;margin-bottom:10px;">${lv}</div><div class="score-val">${finals[i].toFixed(2)}</div><div style="font-size:0.85rem;color:#64748b;">ì •ê¸°ì‹œí—˜ ${paperTotals[i].toFixed(1)} + ìˆ˜í–‰ ${perfTotals[i].toFixed(1)}</div></div>`
            ).join('');

            // === ìƒì„¸ ì‚°ì¶œ ë‚´ì—­ í…Œì´ë¸” ìƒì„± (2ë‹¨ í—¤ë”) ===

            // í—¤ë” ìƒì„±
            // const levelsëŠ” ìƒë‹¨ì—ì„œ ì´ë¯¸ ì„ ì–¸ë¨
            let bhtml = `<table>
                <thead>
                    <tr>
                        <th rowspan="2" style="vertical-align:middle;">ì •ê¸°ì‹œí—˜/ìˆ˜í–‰<br>êµ¬ë¶„</th>
                        <th rowspan="2" style="vertical-align:middle;">ê³ ì‚¬/ì˜ì—­</th>
                        <th rowspan="2" style="vertical-align:middle;">ë°˜ì˜ë¹„ìœ¨(%)</th>
                        <th rowspan="2" style="vertical-align:middle;">ë°°ì </th>
                        <th colspan="${levels.length}" style="text-align:center;">ì„±ì·¨ìˆ˜ì¤€ë³„ë¶„í• ì ìˆ˜</th>
                    </tr>
                    <tr>
                        ${levels.map(l => `<th>${l}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>`;

            // ì§€í•„í‰ê°€ í–‰ë“¤
            const paperCount = project.papers.length;

            // paperRowsëŠ” ìœ„ì—ì„œ ì´ë¯¸ ê³„ì‚°ë¨ (ë¬¸ìì—´). í•˜ì§€ë§Œ í¬ë§·ì´ ë‹¤ë¦„(êµ¬ë¶„, ë¹„ìœ¨, ì ìˆ˜ë“¤).
            // ë”°ë¼ì„œ ìœ„ loopì—ì„œ ë¬¸ìì—´ì„ ë§Œë“¤ì§€ ë§ê³  ë°ì´í„°ë§Œ ë½‘ì•„ë‚´ëŠ”ê²Œ ì¢‹ì•˜ìœ¼ë‚˜, 
            // ì—¬ê¸°ì„œëŠ” ê¸°ì¡´ ë¡œì§ í™œìš© ìœ„í•´ project.papersë¥¼ ë‹¤ì‹œ ìˆœíšŒí•˜ì—¬ ìƒˆë¡œìš´ í¬ë§·ì˜ í–‰ì„ ë§Œë“¦.

            // paperTotals ê³„ì‚° ë¡œì§ì€ ìœ„ì—ì„œ ì´ë¯¸ ìˆ˜í–‰ë¨. ì¬ì‚¬ìš©í•˜ì§€ ì•Šê³  ìƒˆë¡œ ê·¸ë¦¬ëŠ”ê²Œ ë‚«ì§€ë§Œ, 
            // ìœ„ìª½ forEachì—ì„œ paperRows += ... í•˜ëŠ” ë¶€ë¶„ì„ ì—¬ê¸°ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë¬´ì‹œë¨.
            // ë‹¨, avgs ë°ì´í„°ê°€ í•„ìš”í•¨. ìœ„ ë¡œì§ì€ avgsë¥¼ paperTotalsì— í•©ì‚°ë§Œ í•˜ê³  ê°’ ì €ì¥ì„ ì•ˆí•¨.
            // ë”°ë¼ì„œ ì •í™•í•œ ë°ì´í„°ë¥¼ ìœ„í•´ ìœ„ìª½ ë£¨í”„ ê°œì„ ì´ í•„ìš”.
            // í•˜ì§€ë§Œ ë³µì¡ì„±ì„ ì¤„ì´ê¸° ìœ„í•´ ìœ„ì—ì„œëŠ” ì´ì ë§Œ ê³„ì‚°í•˜ê³ , ì—¬ê¸°ì„œëŠ” í™”ë©´ í‘œì‹œìš© ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê³„ì‚°í•˜ê±°ë‚˜
            // ìœ„ ë£¨í”„ì—ì„œ ë°ì´í„°ë¥¼ ë°°ì—´ì— ì €ì¥í•´ë‘ëŠ” ê²ƒì´ ì¢‹ìŒ.

            // ì—¬ê¸°ì„œëŠ” ìœ„ìª½ ë£¨í”„ë¥¼ "ì´ì  ê³„ì‚°ìš©"ìœ¼ë¡œë§Œ ì“°ê³ , ì•„ë˜ì—ì„œ "í‘œì‹œìš©" ë£¨í”„ë¥¼ ìƒˆë¡œ ëŒë¦¼.

            // --- ì§€í•„í‰ê°€ ë£¨í”„ (í‘œì‹œìš©) ---
            let paperDataRows = [];
            project.papers.forEach(paper => {
                const subject = project.info.subject || 'ê³¼ëª©ëª…';
                const nameStr = `[${subject}] ${paper.name}`;
                // ë§Œì (ë°°ì )ì€ paper.score (ì—†ìœ¼ë©´ 100)
                const score = paper.score || 100;

                // ì ìˆ˜ ê³„ì‚° (ìœ„ ë¡œì§ ë³µì‚¬)
                const targetRound = paper.selectedResultRound !== undefined ? paper.selectedResultRound : paper.currentRound;
                const mode = paper.scoreMode || 5;
                const cols = mode === 5 ? 5 : 4;
                let cnt = 0;
                let sums = [0, 0, 0, 0, 0];
                let rowVals = Array(cols).fill('-'); // ê¸°ë³¸ê°’

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td || !td.rounds[targetRound]) return;
                    const isComplete = td.rounds[targetRound].length >= paper.categories.length && td.rounds[targetRound].every(row => {
                        if (!row) return false;
                        for (let n = 0; n < cols; n++) {
                            if (row[n] === null || row[n] === undefined || row[n] === '') return false;
                        }
                        return true;
                    });
                    if (isComplete) {
                        paper.categories.forEach((cat, ci) => {
                            const vals = td.rounds[targetRound][ci];
                            for (let vi = 0; vi < cols; vi++) {
                                sums[vi] += cat.totalScore * (parseFloat(vals[vi]) / 100);
                            }
                        });
                        cnt++;
                    }
                });

                if (cnt > 0) {
                    const avgs = sums.map(s => s / cnt);
                    rowVals = avgs.map(v => v.toFixed(2));
                }

                // mode 4 ì²˜ë¦¬
                let displayVals = rowVals.slice(0, levels.length);
                if (mode === 4) {
                    // levels.lengthëŠ” 4. 
                    // rowValsëŠ” 5ê°œì¼ ìˆ˜ ìˆìŒ(ë¡œì§ìƒ sumsê°€ 5ê°œ).
                    // mode 4ì´ë©´ avgsë„ 5ê°œ(ë§ˆì§€ë§‰ 0).
                }
                // ìœ„ì—ì„œ slice ì²˜ë¦¬í•¨

                paperDataRows.push({
                    name: nameStr,
                    ratio: paper.ratio,
                    score: score,
                    vals: rowVals // ì „ì²´ 5ê°œ ë‹¤ ê°€ì§, í‘œì‹œëŠ” levelsì— ë§ì¶¤
                });
            });

            paperDataRows.forEach((p, i) => {
                bhtml += `<tr>`;
                if (i === 0) {
                    bhtml += `<td rowspan="${paperDataRows.length}" style="vertical-align:middle; background:#f9fafb; font-weight:bold;">ì •ê¸°ì‹œí—˜</td>`;
                }
                bhtml += `<td style="text-align:left; padding-left:10px;">${p.name}</td>
                          <td>${p.ratio}</td>
                          <td>${p.score}</td>
                          ${levels.map((l, li) => {
                    // mode 4ì¼ë•Œ ë§ˆì§€ë§‰ EëŠ” - í‘œì‹œ?
                    // ìœ„ ë¡œì§ì—ì„œ rowValsì— ê°’ ìˆìœ¼ë©´ í‘œì‹œ.
                    if (li >= p.vals.length) return '<td>-</td>';
                    // ë§Œì•½ í•´ë‹¹ ê³ ì‚¬ê°€ 4ë‹¨ê³„ì¸ë° í˜„ì¬ í‘œê°€ 5ë‹¨ê³„ë¼ë©´?
                    // levelsëŠ” í˜„ì¬ paper ê¸°ì¤€ modeê°€ ì•„ë‹ˆë¼ ì „ì²´ ê¸°ì¤€?
                    // levelsëŠ” calculateFinal ì´ˆë°˜ì— currentPaperIdx ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •ë¨.
                    // ë”°ë¼ì„œ í˜„ì¬ ì„ íƒëœ íƒ­ì˜ ëª¨ë“œë¥¼ ë”°ë¦„.
                    return `<td>${p.vals[li] !== undefined ? p.vals[li] : '-'}</td>`;
                }).join('')}
                          </tr>`;
            });

            // --- ìˆ˜í–‰í‰ê°€ ë£¨í”„ (í‘œì‹œìš©) ---
            // ì „ì²´ì˜ì—­ ëª¨ë“œì¼ ë•Œì™€ ì˜ì—­ë³„ ëª¨ë“œì¼ ë•Œ í‘œì‹œ ë°©ì‹
            // ì‚¬ìš©ì ìš”ì²­ ì´ë¯¸ì§€(2ë²ˆì§¸)ë¥¼ ë³´ë©´ "ìˆ˜í–‰ [ê³µí†µêµ­ì–´1] [ì „ì²´ì˜ì—­]" ì²˜ëŸ¼ ë‚˜ì˜´.
            // ì˜ì—­ë³„ì´ë©´ ê° ì˜ì—­ì´ ë‚˜ì˜¬ ê²ƒì„.
            const perfCount = project.perfs.length;
            // ë§Œì•½ ì „ì²´ì˜ì—­ ëª¨ë“œë¼ë©´ 1ì¤„ë§Œ í‘œì‹œ?
            // "ìƒì„¸ ì‚°ì¶œ ë‚´ì—­"ì€ ê°œë³„ í•­ëª©ì„ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ë§ìŒ.
            // í•˜ì§€ë§Œ project.perfInputMode === 'all' ì´ë©´ ì‹¤ì œ ë°ì´í„° êµ¬ì¡°ìƒ perfs[i].score ë“±ì´ ì˜ë¯¸ê°€ ì—†ê³ 
            // perfTotalCuts í•˜ë‚˜ë§Œ ì˜ë¯¸ê°€ ìˆìŒ.
            // ê·¸ëŸ¬ë‚˜ ì‚¬ìš©ìëŠ” [ì „ì²´ì˜ì—­]ì´ë¼ê³  ëª…ì‹œí•˜ê¸¸ ì›í•¨.
            // ë§Œì•½ perfInputMode === 'all' ì´ë©´ project.perfs ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ í‘œí˜„?
            // "ì „ì²´ ì˜ì—­"ì´ë¼ëŠ” ì´ë¦„ì˜ 1ê°œ Rowë§Œ ë³´ì—¬ì£¼ëŠ”ê²Œ ë§ì„ ë“¯.

            const subject = project.info.subject || 'ê³¼ëª©ëª…';

            if (!project.perfInputMode || project.perfInputMode === 'all') {
                // ì „ì²´ì˜ì—­ 1ì¤„
                const totalScore = project.perfs.reduce((s, p) => s + p.score, 0); // ë°°ì  í•©ê³„
                const totalRatio = project.perfs.reduce((s, p) => s + p.ratio, 0);
                const cuts = project.perfTotalCuts || [0, 0, 0, 0, 0];

                bhtml += `<tr>
                    <td style="vertical-align:middle; background:#f9fafb; font-weight:bold;">ìˆ˜í–‰</td>
                    <td style="text-align:left; padding-left:10px;">[${subject}] [ì „ì²´ì˜ì—­]</td>
                    <td>${totalRatio}</td>
                    <td>${totalScore}</td>
                    ${levels.map((l, i) => `<td>${cuts[i] !== null ? cuts[i] : '-'}</td>`).join('')}
                 </tr>`;

            } else {
                // ì˜ì—­ë³„ nì¤„
                project.perfs.forEach((p, i) => {
                    bhtml += `<tr>`;
                    if (i === 0) {
                        bhtml += `<td rowspan="${perfCount}" style="vertical-align:middle; background:#f9fafb; font-weight:bold;">ìˆ˜í–‰</td>`;
                    }
                    bhtml += `<td style="text-align:left; padding-left:10px;">[${subject}] ${p.name}</td>
                              <td>${p.ratio}</td>
                              <td>${p.score}</td>
                              ${levels.map((l, li) => `<td>${p.cuts[li] !== null ? p.cuts[li] : '-'}</td>`).join('')}
                              </tr>`;
                });
            }

            bhtml += `</tbody></table>
            
            <!-- ìµœì¢… ê²°ê³¼ í–‰ (ê¸°ì¡´ ì‚­ì œ í›„ ë¶€í™œ? ì•„ë‹ˆë©´ ìƒì„¸ë‚´ì—­ì—ëŠ” ìµœì¢…ê²°ê³¼ ì•ˆ ë„£ìŒ?) -->
            <!-- ìƒì„¸ ë‚´ì—­ í…Œì´ë¸” ì•„ë˜ì— ìµœì¢… ê²°ê³¼ í–‰ì„ ë„£ëŠ”ì§€ ì—¬ë¶€ëŠ” ìš”ì²­ì— ì—†ìœ¼ë‚˜, 
                 ê¸°ì¡´ì— ì†Œê³„, ìµœì¢… ë“±ì„ ë³´ì—¬ì£¼ë˜ í‘œë¥¼ ëŒ€ì²´í•˜ëŠ” ê²ƒì´ë¯€ë¡œ 
                 ìµœì¢… í•©ê³„(í•™ê¸°ë§)ëŠ” ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ì¢‹ì„ ìˆ˜ ìˆìŒ. 
                 í•˜ì§€ë§Œ ìš”ì²­ì‚¬í•­ì€ "ìƒì„¸ ì‚°ì¶œ ë‚´ì—­ì˜ ì—´ ì œëª©ì€..."í•˜ê³  ëë‚¬ê³ ,
                 ë³„ë„ë¡œ "ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ ê²°ê³¼" ë°•ìŠ¤ê°€ ìˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì—ëŠ” í¬í•¨ ì•ˆ í•´ë„ ë¨.
                 ì‚¬ìš©ì ì´ë¯¸ì§€ì—ë„ ì•„ë˜ìª½ì— ì§¤ë ¤ìˆì–´ì„œ ìµœì¢… í–‰ì´ ìˆëŠ”ì§€ ë¶ˆë¶„ëª….
                 ì¼ë‹¨ ìˆœìˆ˜ ë‚´ì—­ë§Œ í‘œì‹œí•˜ê³ , ìµœì¢… í•©ì‚° ê°’ì€ ì•„ë˜ 'ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ ê²°ê³¼' ê·¸ë¦¬ë“œ(ì¹´ë“œ)ê°€ ëŒ€ì‹ í•¨. -->
            
            `;

            breakdown.innerHTML = bhtml;
        }

        // === ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ===
        function saveFullProject() {
            project.info.year = document.getElementById('year').value;
            project.info.semester = document.getElementById('semester').value;
            project.info.subject = document.getElementById('subject').value;
            const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            a.download = `ë‚˜ì´ìŠ¤ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ(${year}-${month}-${day}_${hours}${minutes}).json`;
            a.click();
        }

        function loadFullProject(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (ev) {
                try {
                    project = JSON.parse(ev.target.result);
                    document.getElementById('year').value = project.info?.year || '2026';
                    document.getElementById('semester').value = project.info?.semester || '1í•™ê¸°';
                    document.getElementById('subject').value = project.info?.subject || '';
                    if (project.accessGranted) switchTab(1);
                    else switchTab(0);
                    alert('âœ… ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
                } catch (err) { alert('íŒŒì¼ ì˜¤ë¥˜'); }
            };
            reader.readAsText(file);
        }



        function exportFinalReport() { calculateFinal(); saveFullProject(); }

        // ì´ˆê¸°í™”
        window.onload = function () { switchTab(0); };
    </script>
</body>

=======
ï»¿<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ê¸°ë§ í†µí•© ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --border: #cbd5e1;
            --danger: #ef4444;
            --success: #22c55e;
            --dark: #1e293b;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 20px;
            color: #1e293b;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .tabs {
            display: flex;
            background: #334155;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 20px;
            color: #cbd5e1;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.95rem;
            white-space: nowrap;
            transition: 0.2s;
        }

        .tab:hover {
            color: #fbbf24;
            background: #475569;
        }

        .tab.active {
            color: #1e293b;
            background: #fbbf24;
            font-weight: bold;
            border-bottom: 3px solid #60a5fa;
        }

        .content {
            padding: 25px;
            display: none;
            min-height: 500px;
        }

        .content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .section-box {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fff;
        }

        .section-title {
            font-weight: bold;
            font-size: 1.05rem;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            padding-left: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        th,
        td {
            border: 1px solid var(--border);
            padding: 10px;
            text-align: center;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
        }

        input,
        select {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            text-align: center;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            border: none;
            color: white;
            transition: 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-dark {
            background: var(--dark);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .grid-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .info-box {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            color: #0369a1;
            font-size: 0.9rem;
        }

        .warning-box {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            color: #92400e;
        }

        .summary-card {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #bfdbfe;
            text-align: center;
        }

        .score-val {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .ratio-ok {
            background: #dcfce7;
            color: #166534;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .ratio-warn {
            background: #fef9c3;
            color: #854d0e;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .ratio-error {
            background: #fee2e2;
            color: #991b1b;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .sub-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .sub-tab {
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .sub-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .sub-tab.completed {
            background: #dcfce7;
            color: #166534;
            border-color: #86efac;
        }

        .invalid-input {
            background: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #dc2626 !important;
        }

        .warning-diff {
            background: #fef3c7 !important;
            border-color: #f59e0b !important;
        }

        .diff-alert {
            color: #dc2626;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        .radio-label input {
            margin-right: 10px;
        }

        .teacher-control {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .round-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .round-tab {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: bold;
            color: #64748b;
        }

        .round-tab.active {
            background: white;
            color: var(--primary);
            border-color: var(--primary);
        }

        .round-tab.add-btn {
            background: #ecfdf5;
            color: #059669;
            border-color: #a7f3d0;
        }

        .badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div>
                <h1>ğŸ“Š ë‚˜ì´ìŠ¤ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ ì‹¤ìŠµ( ver 1.0)</h1>
                <div style="font-size:0.85rem;opacity:0.8;margin-top:5px;">ë§Œë“ ì´ : ì‚¬ê³¡ê³  ìˆ˜ì„êµì‚¬ ìµœì—°í˜¸</div>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="btn btn-success" onclick="saveFullProject()">ğŸ’¾ ì „ì²´ ì €ì¥</button>
                <button class="btn btn-dark" onclick="document.getElementById('fullLoad').click()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <input type="file" id="fullLoad" style="display:none" accept=".json" onchange="loadFullProject(event)">
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">1. í‰ê°€êµ¬ì¡°</button>
            <button class="tab" onclick="switchTab(1)">2. ì§€í•„í‰ê°€ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ</button>
            <button class="tab" onclick="switchTab(2)">3. ìˆ˜í–‰í‰ê°€ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ</button>
            <button class="tab" onclick="switchTab(3)">4. í•™ê¸°ë§ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ</button>
        </div>

        <!-- íƒ­ 0: í‰ê°€êµ¬ì¡° ì„¤ì • -->
        <div id="tab-0" class="content active">
            <div class="section-box">
                <div class="section-title">ğŸ“ ê¸°ë³¸ ì •ë³´</div>
                <div class="grid-3">
                    <div><label>í•™ë…„ë„</label><select id="year" style="width:100%">
                            <option>2026</option>
                            <option>2025</option>
                        </select></div>
                    <div><label>í•™ê¸°</label><select id="semester" style="width:100%">
                            <option>1í•™ê¸°</option>
                            <option>2í•™ê¸°</option>
                        </select></div>
                    <div><label>ê³¼ëª©ëª…</label><input type="text" id="subject" style="width:100%" placeholder="ì˜ˆ: ë¬¼ë¦¬í•™â… ">
                    </div>
                </div>
            </div>

            <div class="section-box">
                <div class="section-title">ğŸ‘¥ êµì‚¬ ë“±ë¡ <span class="badge" id="teacherCount">0ëª…</span></div>
                <div class="teacher-control">
                    <input type="text" id="newTeacherName" placeholder="êµì‚¬ëª… ì…ë ¥"
                        onkeypress="if(event.key==='Enter')addTeacher()">
                    <button class="btn btn-primary btn-sm" onclick="addTeacher()">+ ì¶”ê°€</button>
                </div>
                <div id="teacherList" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
            </div>

            <div class="section-box">
                <div class="section-title">ğŸ“‹ ì§€í•„í‰ê°€ êµ¬ì„± <span>í•©ê³„: <span id="paperRatioTotal"
                            class="ratio-warn">0%</span></span>
                    <button class="btn btn-primary btn-sm" onclick="addPaper()">+ ì¶”ê°€</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>êµ¬ë¶„</th>
                            <th>ë°°ì </th>
                            <th>ë°˜ì˜ë¹„ìœ¨(%)</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="paperTbody"></tbody>
                </table>
            </div>

            <div class="section-box">
                <div class="section-title">ğŸ“‹ ìˆ˜í–‰í‰ê°€ êµ¬ì„± <span>í•©ê³„: <span id="perfRatioTotal"
                            class="ratio-warn">0%</span></span>
                    <button class="btn btn-primary btn-sm" onclick="addPerf()">+ ì¶”ê°€</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ì˜ì—­ëª…</th>
                            <th>ë°°ì </th>
                            <th>ë°˜ì˜ë¹„ìœ¨(%)</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="perfTbody"></tbody>
                </table>
            </div>
            <div class="info-box">ğŸ’¡ ë°˜ì˜ë¹„ìœ¨ í•©ê³„: <strong id="totalRatio">0%</strong> (100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤)</div>
        </div>

        <!-- íƒ­ 1: ì§€í•„í‰ê°€ -->
        <div id="tab-1" class="content">
            <div class="info-box">ğŸ“Œ ê° ì§€í•„í‰ê°€ë³„ë¡œ ë¬¸í•­ì •ë³´í‘œë¥¼ ì—…ë¡œë“œí•˜ê³ , êµì‚¬ë³„ ì˜ˆìƒì •ë‹µë¥ ì„ ì…ë ¥í•©ë‹ˆë‹¤.</div>
            <div class="sub-tabs" id="paperSubTabs"></div>
            <div id="paperContent"></div>
        </div>

        <!-- íƒ­ 2: ìˆ˜í–‰í‰ê°€ -->
        <div id="tab-2" class="content">
            <div class="info-box">ğŸ“Œ ìˆ˜í–‰í‰ê°€ ì˜ì—­ë³„ A~E ë“±ê¸‰ ì ìˆ˜ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</div>
            <div class="section-box">
                <div class="section-title">ğŸ“ ìˆ˜í–‰í‰ê°€ ë“±ê¸‰ë³„ ì ìˆ˜ ì…ë ¥</div>
                <table>
                    <thead id="perfCutsThead">
                        <tr>
                            <th>ì˜ì—­ëª…</th>
                            <th>ë°°ì </th>
                            <th>A</th>
                            <th>B</th>
                            <th>C</th>
                            <th>D</th>
                            <th>E</th>
                        </tr>
                    </thead>
                    <tbody id="perfCutsTbody"></tbody>
                </table>
            </div>
            <div class="section-box">
                <div class="section-title">ğŸ“Š ìˆ˜í–‰í‰ê°€ ë°˜ì˜ë¹„ìœ¨ ì ìš© ê²°ê³¼</div>
                <div class="grid-5" id="perfResultGrid"></div>
            </div>
        </div>

        <!-- íƒ­ 3: ìµœì¢…ê²°ê³¼ -->
        <div id="tab-3" class="content">
            <div class="section-box">
                <div class="section-title">ğŸ† í•™ê¸°ë§ ìµœì¢… ì¶”ì •ë¶„í• ì ìˆ˜</div>
                <div class="grid-5" id="finalResultGrid"></div>
            </div>
            <div class="section-box">
                <div class="section-title">ğŸ“Š ìƒì„¸ ì‚°ì¶œ ë‚´ì—­</div>
                <div id="detailBreakdown"></div>
            </div>
            <div style="text-align:center;margin-top:20px;">
                <button class="btn btn-success" style="padding:15px 40px;font-size:1.1rem;"
                    onclick="exportFinalReport()">ğŸ“Š ìµœì¢… ë³´ê³ ì„œ ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- ìŠ¹ì¸ìš”ì²­ ëª¨ë‹¬ -->
    <div id="approvalModal" class="modal">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">ğŸ“ ìŠ¹ì¸ ìš”ì²­</h2>
                <button onclick="closeModal('approvalModal')"
                    style="background:none;border:none;font-size:1.5rem;cursor:pointer;">âœ•</button>
            </div>
            <div style="margin-bottom:15px;"><label>ë¼ìš´ë“œ ì„ íƒ:</label><select id="approvalRoundSelect"
                    style="width:100%;margin-top:5px;"></select></div>
            <div class="warning-box">âš ï¸ ë‚˜ì´ìŠ¤ì—ì„œ ì„ íƒ í›„ ìƒì‹ í•¨</div>
            <div style="text-align:right;"><button class="btn btn-dark"
                    onclick="closeModal('approvalModal')">ë‹«ê¸°</button></div>
        </div>
    </div>

    <!-- ë§ˆê°ì·¨ì†Œ ëª¨ë‹¬ -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">ğŸ”“ ì…ë ¥ë§ˆê° ì·¨ì†Œ</h2>
                <button onclick="closeModal('cancelModal')"
                    style="background:none;border:none;font-size:1.5rem;cursor:pointer;">âœ•</button>
            </div>
            <div class="warning-box">âš ï¸ ë§ˆê°ì„ ì·¨ì†Œí•˜ë©´ í•´ë‹¹ ë¼ìš´ë“œë¥¼ ë‹¤ì‹œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            <div class="radio-group" style="margin-bottom:15px;">
                <label class="radio-label"><input type="radio" name="cancelReason" value="ë¬¸í•­ ì˜¤ë¥˜ë¡œ ì¸í•œ ë§Œì  ë³€ë™">ë¬¸í•­ ì˜¤ë¥˜ë¡œ ì¸í•œ ë§Œì 
                    ë³€ë™</label>
                <label class="radio-label"><input type="radio" name="cancelReason" value="ì „ë©´ ì¬ì‹œí—˜">ì „ë©´ ì¬ì‹œí—˜</label>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button class="btn btn-dark" onclick="closeModal('cancelModal')">ì·¨ì†Œ</button>
                <button class="btn btn-danger" onclick="confirmCancelFinalize()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œê²°ê³¼ ëª¨ë‹¬ -->
    <div id="resultModal" class="modal">
        <div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">ğŸ“Š ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œê²°ê³¼</h2>
                <button onclick="closeModal('resultModal')"
                    style="background:none;border:none;font-size:1.5rem;cursor:pointer;">âœ•</button>
            </div>
            <div id="resultModalContent"></div>
            <div
                style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;border-top:1px solid #e2e8f0;padding-top:15px;">
                <button class="btn btn-primary" onclick="exportRoundResultsToExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-success" onclick="openApprovalFromResult()">ğŸ“ ìŠ¹ì¸ìš”ì²­</button>
                <button class="btn btn-dark" onclick="closeModal('resultModal')">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // === ì „ì—­ ë°ì´í„° ===
        let project = {
            info: { year: '2026', semester: '1í•™ê¸°', subject: '' },
            teachers: [],
            papers: [{ name: '1íšŒ ì§€í•„í‰ê°€', score: 100, ratio: 30, excelData: [], categories: [], teacherData: {}, currentRound: 0, scoreMode: 5 }],
            perfs: [{ name: 'ìˆ˜í–‰í‰ê°€1', score: 100, ratio: 40, cuts: [95, 85, 75, 65, 55] }]
        };
        let currentTab = 0;
        let currentPaperIdx = 0;

        // === íƒ­ ì „í™˜ ===
        function switchTab(idx) {
            currentTab = idx;
            document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
            document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
            if (idx === 0) renderSetup();
            if (idx === 1) renderPaperTab();
            if (idx === 2) renderPerfTab();
            if (idx === 3) calculateFinal();
        }

        // === êµì‚¬ ê´€ë¦¬ ===
        function addTeacher() {
            const name = document.getElementById('newTeacherName').value.trim();
            if (!name) { alert('êµì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            if (project.teachers.includes(name)) { alert('ì´ë¯¸ ë“±ë¡ëœ êµì‚¬ì…ë‹ˆë‹¤.'); return; }
            project.teachers.push(name);
            document.getElementById('newTeacherName').value = '';
            renderTeacherList();
            // ê° ì§€í•„í‰ê°€ì— êµì‚¬ ë°ì´í„° ì´ˆê¸°í™”
            project.papers.forEach(p => { if (!p.teacherData[name]) p.teacherData[name] = { rounds: [[]], completedRounds: [] }; });
        }
        function removeTeacher(name) {
            if (!confirm(`'${name}' êµì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            project.teachers = project.teachers.filter(t => t !== name);
            project.papers.forEach(p => delete p.teacherData[name]);
            renderTeacherList();
        }
        function renderTeacherList() {
            document.getElementById('teacherCount').textContent = project.teachers.length + 'ëª…';
            document.getElementById('teacherList').innerHTML = project.teachers.map(t =>
                `<span style="background:#e0f2fe;padding:6px 12px;border-radius:20px;display:flex;align-items:center;gap:5px;">${t}<button onclick="removeTeacher('${t}')" style="background:none;border:none;cursor:pointer;color:#dc2626;">âœ•</button></span>`
            ).join('');
        }

        // === í‰ê°€êµ¬ì¡° ì„¤ì • ===
        function addPaper() { project.papers.push({ name: `${project.papers.length + 1}íšŒ ì§€í•„í‰ê°€`, score: 100, ratio: 0, excelData: [], categories: [], teacherData: {}, currentRound: 0, scoreMode: 5 }); renderSetup(); }
        function addPerf() { project.perfs.push({ name: `ìˆ˜í–‰í‰ê°€${project.perfs.length + 1}`, score: 100, ratio: 0, cuts: [0, 0, 0, 0, 0] }); renderSetup(); }
        function removePaper(i) { if (project.papers.length <= 1) return alert('ìµœì†Œ 1ê°œ í•„ìš”'); project.papers.splice(i, 1); renderSetup(); }
        function removePerf(i) { if (project.perfs.length <= 1) return alert('ìµœì†Œ 1ê°œ í•„ìš”'); project.perfs.splice(i, 1); renderSetup(); }

        function renderSetup() {
            renderTeacherList();
            let pSum = 0, fSum = 0;
            document.getElementById('paperTbody').innerHTML = project.papers.map((p, i) => {
                pSum += p.ratio;
                return `<tr><td><input value="${p.name}" onchange="project.papers[${i}].name=this.value" style="width:150px"></td>
        <td><input type="number" value="${p.score}" onchange="project.papers[${i}].score=Number(this.value)" style="width:80px"></td>
        <td><input type="number" value="${p.ratio}" onchange="project.papers[${i}].ratio=Number(this.value);renderSetup()" style="width:80px"></td>
        <td><button class="btn btn-danger btn-sm" onclick="removePaper(${i})">ì‚­ì œ</button></td></tr>`;
            }).join('');
            document.getElementById('perfTbody').innerHTML = project.perfs.map((p, i) => {
                fSum += p.ratio;
                return `<tr><td><input value="${p.name}" onchange="project.perfs[${i}].name=this.value" style="width:150px"></td>
        <td><input type="number" value="${p.score}" onchange="project.perfs[${i}].score=Number(this.value)" style="width:80px"></td>
        <td><input type="number" value="${p.ratio}" onchange="project.perfs[${i}].ratio=Number(this.value);renderSetup()" style="width:80px"></td>
        <td><button class="btn btn-danger btn-sm" onclick="removePerf(${i})">ì‚­ì œ</button></td></tr>`;
            }).join('');
            const total = pSum + fSum;
            document.getElementById('paperRatioTotal').textContent = pSum + '%';
            document.getElementById('paperRatioTotal').className = pSum > 0 ? 'ratio-ok' : 'ratio-warn';
            document.getElementById('perfRatioTotal').textContent = fSum + '%';
            document.getElementById('perfRatioTotal').className = fSum > 0 ? 'ratio-ok' : 'ratio-warn';
            document.getElementById('totalRatio').textContent = total + '%';
        }

        // === ì§€í•„í‰ê°€ íƒ­ ===
        function renderPaperTab() {
            document.getElementById('paperSubTabs').innerHTML = project.papers.map((p, i) =>
                `<div class="sub-tab ${i === currentPaperIdx ? 'active' : ''} ${p.excelData.length > 0 ? 'completed' : ''}" onclick="currentPaperIdx=${i};renderPaperTab()">${p.name}</div>`
            ).join('');
            renderPaperContent();
        }

        function renderPaperContent() {
            const paper = project.papers[currentPaperIdx];
            const fileName = paper.fileName || 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
            let html = `<div class="section-box"><div class="section-title">ğŸ“ ë¬¸í•­ì •ë³´í‘œ ì—…ë¡œë“œ</div>
        <input type="file" id="fileInput_${currentPaperIdx}" accept=".xlsx,.xls" onchange="handleExcelUpload(event,${currentPaperIdx})" style="display:none">
        <div style="display:flex;align-items:center;gap:10px;">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput_${currentPaperIdx}').click()">íŒŒì¼ ì„ íƒ</button>
            <span id="fileName_${currentPaperIdx}" style="color:#64748b;">${fileName}</span>
        </div>
        <p style="font-size:0.85rem;color:#64748b;margin-top:5px;">* ë‚˜ì´ìŠ¤ ì–‘ì‹ì˜ ë¬¸í•­ì •ë³´í‘œ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p></div>`;

            if (paper.excelData.length > 0) {
                // ë¬¸í•­ì •ë³´í‘œ ìƒì„¸ í…Œì´ë¸”
                const selCount = paper.excelData.filter(d => d.type === 'ì„ íƒí˜•').length;
                const subCount = paper.excelData.filter(d => d.type === 'ì„œë‹µí˜•').length;
                const totalScore = paper.excelData.reduce((s, d) => s + d.score, 0);

                html += `<div class="section-box" style="background:#f8fafc;">
                    <div class="section-title" style="border-color:#22c55e;">âœ… ë¬¸í•­ì •ë³´í‘œ ë°ì´í„°</div>
                    <div style="margin-bottom:10px;padding:10px;background:#f0fdf4;border-radius:6px;border:1px solid #bbf7d0;">
                        <span style="font-size:1.1rem;font-weight:bold;color:#15803d;">ì´ ${paper.excelData.length}ë¬¸í•­ ë¡œë“œ ì™„ë£Œ</span>
                        <span style="font-size:0.9rem;color:#334155;margin-left:10px;">(ì„ íƒí˜•: <b>${selCount}</b> / ì„œë‹µí˜•: <b>${subCount}</b> / ì´ë°°ì : <b>${totalScore.toFixed(1)}</b>ì )</span>
                    </div>
                    <div style="font-size:0.85rem;color:#64748b;margin-bottom:5px;">ì „ì²´ ë¬¸í•­ ë¦¬ìŠ¤íŠ¸ (ìŠ¤í¬ë¡¤í•˜ì—¬ í™•ì¸):</div>
                    <div style="max-height:250px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;">
                        <table style="font-size:0.85rem;background:white;">
                            <thead style="position:sticky;top:0;background:#f1f5f9;z-index:1;">
                                <tr><th style="padding:8px;border-bottom:2px solid #cbd5e1;width:50px;">ë²ˆí˜¸</th>
                                <th style="padding:8px;border-bottom:2px solid #cbd5e1;">ë¬¸í•­ìœ í˜•</th>
                                <th style="padding:8px;border-bottom:2px solid #cbd5e1;">ë‚œì´ë„</th>
                                <th style="padding:8px;border-bottom:2px solid #cbd5e1;">ë°°ì </th></tr>
                            </thead>
                            <tbody>
                                ${paper.excelData.map((item, idx) => `
                                    <tr style="border-bottom:1px solid #f1f5f9;background:${item.type === 'ì„œë‹µí˜•' ? '#fff7ed' : 'white'};">
                                        <td style="padding:6px;text-align:center;color:#64748b;">${idx + 1}</td>
                                        <td style="padding:6px;text-align:center;font-weight:${item.type === 'ì„œë‹µí˜•' ? 'bold' : 'normal'};color:${item.type === 'ì„œë‹µí˜•' ? '#d97706' : 'inherit'}">${item.type}</td>
                                        <td style="padding:6px;text-align:center;">${item.difficulty}</td>
                                        <td style="padding:6px;text-align:center;">${item.score}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;

                html += `<div class="section-box"><div class="section-title">ğŸ‘¥ êµì‚¬ ì„ íƒ</div>
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
                <select id="currentTeacher" onchange="loadTeacherInput()" style="min-width:150px;"><option value="">êµì‚¬ ì„ íƒ</option>${project.teachers.map(t => `<option value="${t}">${t}</option>`).join('')}</select>
                <span id="currentTeacherLabel" style="color:var(--primary);font-weight:bold;"></span>
            </div></div>`;

                html += `<div class="section-box"><div class="section-title">ğŸ“ ìµœì†ŒëŠ¥ë ¥ì ì˜ˆìƒì •ë‹µë¥  ì…ë ¥</div>
            <div style="display:flex;gap:15px;align-items:center;margin-bottom:15px;flex-wrap:wrap;">
                <div style="display:flex;gap:15px;align-items:center;background:#f1f5f9;padding:8px 15px;border-radius:8px;">
                    <span style="font-weight:bold;color:#334155;">ì„±ì·¨ìˆ˜ì¤€:</span>
                    <label style="cursor:pointer;"><input type="radio" name="scoreMode" value="5" ${paper.scoreMode === 5 ? 'checked' : ''} onchange="changeScoreMode(5)"> 5ìˆ˜ì¤€(A-E)+ë¯¸ì´ìˆ˜(I)</label>
                    <label style="cursor:pointer;"><input type="radio" name="scoreMode" value="4" ${paper.scoreMode === 4 ? 'checked' : ''} onchange="changeScoreMode(4)"> 5ìˆ˜ì¤€(A-E)</label>
                </div>
            </div>
            <div id="roundTabsContainer"></div>
            <div id="inputTableContainer"></div>
            <div id="inputButtons" style="display:none;text-align:right;margin-top:15px;">
                <button class="btn btn-primary" onclick="exportTeacherInputToExcel()" style="float:left;">ğŸ“¥ ì…ë ¥ê°’ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-dark" onclick="saveTeacherData()">ğŸ’¾ ì„ì‹œ ì €ì¥</button>
                <button class="btn btn-success" onclick="finalizeRound()">âœ… ì…ë ¥ë§ˆê°</button>
                <button class="btn btn-danger" onclick="openCancelModal()">ğŸ”“ ì…ë ¥ë§ˆê° ì·¨ì†Œ</button>
            </div></div>`;
                html += `<div class="section-box"><div class="section-title">ğŸ“‹ ì¡°íšŒ</div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:15px;">
                <label style="font-weight:bold;">ë¼ìš´ë“œ ì„ íƒ:</label>
                <select id="viewRoundSelect" onchange="refreshViewByRound()" style="min-width:120px;">
                    ${(() => {
                        let opts = '';
                        const maxRounds = Math.max(...project.teachers.map(t => paper.teacherData[t]?.rounds?.length || 0));
                        for (let r = 0; r < maxRounds; r++) {
                            opts += `<option value="${r}" ${r === paper.currentRound ? 'selected' : ''}>${r + 1}ë¼ìš´ë“œ</option>`;
                        }
                        return opts || '<option value="0">1ë¼ìš´ë“œ</option>';
                    })()}
                </select>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="showTeacherView()">êµì‚¬ë³„ì…ë ¥ì •ë³´ì¡°íšŒ</button>
                <button class="btn btn-primary" onclick="showCategoryView()">ë¬¸í•­ë²”ì£¼ë³„ì¡°íšŒ</button>
                <button class="btn btn-primary" onclick="showFinalView()">ì˜ˆìƒì¶”ì •ë¶„í• ì ìˆ˜ì¡°íšŒ</button>
                <button class="btn btn-success" style="font-weight:bold;" onclick="openResultModal()">ğŸ“Š ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œê²°ê³¼</button>
            </div>

            <div id="viewContainer" style="margin-top:15px;"></div></div>`;
            }
            document.getElementById('paperContent').innerHTML = html;
        }

        // === ì—‘ì…€ íŒŒì‹± ===
        function handleExcelUpload(event, paperIdx) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const ws = workbook.Sheets[workbook.SheetNames[0]];
                const raw = XLSX.utils.sheet_to_json(ws, { header: 1 });

                let headerRow = -1, scoreIdx = -1;
                for (let i = 0; i < Math.min(raw.length, 30); i++) {
                    const row = raw[i];
                    if (!row) continue;
                    const str = row.map(c => String(c).replace(/\s/g, '')).join(' ');
                    if (str.includes('ë°°ì ') && str.includes('ë¬¸í•­ë²ˆí˜¸')) {
                        headerRow = i;
                        scoreIdx = row.findIndex(c => String(c).trim() === 'ë°°ì ');
                        break;
                    }
                }
                if (headerRow < 0) { alert('ì–‘ì‹ ì¸ì‹ ì‹¤íŒ¨'); return; }

                let hardIdx = -1, midIdx = -1, easyIdx = -1;
                for (let r = headerRow; r <= headerRow + 1; r++) {
                    const row = raw[r]; if (!row) continue;
                    row.forEach((c, idx) => {
                        const v = String(c).trim().replace(/\s/g, '');
                        if (v === 'ì–´ë ¤ì›€') hardIdx = idx;
                        else if (v === 'ë³´í†µ') midIdx = idx;
                        else if (v === 'ì‰¬ì›€') easyIdx = idx;
                    });
                }
                if (hardIdx < 0) { alert('ë‚œì´ë„ ì—´ ì°¾ê¸° ì‹¤íŒ¨'); return; }

                const excelData = [];
                let currentType = '';
                for (let i = headerRow + 2; i < raw.length; i++) {
                    const row = raw[i]; if (!row) continue;
                    const txt = row.map(c => String(c)).join('');
                    if (txt.includes('ì„ íƒí˜•')) { currentType = 'ì„ íƒí˜•'; continue; }
                    if (txt.includes('ì„œë‹µí˜•')) { currentType = 'ì„œë‹µí˜•'; continue; }
                    const sc = row[scoreIdx];
                    if (sc === undefined || sc === '' || isNaN(sc)) continue;
                    let diff = '';
                    if (String(row[hardIdx] || '').includes('O') || String(row[hardIdx] || '').includes('â—‹')) diff = 'ì–´ë ¤ì›€';
                    else if (String(row[midIdx] || '').includes('O') || String(row[midIdx] || '').includes('â—‹')) diff = 'ë³´í†µ';
                    else if (String(row[easyIdx] || '').includes('O') || String(row[easyIdx] || '').includes('â—‹')) diff = 'ì‰¬ì›€';
                    else continue;
                    excelData.push({ type: currentType || 'ì„ íƒí˜•', difficulty: diff, score: parseFloat(sc) });
                }
                if (excelData.length === 0) { alert('ë¬¸í•­ ì¸ì‹ ì‹¤íŒ¨'); return; }

                project.papers[paperIdx].excelData = excelData;
                project.papers[paperIdx].fileName = file.name;
                processCategories(paperIdx);
                project.teachers.forEach(t => {
                    if (!project.papers[paperIdx].teacherData[t]) {
                        project.papers[paperIdx].teacherData[t] = { rounds: [[]], completedRounds: [] };
                    }
                });
                renderPaperTab();
            };
            reader.readAsArrayBuffer(file);
        }

        function processCategories(paperIdx) {
            const paper = project.papers[paperIdx];
            const catMap = new Map();
            paper.excelData.forEach(item => {
                const key = `${item.type}|${item.difficulty}`;
                if (!catMap.has(key)) catMap.set(key, { type: item.type, difficulty: item.difficulty, count: 0, totalScore: 0 });
                const cat = catMap.get(key);
                cat.count++; cat.totalScore += item.score;
            });
            const cats = Array.from(catMap.values());
            const order = { 'ì‰¬ì›€': 1, 'ë³´í†µ': 2, 'ì–´ë ¤ì›€': 3 };
            cats.sort((a, b) => { if (a.type !== b.type) return a.type === 'ì„ íƒí˜•' ? -1 : 1; return (order[a.difficulty] || 9) - (order[b.difficulty] || 9); });
            paper.categories = cats;
        }

        // === êµì‚¬ ì…ë ¥ ===
        function loadTeacherInput() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) { document.getElementById('roundTabsContainer').innerHTML = ''; document.getElementById('inputTableContainer').innerHTML = ''; document.getElementById('inputButtons').style.display = 'none'; return; }
            document.getElementById('currentTeacherLabel').textContent = `- ${name} ì„ ìƒë‹˜`;
            document.getElementById('inputButtons').style.display = 'block';
            renderRoundTabs();
            renderInputTable();
        }

        function renderRoundTabs() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) return;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            if (!td) return;
            let html = '';
            for (let i = 0; i < td.rounds.length; i++) {
                const done = td.completedRounds.includes(i);
                const isActive = i === paper.currentRound;
                html += `<button class="round-tab ${isActive ? 'active' : ''}" onclick="switchRound(${i})">${i + 1}ë¼ìš´ë“œ${done ? ' âœ“' : ''}</button>`;
            }
            html += `<button class="round-tab add-btn" onclick="addRound()">+ ì¶”ê°€</button>`;
            if (td.rounds.length > 1) {
                html += `<button class="round-tab" style="background:#fee2e2;color:#dc2626;border-color:#fca5a5;margin-left:auto;" onclick="deleteRound()">ğŸ—‘ï¸ ì‚­ì œ</button>`;
            }
            document.getElementById('roundTabsContainer').innerHTML = `<div class="round-tabs" style="display:flex;gap:8px;flex-wrap:wrap;">${html}</div>`;
        }

        function switchRound(idx) { project.papers[currentPaperIdx].currentRound = idx; renderRoundTabs(); renderInputTable(); }
        function addRound() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) { alert('êµì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];

            // ëª¨ë“  êµì‚¬ì—ê²Œ ìƒˆ ë¼ìš´ë“œ ì¶”ê°€ (í˜„ì¬ êµì‚¬ë§Œ ì¶”ê°€í•˜ë©´ ë™ê¸°í™” ë¬¸ì œ ë°œìƒ)
            const useCopy = confirm('ì´ì „ ë¼ìš´ë“œ ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì—¬ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n[í™•ì¸]: ë³µì‚¬í•¨ / [ì·¨ì†Œ]: ë¹ˆ ê°’ìœ¼ë¡œ ì‹œì‘');

            project.teachers.forEach(t => {
                const teacherData = paper.teacherData[t];
                if (!teacherData) return;

                let newRoundData;
                if (useCopy && teacherData.rounds.length > 0) {
                    // ì´ì „ ë¼ìš´ë“œ ë°ì´í„° ë³µì‚¬
                    const prevRound = teacherData.rounds[teacherData.rounds.length - 1];
                    newRoundData = JSON.parse(JSON.stringify(prevRound));
                } else {
                    // ë¹ˆ ê°’ìœ¼ë¡œ ì‹œì‘
                    newRoundData = paper.categories.map(() => Array(5).fill(null));
                }
                teacherData.rounds.push(newRoundData);
            });

            paper.currentRound = td.rounds.length - 1;
            renderRoundTabs(); renderInputTable();
            renderViewRoundSelect();
        }

        function deleteRound() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) return;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];

            if (td.rounds.length <= 1) {
                alert('ìµœì†Œ 1ê°œì˜ ë¼ìš´ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const roundToDelete = paper.currentRound;
            if (!confirm(`${roundToDelete + 1}ë¼ìš´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ ë¼ìš´ë“œì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

            // ëª¨ë“  êµì‚¬ì˜ í•´ë‹¹ ë¼ìš´ë“œ ì‚­ì œ
            project.teachers.forEach(t => {
                const teacherData = paper.teacherData[t];
                if (!teacherData) return;
                if (teacherData.rounds.length > roundToDelete) {
                    teacherData.rounds.splice(roundToDelete, 1);
                }
                // completedRounds ì—…ë°ì´íŠ¸
                const compIdx = teacherData.completedRounds.indexOf(roundToDelete);
                if (compIdx > -1) teacherData.completedRounds.splice(compIdx, 1);
                // ì¸ë±ìŠ¤ ì¡°ì •
                teacherData.completedRounds = teacherData.completedRounds.map(r => r > roundToDelete ? r - 1 : r);
            });

            // í˜„ì¬ ë¼ìš´ë“œ ì¡°ì •
            if (paper.currentRound >= td.rounds.length) {
                paper.currentRound = Math.max(0, td.rounds.length - 1);
            }

            alert('ë¼ìš´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            renderRoundTabs(); renderInputTable();
            renderViewRoundSelect();
        }

        function renderInputTable() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) return;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const round = paper.currentRound;
            const isCompleted = td.completedRounds.includes(round);
            const cats = paper.categories;
            const mode = paper.scoreMode || 5;
            const colCount = mode;

            if (!td.rounds[round]) td.rounds[round] = [];
            while (td.rounds[round].length < cats.length) td.rounds[round].push(Array(5).fill(null));

            // í—¤ë” ìƒì„± (4ë‹¨ê³„ vs 5ë‹¨ê³„)
            const headers4 = ['A/B(%)', 'B/C(%)', 'C/D(%)', 'D/E(%)'];
            const headers5 = ['A/B(%)', 'B/C(%)', 'C/D(%)', 'D/E(%)', 'E/ë¯¸ë„ë‹¬(%)'];
            const headers = mode === 5 ? headers5 : headers4;

            let html = `<table><thead><tr><th>ìœ í˜•</th><th>ë‚œì´ë„</th><th>ë¬¸í•­ìˆ˜</th><th>ë°°ì í•©</th>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
            cats.forEach((cat, ci) => {
                const vals = td.rounds[round][ci] || Array(5).fill(null);
                html += `<tr><td>${cat.type}</td><td>${cat.difficulty}</td><td>${cat.count}</td><td>${cat.totalScore.toFixed(1)}</td>`;
                for (let i = 0; i < colCount; i++) {
                    const v = vals[i] !== null ? vals[i] : '';
                    const dis = isCompleted ? 'disabled' : '';
                    // ë§ˆì§€ë§‰ ì»¬ëŸ¼(5ë‹¨ê³„ì˜ E/ë¯¸ë„ë‹¬)ë§Œ 1% ë‹¨ìœ„ ì…ë ¥, ë‚˜ë¨¸ì§€ëŠ” 5% ë‹¨ìœ„ select
                    if (mode === 5 && i === 4) {
                        html += `<td><input type="number" class="inp-rate" data-cat="${ci}" data-idx="${i}" value="${v}" min="20" max="100" step="1" style="width:60px" oninput="validateInputs()" ${dis}></td>`;
                    } else {
                        html += `<td><select class="inp-rate" data-cat="${ci}" data-idx="${i}" onchange="validateInputs()" ${dis}><option value="">ì„ íƒ</option>`;
                        for (let o = 0; o <= 100; o += 5) html += `<option value="${o}" ${v === o ? 'selected' : ''}>${o}</option>`;
                        html += `</select></td>`;
                    }
                }
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('inputTableContainer').innerHTML = html;
        }

        function changeScoreMode(mode) {
            project.papers[currentPaperIdx].scoreMode = mode;
            renderInputTable();
        }

        function validateInputs() {
            const inputs = document.querySelectorAll('.inp-rate');
            let valid = true;
            inputs.forEach(inp => { inp.classList.remove('invalid-input', 'warning-diff'); });

            const paper = project.papers[currentPaperIdx];
            const mode = paper.scoreMode || 5;
            const cats = paper.categories;

            // 1. Row check: ìƒìœ„ìˆ˜ì¤€ >= í•˜ìœ„ìˆ˜ì¤€ + 20% ì°¨ì´ ê²½ê³ 
            cats.forEach((cat, ci) => {
                for (let c = 0; c < mode - 1; c++) {
                    const left = document.querySelector(`.inp-rate[data-cat="${ci}"][data-idx="${c}"]`);
                    const right = document.querySelector(`.inp-rate[data-cat="${ci}"][data-idx="${c + 1}"]`);
                    if (left && right && left.value !== '' && right.value !== '') {
                        const leftVal = parseFloat(left.value);
                        const rightVal = parseFloat(right.value);
                        // ìƒìœ„ < í•˜ìœ„ì´ë©´ ì˜¤ë¥˜
                        if (leftVal < rightVal) {
                            left.classList.add('invalid-input');
                            right.classList.add('invalid-input');
                            valid = false;
                        }
                        // ì°¨ì´ê°€ 20% ì´ìƒì´ë©´ ê²½ê³  (ì°¨í•˜ìœ„ì— í‘œì‹œ)
                        if (leftVal - rightVal >= 20) {
                            right.classList.add('warning-diff');
                        }
                    }
                }
            });

            // 2. Column check: ë‚œì´ë„ë³„ (ì‰¬ì›€ >= ë³´í†µ >= ì–´ë ¤ì›€) - ê°™ì€ ìœ í˜• ë‚´
            const types = ['ì„ íƒí˜•', 'ì„œë‹µí˜•'];
            const diffOrder = ['ì‰¬ì›€', 'ë³´í†µ', 'ì–´ë ¤ì›€'];

            for (let c = 0; c < mode; c++) {
                types.forEach(type => {
                    // í•´ë‹¹ ìœ í˜•ì˜ ë‚œì´ë„ë³„ í–‰ ì¸ë±ìŠ¤ ì°¾ê¸°
                    const catIndices = {};
                    cats.forEach((cat, idx) => {
                        if (cat.type === type) catIndices[cat.difficulty] = idx;
                    });

                    // ì‰¬ì›€ >= ë³´í†µ, ë³´í†µ >= ì–´ë ¤ì›€ ë¹„êµ
                    const comparePairs = [['ì‰¬ì›€', 'ë³´í†µ'], ['ë³´í†µ', 'ì–´ë ¤ì›€'], ['ì‰¬ì›€', 'ì–´ë ¤ì›€']];
                    comparePairs.forEach(([easy, hard]) => {
                        if (catIndices[easy] !== undefined && catIndices[hard] !== undefined) {
                            const easyInp = document.querySelector(`.inp-rate[data-cat="${catIndices[easy]}"][data-idx="${c}"]`);
                            const hardInp = document.querySelector(`.inp-rate[data-cat="${catIndices[hard]}"][data-idx="${c}"]`);
                            if (easyInp && hardInp && easyInp.value !== '' && hardInp.value !== '') {
                                if (parseFloat(easyInp.value) < parseFloat(hardInp.value)) {
                                    easyInp.classList.add('invalid-input');
                                    hardInp.classList.add('invalid-input');
                                    valid = false;
                                }
                            }
                        }
                    });
                });
            }

            return valid;
        }

        function saveTeacherData() {
            if (!validateInputs()) { alert('ì…ë ¥ê°’ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.'); return; }
            const name = document.getElementById('currentTeacher').value;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const round = paper.currentRound;
            const inputs = document.querySelectorAll('.inp-rate');
            let complete = true;
            inputs.forEach(inp => {
                const ci = parseInt(inp.dataset.cat), vi = parseInt(inp.dataset.idx);
                const v = inp.value;
                td.rounds[round][ci][vi] = v === '' ? null : parseFloat(v);
                if (v === '') complete = false;
            });
            if (!complete) { alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function finalizeRound() {
            if (!validateInputs()) { alert('ì…ë ¥ê°’ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.'); return; }
            const name = document.getElementById('currentTeacher').value;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const round = paper.currentRound;
            if (td.completedRounds.includes(round)) { alert('ì´ë¯¸ ë§ˆê°ë¨'); return; }
            saveTeacherData();
            if (!confirm(`${name} ì„ ìƒë‹˜ì˜ ${round + 1}ë¼ìš´ë“œë¥¼ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            td.completedRounds.push(round);
            alert('ë§ˆê° ì™„ë£Œ');
            renderRoundTabs(); renderInputTable();
            renderViewRoundSelect();
        }

        function openCancelModal() { document.getElementById('cancelModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function confirmCancelFinalize() {
            const reason = document.querySelector('input[name="cancelReason"]:checked');
            if (!reason) { alert('ì‚¬ìœ  ì„ íƒ í•„ìš”'); return; }
            const name = document.getElementById('currentTeacher').value;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const round = paper.currentRound;
            const idx = td.completedRounds.indexOf(round);
            if (idx > -1) td.completedRounds.splice(idx, 1);
            alert('ë§ˆê° ì·¨ì†Œë¨');
            closeModal('cancelModal');
            renderRoundTabs(); renderInputTable();
            renderViewRoundSelect();
        }

        // === ì¡°íšŒ ê¸°ëŠ¥ ===
        function showTeacherView() {
            const paper = project.papers[currentPaperIdx];
            const cats = paper.categories;
            const mode = paper.scoreMode || 5;
            const headers = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E'] : ['A/B', 'B/C', 'C/D', 'D/E'];
            const viewRound = document.getElementById('viewRoundSelect')?.value ?? paper.currentRound;
            const roundIdx = parseInt(viewRound);

            let html = '<div class="info-box" style="background:#fef3c7;border-color:#fcd34d;color:#92400e;margin-bottom:15px;">âš ï¸ <strong>ì ìƒ‰ í‘œì‹œ</strong>: ë™ì¼ ë¬¸í•­ë²”ì£¼ ë‚´ êµì‚¬ê°„ ì •ë‹µë¥  ì°¨ì´ê°€ 20% ì´ìƒì¸ ê²½ìš°ì…ë‹ˆë‹¤.</div>';
            html += `<h4>ğŸ“‹ êµì‚¬ë³„ ì…ë ¥ì •ë³´ (${roundIdx + 1}ë¼ìš´ë“œ)</h4><table><thead><tr><th>ìœ í˜•</th><th>ë‚œì´ë„</th><th>êµì‚¬</th>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;

            cats.forEach((cat, ci) => {
                // ê° ì»¬ëŸ¼ë³„ ëª¨ë“  êµì‚¬ì˜ ê°’ ìˆ˜ì§‘
                const colValues = [];
                for (let c = 0; c < mode; c++) colValues.push([]);

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td || !td.rounds[roundIdx] || !td.rounds[roundIdx][ci]) return;
                    const vals = td.rounds[roundIdx][ci];
                    for (let c = 0; c < mode; c++) {
                        if (vals[c] !== null && vals[c] !== undefined) {
                            colValues[c].push(parseFloat(vals[c]));
                        }
                    }
                });

                // ìµœëŒ€-ìµœì†Œ ì°¨ì´ ê³„ì‚°í•˜ì—¬ 20 ì´ìƒì´ë©´ í”Œë˜ê·¸
                const diffFlags = colValues.map(arr => {
                    if (arr.length < 2) return false;
                    return (Math.max(...arr) - Math.min(...arr)) >= 20;
                });

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td) return;
                    const vals = td.rounds[roundIdx] && td.rounds[roundIdx][ci] ? td.rounds[roundIdx][ci] : Array(mode).fill('-');
                    html += `<tr><td>${cat.type}</td><td>${cat.difficulty}</td><td>${t}</td>`;
                    for (let c = 0; c < mode; c++) {
                        const v = vals[c] !== null && vals[c] !== undefined ? vals[c] : '-';
                        const cellClass = diffFlags[c] ? 'diff-alert' : '';
                        html += `<td class="${cellClass}">${v}</td>`;
                    }
                    html += '</tr>';
                });
            });
            html += '</tbody></table>';
            document.getElementById('viewContainer').innerHTML = html;
        }

        function showCategoryView() {
            const paper = project.papers[currentPaperIdx];
            const cats = paper.categories;
            const viewRound = document.getElementById('viewRoundSelect')?.value ?? paper.currentRound;
            const roundIdx = parseInt(viewRound);
            const mode = paper.scoreMode || 5;
            const levels = mode === 5 ? ['A', 'B', 'C', 'D', 'E'] : ['A', 'B', 'C', 'D'];

            let html = `<h4>ğŸ“Š ë¬¸í•­ ë²”ì£¼ë³„ ìƒì„¸ í†µê³„ (${roundIdx + 1}ë¼ìš´ë“œ)</h4>`;
            html += '<div style="overflow-x:auto;"><table><thead><tr><th rowspan="2">ë¬¸í•­ìœ í˜•</th><th rowspan="2">ë‚œì´ë„</th>';
            levels.forEach(lv => {
                html += `<th colspan="4" style="text-align:center;background:#e0f2fe;">${lv}</th>`;
            });
            html += '</tr><tr>';
            levels.forEach(() => {
                html += '<th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th><th>ìµœì†Ÿê°’</th><th>ìµœëŒ“ê°’</th>';
            });
            html += '</tr></thead><tbody>';

            cats.forEach((cat, ci) => {
                // ê° ë ˆë²¨ë³„ ë°ì´í„° ìˆ˜ì§‘
                const levelData = levels.map(() => []);

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td || !td.rounds[roundIdx] || !td.rounds[roundIdx][ci]) return;
                    const vals = td.rounds[roundIdx][ci];
                    for (let c = 0; c < levels.length; c++) {
                        if (vals[c] !== null && vals[c] !== undefined) {
                            levelData[c].push(parseFloat(vals[c]));
                        }
                    }
                });

                html += `<tr><td>${cat.type}</td><td>${cat.difficulty}</td>`;
                levelData.forEach(arr => {
                    if (arr.length === 0) {
                        html += '<td>-</td><td>-</td><td>-</td><td>-</td>';
                    } else {
                        const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
                        const std = Math.sqrt(arr.reduce((a, b) => a + (b - avg) ** 2, 0) / arr.length);
                        const min = Math.min(...arr);
                        const max = Math.max(...arr);
                        html += `<td>${avg.toFixed(2)}</td><td>${std.toFixed(2)}</td><td>${min.toFixed(0)}</td><td>${max.toFixed(0)}</td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            document.getElementById('viewContainer').innerHTML = html;
        }

        function showFinalView() {
            const paper = project.papers[currentPaperIdx];
            const cats = paper.categories;
            const viewRound = document.getElementById('viewRoundSelect')?.value ?? paper.currentRound;
            const roundIdx = parseInt(viewRound);
            const mode = paper.scoreMode || 5;
            const headers = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E/ë¯¸ë„ë‹¬'] : ['A/B', 'B/C', 'C/D', 'D/E'];

            // ê° êµì‚¬ë³„ë¡œ ì „ì²´ ì ìˆ˜ ê³„ì‚°
            const teacherScores = headers.map(() => []);

            project.teachers.forEach(t => {
                const td = paper.teacherData[t];
                if (!td || !td.rounds[roundIdx]) return;

                // í•´ë‹¹ ëª¨ë“œ(4/5)ì— í•„ìš”í•œ ì»¬ëŸ¼ë“¤ì´ ëª¨ë‘ ì±„ì›Œì¡ŒëŠ”ì§€ í™•ì¸
                const isComplete = td.rounds[roundIdx].length >= cats.length && td.rounds[roundIdx].every(row => {
                    if (!row) return false;
                    for (let n = 0; n < headers.length; n++) {
                        if (row[n] === null || row[n] === undefined || row[n] === '') return false;
                    }
                    return true;
                });

                if (!isComplete) return;

                const scores = headers.map(() => 0);
                cats.forEach((cat, ci) => {
                    const vals = td.rounds[roundIdx][ci];
                    for (let vi = 0; vi < headers.length; vi++) {
                        scores[vi] += cat.totalScore * (parseFloat(vals[vi]) / 100);
                    }
                });
                scores.forEach((s, i) => teacherScores[i].push(s));
            });

            let html = `<h4>ğŸ† ìµœì¢… ì˜ˆìƒ ì¶”ì •ë¶„í• ì ìˆ˜ (${roundIdx + 1}ë¼ìš´ë“œ)</h4>`;
            html += '<table><thead><tr><th>êµ¬ë¶„</th>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';

            // í‰ê· 
            html += '<tr><td style="font-weight:bold;">í‰ê· </td>';
            teacherScores.forEach(arr => {
                const avg = arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
                html += `<td style="font-weight:bold;color:#1e40af;">${avg.toFixed(2)}</td>`;
            });
            html += '</tr>';

            // í‘œì¤€í¸ì°¨
            html += '<tr><td style="font-weight:bold;">í‘œì¤€í¸ì°¨</td>';
            teacherScores.forEach(arr => {
                if (arr.length === 0) { html += '<td>-</td>'; return; }
                const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
                const std = Math.sqrt(arr.reduce((a, b) => a + (b - avg) ** 2, 0) / arr.length);
                html += `<td>${std.toFixed(2)}</td>`;
            });
            html += '</tr>';

            // ìµœì†Ÿê°’
            html += '<tr><td style="font-weight:bold;">ìµœì†Ÿê°’</td>';
            teacherScores.forEach(arr => {
                html += `<td>${arr.length > 0 ? Math.min(...arr).toFixed(2) : '-'}</td>`;
            });
            html += '</tr>';

            // ìµœëŒ“ê°’
            html += '<tr><td style="font-weight:bold;">ìµœëŒ“ê°’</td>';
            teacherScores.forEach(arr => {
                html += `<td>${arr.length > 0 ? Math.max(...arr).toFixed(2) : '-'}</td>`;
            });
            html += '</tr>';

            html += '</tbody></table>';
            document.getElementById('viewContainer').innerHTML = html;
        }

        // === ë¼ìš´ë“œë³„ ì¡°íšŒ ê¸°ëŠ¥ ===
        function refreshViewByRound() {
            const select = document.getElementById('viewRoundSelect');
            if (!select) return;
            project.papers[currentPaperIdx].currentRound = parseInt(select.value);
            // í˜„ì¬ ë³´ì´ëŠ” ë·°ê°€ ìˆìœ¼ë©´ ê°±ì‹ 
            const vc = document.getElementById('viewContainer');
            if (vc && vc.innerHTML.includes('êµì‚¬ë³„')) showTeacherView();
            else if (vc && vc.innerHTML.includes('ì˜ˆìƒ')) showFinalView();
        }

        function getViewRound() {
            const select = document.getElementById('viewRoundSelect');
            return select ? parseInt(select.value) : project.papers[currentPaperIdx].currentRound;
        }

        // === ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œê²°ê³¼ ëª¨ë‹¬ ===
        function calculateRoundResult(roundIdx) {
            const paper = project.papers[currentPaperIdx];
            const cats = paper.categories;
            const mode = paper.scoreMode || 5;
            const cols = mode === 5 ? 5 : 4;
            const sums = Array(cols).fill(0);
            let cnt = 0;

            project.teachers.forEach(t => {
                const td = paper.teacherData[t];
                if (!td || !td.rounds[roundIdx]) return;

                const isComplete = td.rounds[roundIdx].length >= cats.length && td.rounds[roundIdx].every(row => {
                    if (!row) return false;
                    for (let n = 0; n < cols; n++) {
                        if (row[n] === null || row[n] === undefined || row[n] === '') return false;
                    }
                    return true;
                });

                if (isComplete) {
                    cats.forEach((cat, ci) => {
                        const vals = td.rounds[roundIdx][ci];
                        for (let vi = 0; vi < cols; vi++) {
                            sums[vi] += cat.totalScore * (parseFloat(vals[vi]) / 100);
                        }
                    });
                    cnt++;
                }
            });
            return { avgs: sums.map(s => cnt > 0 ? (s / cnt) : 0), cnt };
        }

        function openResultModal() {
            const paper = project.papers[currentPaperIdx];
            const maxRounds = Math.max(...project.teachers.map(t => paper.teacherData[t]?.rounds?.length || 0));

            if (maxRounds === 0) {
                alert('ì…ë ¥ëœ ë¼ìš´ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let html = '<div style="overflow-x:auto;">';
            html += '<table><thead><tr><th>ë¼ìš´ë“œ</th><th>ì°¸ì—¬êµì‚¬</th><th>A/B</th><th>B/C</th><th>C/D</th><th>D/E</th><th>E/ë¯¸ë„ë‹¬</th><th>ì„ íƒ</th></tr></thead><tbody>';

            for (let r = 0; r < maxRounds; r++) {
                const result = calculateRoundResult(r);
                const isSelected = paper.selectedResultRound === r;
                html += `<tr style="${isSelected ? 'background:#dbeafe;' : ''}">
                    <td style="font-weight:bold;">${r + 1}ë¼ìš´ë“œ</td>
                    <td>${result.cnt}ëª…</td>
                    ${result.avgs.map(a => `<td style="font-weight:bold;color:#1e40af;">${a.toFixed(2)}</td>`).join('')}
                    <td><button class="btn ${isSelected ? 'btn-success' : 'btn-dark'}" onclick="selectResultRound(${r})">${isSelected ? 'âœ“ ì„ íƒë¨' : 'ì„ íƒ'}</button></td>
                </tr>`;
            }
            html += '</tbody></table></div>';

            // ì„ íƒëœ ë¼ìš´ë“œ ì •ë³´
            if (paper.selectedResultRound !== undefined) {
                const selResult = calculateRoundResult(paper.selectedResultRound);
                html += `<div class="info-box" style="margin-top:15px;background:#dcfce7;border-color:#86efac;">
                    âœ… <strong>${paper.selectedResultRound + 1}ë¼ìš´ë“œ</strong>ê°€ ìµœì¢… ê²°ê³¼ë¡œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.
                </div>`;
            }

            document.getElementById('resultModalContent').innerHTML = html;
            document.getElementById('resultModal').style.display = 'flex';
        }

        function selectResultRound(roundIdx) {
            project.papers[currentPaperIdx].selectedResultRound = roundIdx;
            openResultModal(); // ëª¨ë‹¬ ê°±ì‹ 
        }

        function exportRoundResultsToExcel() {
            const paper = project.papers[currentPaperIdx];
            const maxRounds = Math.max(...project.teachers.map(t => paper.teacherData[t]?.rounds?.length || 0));

            const data = [['ë¼ìš´ë“œ', 'ì°¸ì—¬êµì‚¬', 'A/B', 'B/C', 'C/D', 'D/E', 'E/ë¯¸ë„ë‹¬']];
            for (let r = 0; r < maxRounds; r++) {
                const result = calculateRoundResult(r);
                data.push([`${r + 1}ë¼ìš´ë“œ`, `${result.cnt}ëª…`, ...result.avgs.map(a => a.toFixed(2))]);
            }

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ì¶”ì •ë¶„í• ì ìˆ˜');

            const now = new Date();
            const filename = `ì¶”ì •ë¶„í• ì ìˆ˜_${paper.name}_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function openApprovalFromResult() {
            const paper = project.papers[currentPaperIdx];
            if (paper.selectedResultRound === undefined) {
                alert('ë¨¼ì € ìŠ¹ì¸ìš”ì²­í•  ë¼ìš´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            closeModal('resultModal');
            // ìŠ¹ì¸ìš”ì²­ ëª¨ë‹¬ ì—´ê¸°
            const select = document.getElementById('approvalRoundSelect');
            select.innerHTML = `<option value="${paper.selectedResultRound}">${paper.selectedResultRound + 1}ë¼ìš´ë“œ (ì„ íƒë¨)</option>`;
            document.getElementById('approvalModal').style.display = 'flex';
        }

        // === ì—‘ì…€ ì¶œë ¥ ê°œì„ : ëª¨ë“  ë¼ìš´ë“œ ì¶œë ¥ ===
        function exportTeacherInputToExcel() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) return;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const mode = paper.scoreMode || 5;
            const headers = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E/ë¯¸ë„ë‹¬'] : ['A/B', 'B/C', 'C/D', 'D/E'];

            const wb = XLSX.utils.book_new();
            td.rounds.forEach((roundData, rIdx) => {
                const data = [['ìœ í˜•', 'ë‚œì´ë„', ...headers]];
                paper.categories.forEach((cat, ci) => {
                    const vals = roundData[ci] || Array(mode).fill('');
                    data.push([cat.type, cat.difficulty, ...vals]);
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, `${rIdx + 1}ë¼ìš´ë“œ`);
            });
            XLSX.writeFile(wb, `ì…ë ¥ê°’_${name}_${paper.name}.xlsx`);
        }

        // === ìˆ˜í–‰í‰ê°€ íƒ­ ===
        // === ìˆ˜í–‰í‰ê°€ íƒ­ ===
        function renderPerfTab() {
            const paper = project.papers[currentPaperIdx] || project.papers[0]; // í˜„ì¬ ì„ íƒëœ ì§€í•„í‰ê°€ì˜ ëª¨ë“œ í•´í‚¹
            const mode = paper.scoreMode || 5;
            const headers = mode === 5
                ? '<tr><th>ì˜ì—­ëª…</th><th>ë°°ì </th><th>A/B(%)</th><th>B/C(%)</th><th>C/D(%)</th><th>D/E(%)</th><th>E/ë¯¸ë„ë‹¬(%)</th></tr>'
                : '<tr><th>ì˜ì—­ëª…</th><th>ë°°ì </th><th>A/B(%)</th><th>B/C(%)</th><th>C/D(%)</th><th>D/E(%)</th></tr>';

            document.getElementById('perfCutsThead').innerHTML = headers;

            const indices = mode === 5 ? [0, 1, 2, 3, 4] : [0, 1, 2, 3];

            document.getElementById('perfCutsTbody').innerHTML = project.perfs.map((p, i) =>
                `<tr><td>${p.name}</td><td>${p.score}</td>${indices.map(j =>
                    `<td><input type="number" value="${p.cuts[j]}" style="width:60px" onchange="project.perfs[${i}].cuts[${j}]=Number(this.value);calcPerfResult()"></td>`
                ).join('')}</tr>`
            ).join('');
            calcPerfResult();
        }

        function calcPerfResult() {
            const paper = project.papers[currentPaperIdx] || project.papers[0];
            const mode = paper.scoreMode || 5;
            const levels = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E/ë¯¸ë„ë‹¬'] : ['A/B', 'B/C', 'C/D', 'D/E'];

            const grid = document.getElementById('perfResultGrid');
            let html = '';
            levels.forEach((lv, i) => {
                let total = project.perfs.reduce((s, p) => s + (p.cuts[i] * p.ratio / 100), 0);
                html += `<div class="summary-card"><div style="font-weight:bold;color:#1e40af;margin-bottom:8px;">${lv}</div><div class="score-val">${total.toFixed(2)}</div></div>`;
            });
            grid.innerHTML = html;
        }

        // === ìµœì¢…ê²°ê³¼ ===
        function calculateFinal() {
            const grid = document.getElementById('finalResultGrid');
            const breakdown = document.getElementById('detailBreakdown');

            const paper = project.papers[currentPaperIdx] || project.papers[0];
            const mode = paper.scoreMode || 5;
            const levels = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E/ë¯¸ë„ë‹¬'] : ['A/B', 'B/C', 'C/D', 'D/E'];

            let paperTotals = [0, 0, 0, 0, 0], perfTotals = [0, 0, 0, 0, 0];
            let paperRows = '';

            // ì§€í•„í‰ê°€ í•©ì‚°
            project.papers.forEach(paper => {
                if (paper.categories.length === 0) {
                    paperRows += `<tr><td>${paper.name}</td><td>${paper.ratio}%</td><td colspan="5">-</td></tr>`;
                    return;
                }

                // ì„ íƒëœ ë¼ìš´ë“œê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„, ì—†ìœ¼ë©´ í˜„ì¬ ë¼ìš´ë“œë¥¼ ì‚¬ìš©
                const targetRound = paper.selectedResultRound !== undefined ? paper.selectedResultRound : paper.currentRound;

                let cnt = 0;
                const sums = [0, 0, 0, 0, 0];
                const mode = paper.scoreMode || 5;
                const cols = mode === 5 ? 5 : 4;

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td || !td.rounds[targetRound]) return;

                    const isComplete = td.rounds[targetRound].length >= paper.categories.length && td.rounds[targetRound].every(row => {
                        if (!row) return false;
                        for (let n = 0; n < cols; n++) {
                            if (row[n] === null || row[n] === undefined || row[n] === '') return false;
                        }
                        return true;
                    });

                    if (isComplete) {
                        paper.categories.forEach((cat, ci) => {
                            const vals = td.rounds[targetRound][ci];
                            for (let vi = 0; vi < cols; vi++) {
                                sums[vi] += cat.totalScore * (parseFloat(vals[vi]) / 100);
                            }
                        });
                        cnt++;
                    }
                });

                if (cnt > 0) {
                    const avgs = sums.map(s => s / cnt);
                    avgs.forEach((s, i) => paperTotals[i] += s * paper.ratio / 100);

                    paperRows += `<tr><td>${paper.name} <span style="font-size:0.8em;color:#666;">(${targetRound + 1}R)</span></td><td>${paper.ratio}%</td>`;
                    avgs.forEach((v, i) => {
                        if (mode === 4 && i === 4) paperRows += '<td>-</td>';
                        else paperRows += `<td>${v.toFixed(2)}</td>`;
                    });
                    paperRows += '</tr>';
                } else {
                    paperRows += `<tr><td>${paper.name}</td><td>${paper.ratio}%</td><td colspan="5">-</td></tr>`;
                }
            });

            // ìˆ˜í–‰í‰ê°€ í•©ì‚°
            project.perfs.forEach(p => {
                p.cuts.forEach((c, i) => {
                    // mode 4ì¼ ë•Œ E(index 4)ëŠ” í•©ì‚°í•˜ì§€ ì•ŠìŒ (0 ì²˜ë¦¬)
                    // ê° ì§€í•„í‰ê°€ ë³„ë¡œ modeê°€ ë‹¤ë¥¼ ìˆ˜ ì—†ë‹¤ê³  ê°€ì • (currentPaper ê¸°ì¤€)
                    const curPaper = project.papers[currentPaperIdx] || project.papers[0];
                    const mode = curPaper.scoreMode || 5;
                    if (mode === 4 && i === 4) return;

                    perfTotals[i] += c * p.ratio / 100;
                });
            });

            const finals = paperTotals.map((p, i) => p + perfTotals[i]);

            grid.innerHTML = levels.map((lv, i) =>
                `<div class="summary-card"><div style="font-weight:bold;color:#1e40af;margin-bottom:10px;">${lv}</div><div class="score-val">${finals[i].toFixed(2)}</div><div style="font-size:0.85rem;color:#64748b;">ì§€í•„ ${paperTotals[i].toFixed(1)} + ìˆ˜í–‰ ${perfTotals[i].toFixed(1)}</div></div>`
            ).join('');

            let bhtml = '<table><thead><tr><th>êµ¬ë¶„</th><th>ë¹„ìœ¨</th>' + levels.map(l => `<th>${l}</th>`).join('') + '</tr></thead><tbody>';
            bhtml += paperRows;
            bhtml += `<tr style="background:#f0f9ff;"><td><strong>ì§€í•„ ì†Œê³„</strong></td><td><strong>${project.papers.reduce((s, p) => s + p.ratio, 0)}%</strong></td>${paperTotals.slice(0, levels.length).map(t => `<td><strong>${t.toFixed(2)}</strong></td>`).join('')}</tr>`;
            project.perfs.forEach(p => { bhtml += `<tr><td>${p.name}</td><td>${p.ratio}%</td>${p.cuts.slice(0, levels.length).map((c, i) => `<td>${(c * p.ratio / 100).toFixed(2)}</td>`).join('')}</tr>`; });
            bhtml += `<tr style="background:#f0f9ff;"><td><strong>ìˆ˜í–‰ ì†Œê³„</strong></td><td><strong>${project.perfs.reduce((s, p) => s + p.ratio, 0)}%</strong></td>${perfTotals.slice(0, levels.length).map(t => `<td><strong>${t.toFixed(2)}</strong></td>`).join('')}</tr>`;
            bhtml += `<tr style="background:#dbeafe;font-size:1.1rem;"><td><strong>ğŸ† ìµœì¢…</strong></td><td><strong>100%</strong></td>${finals.slice(0, levels.length).map(f => `<td><strong>${f.toFixed(2)}</strong></td>`).join('')}</tr></tbody></table>`;
            breakdown.innerHTML = bhtml;
        }

        // === ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ===
        function saveFullProject() {
            project.info.year = document.getElementById('year').value;
            project.info.semester = document.getElementById('semester').value;
            project.info.subject = document.getElementById('subject').value;
            const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            a.download = `ë‚˜ì´ìŠ¤ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ(${year}-${month}-${day}_${hours}${minutes}).json`;
            a.click();
        }

        function loadFullProject(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (ev) {
                try {
                    project = JSON.parse(ev.target.result);
                    document.getElementById('year').value = project.info?.year || '2026';
                    document.getElementById('semester').value = project.info?.semester || '1í•™ê¸°';
                    document.getElementById('subject').value = project.info?.subject || '';
                    if (project.accessGranted) switchTab(1);
                    else switchTab(0);
                    alert('âœ… ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
                } catch (err) { alert('íŒŒì¼ ì˜¤ë¥˜'); }
            };
            reader.readAsText(file);
        }

        function exportFinalReport() { calculateFinal(); saveFullProject(); }

        // ì´ˆê¸°í™”
        window.onload = function () { switchTab(0); };
    </script>
</body>

>>>>>>> 16918eef3209c620f17611851a6d2b2e2f3fa282
</html>