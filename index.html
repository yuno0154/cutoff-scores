<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학기말 통합 추정분할점수 산출 시스템</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --border: #cbd5e1;
            --danger: #ef4444;
            --success: #22c55e;
            --dark: #1e293b;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 20px;
            color: #1e293b;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .tabs {
            display: flex;
            background: #334155;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 20px;
            color: #cbd5e1;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.95rem;
            white-space: nowrap;
            transition: 0.2s;
        }

        .tab:hover {
            color: #fbbf24;
            background: #475569;
        }

        .tab.active {
            color: #1e293b;
            background: #fbbf24;
            font-weight: bold;
            border-bottom: 3px solid #60a5fa;
        }

        .content {
            padding: 25px;
            display: none;
            min-height: 500px;
        }

        .content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .section-box {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fff;
        }

        .section-title {
            font-weight: bold;
            font-size: 1.05rem;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            padding-left: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        th,
        td {
            border: 1px solid var(--border);
            padding: 10px;
            text-align: center;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
        }

        input,
        select {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            text-align: center;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            border: none;
            color: white;
            transition: 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-dark {
            background: var(--dark);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .grid-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .info-box {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            color: #0369a1;
            font-size: 0.9rem;
        }

        .warning-box {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            color: #92400e;
        }

        .summary-card {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #bfdbfe;
            text-align: center;
        }

        .score-val {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .ratio-ok {
            background: #dcfce7;
            color: #166534;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .ratio-warn {
            background: #fef9c3;
            color: #854d0e;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .ratio-error {
            background: #fee2e2;
            color: #991b1b;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .sub-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .sub-tab {
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .sub-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .sub-tab.completed {
            background: #dcfce7;
            color: #166534;
            border-color: #86efac;
        }

        .invalid-input {
            background: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #dc2626 !important;
        }

        .warning-diff {
            background: #fef3c7 !important;
            border-color: #f59e0b !important;
        }

        .diff-alert {
            color: #dc2626;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        .radio-label input {
            margin-right: 10px;
        }

        .teacher-control {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .round-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .round-tab {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: bold;
            color: #64748b;
        }

        .round-tab.active {
            background: white;
            color: var(--primary);
            border-color: var(--primary);
        }

        .round-tab.add-btn {
            background: #ecfdf5;
            color: #059669;
            border-color: #a7f3d0;
        }

        .badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div>
                <h1>📊 나이스 추정분할점수 산출 실습( ver 1.0)</h1>
                <div style="font-size:0.85rem;opacity:0.8;margin-top:5px;">만든이 : 사곡고 수석교사 최연호</div>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="btn btn-success" onclick="saveFullProject()">💾 전체 저장</button>
                <button class="btn btn-dark" onclick="document.getElementById('fullLoad').click()">📂 불러오기</button>
                <input type="file" id="fullLoad" style="display:none" accept=".json" onchange="loadFullProject(event)">
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">1. 평가구조</button>
            <button class="tab" onclick="switchTab(1)">2. 지필평가 추정분할점수 산출</button>
            <button class="tab" onclick="switchTab(2)">3. 수행평가 추정분할점수 산출</button>
            <button class="tab" onclick="switchTab(3)">4. 학기말 추정분할점수 산출</button>
        </div>

        <!-- 탭 0: 평가구조 설정 -->
        <div id="tab-0" class="content active">
            <div class="section-box">
                <div class="section-title">📝 기본 정보</div>
                <div class="grid-3">
                    <div><label>학년도</label><select id="year" style="width:100%">
                            <option>2026</option>
                            <option>2025</option>
                        </select></div>
                    <div><label>학기</label><select id="semester" style="width:100%">
                            <option>1학기</option>
                            <option>2학기</option>
                        </select></div>
                    <div><label>과목명</label><input type="text" id="subject" style="width:100%" placeholder="예: 물리학Ⅰ">
                    </div>
                </div>
            </div>

            <div class="section-box">
                <div class="section-title">👥 교사 등록 <span class="badge" id="teacherCount">0명</span></div>
                <div class="teacher-control">
                    <input type="text" id="newTeacherName" placeholder="교사명 입력"
                        onkeypress="if(event.key==='Enter')addTeacher()">
                    <button class="btn btn-primary btn-sm" onclick="addTeacher()">+ 추가</button>
                </div>
                <div id="teacherList" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
            </div>

            <div class="section-box">
                <div class="section-title">📋 지필평가 구성 <span>합계: <span id="paperRatioTotal"
                            class="ratio-warn">0%</span></span>
                    <button class="btn btn-primary btn-sm" onclick="addPaper()">+ 추가</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>구분</th>
                            <th>배점</th>
                            <th>반영비율(%)</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="paperTbody"></tbody>
                </table>
            </div>

            <div class="section-box">
                <div class="section-title">📋 수행평가 구성 <span>합계: <span id="perfRatioTotal"
                            class="ratio-warn">0%</span></span>
                    <button class="btn btn-primary btn-sm" onclick="addPerf()">+ 추가</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>영역명</th>
                            <th>배점</th>
                            <th>반영비율(%)</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="perfTbody"></tbody>
                </table>
            </div>
            <div class="info-box">💡 반영비율 합계: <strong id="totalRatio">0%</strong> (100%가 되어야 합니다)</div>
        </div>

        <!-- 탭 1: 지필평가 -->
        <div id="tab-1" class="content">
            <div class="info-box">📌 각 지필평가별로 문항정보표를 업로드하고, 교사별 예상정답률을 입력합니다.</div>
            <div class="sub-tabs" id="paperSubTabs"></div>
            <div id="paperContent"></div>
        </div>

        <!-- 탭 2: 수행평가 -->
        <div id="tab-2" class="content">
            <div class="info-box">📌 수행평가 영역별 A~E 등급 점수를 입력합니다.</div>
            <div class="section-box">
                <div class="section-title">📝 수행평가 등급별 점수 입력</div>
                <table>
                    <thead id="perfCutsThead">
                        <tr>
                            <th>영역명</th>
                            <th>배점</th>
                            <th>A</th>
                            <th>B</th>
                            <th>C</th>
                            <th>D</th>
                            <th>E</th>
                        </tr>
                    </thead>
                    <tbody id="perfCutsTbody"></tbody>
                </table>
            </div>
            <div class="section-box">
                <div class="section-title">📊 수행평가 반영비율 적용 결과</div>
                <div class="grid-5" id="perfResultGrid"></div>
            </div>
        </div>

        <!-- 탭 3: 최종결과 -->
        <div id="tab-3" class="content">
            <div class="section-box">
                <div class="section-title">🏆 학기말 최종 추정분할점수</div>
                <div class="grid-5" id="finalResultGrid"></div>
            </div>
            <div class="section-box">
                <div class="section-title">📊 상세 산출 내역</div>
                <div id="detailBreakdown"></div>
            </div>
            <div style="text-align:center;margin-top:20px;">
                <button class="btn btn-success" style="padding:15px 40px;font-size:1.1rem;"
                    onclick="exportFinalReport()">📊 최종 보고서 저장</button>
            </div>
        </div>
    </div>

    <!-- 승인요청 모달 -->
    <div id="approvalModal" class="modal">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">📝 승인 요청</h2>
                <button onclick="closeModal('approvalModal')"
                    style="background:none;border:none;font-size:1.5rem;cursor:pointer;">✕</button>
            </div>
            <div style="margin-bottom:15px;"><label>라운드 선택:</label><select id="approvalRoundSelect"
                    style="width:100%;margin-top:5px;"></select></div>
            <div class="warning-box">⚠️ 나이스에서 선택 후 상신함</div>
            <div style="text-align:right;"><button class="btn btn-dark"
                    onclick="closeModal('approvalModal')">닫기</button></div>
        </div>
    </div>

    <!-- 마감취소 모달 -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">🔓 입력마감 취소</h2>
                <button onclick="closeModal('cancelModal')"
                    style="background:none;border:none;font-size:1.5rem;cursor:pointer;">✕</button>
            </div>
            <div class="warning-box">⚠️ 마감을 취소하면 해당 라운드를 다시 수정할 수 있습니다.</div>
            <div class="radio-group" style="margin-bottom:15px;">
                <label class="radio-label"><input type="radio" name="cancelReason" value="문항 오류로 인한 만점 변동">문항 오류로 인한 만점
                    변동</label>
                <label class="radio-label"><input type="radio" name="cancelReason" value="전면 재시험">전면 재시험</label>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button class="btn btn-dark" onclick="closeModal('cancelModal')">취소</button>
                <button class="btn btn-danger" onclick="confirmCancelFinalize()">확인</button>
            </div>
        </div>
    </div>

    <!-- 추정분할점수 산출결과 모달 -->
    <div id="resultModal" class="modal">
        <div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">📊 추정분할점수 산출결과</h2>
                <button onclick="closeModal('resultModal')"
                    style="background:none;border:none;font-size:1.5rem;cursor:pointer;">✕</button>
            </div>
            <div id="resultModalContent"></div>
            <div
                style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;border-top:1px solid #e2e8f0;padding-top:15px;">
                <button class="btn btn-primary" onclick="exportRoundResultsToExcel()">📥 엑셀 다운로드</button>
                <button class="btn btn-success" onclick="openApprovalFromResult()">📝 승인요청</button>
                <button class="btn btn-dark" onclick="closeModal('resultModal')">닫기</button>
            </div>
        </div>
    </div>

    <script>
        // === 전역 데이터 ===
        let project = {
            info: { year: '2026', semester: '1학기', subject: '' },
            teachers: [],
            papers: [{ name: '1회 지필평가', score: 100, ratio: 30, excelData: [], categories: [], teacherData: {}, currentRound: 0, scoreMode: 5 }],
            perfs: [{ name: '수행평가1', score: 100, ratio: 40, cuts: [95, 85, 75, 65, 55] }]
        };
        let currentTab = 0;
        let currentPaperIdx = 0;

        // === 탭 전환 ===
        function switchTab(idx) {
            currentTab = idx;
            document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
            document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
            if (idx === 0) renderSetup();
            if (idx === 1) renderPaperTab();
            if (idx === 2) renderPerfTab();
            if (idx === 3) calculateFinal();
        }

        // === 교사 관리 ===
        function addTeacher() {
            const name = document.getElementById('newTeacherName').value.trim();
            if (!name) { alert('교사명을 입력하세요.'); return; }
            if (project.teachers.includes(name)) { alert('이미 등록된 교사입니다.'); return; }
            project.teachers.push(name);
            document.getElementById('newTeacherName').value = '';
            renderTeacherList();
            // 각 지필평가에 교사 데이터 초기화
            project.papers.forEach(p => { if (!p.teacherData[name]) p.teacherData[name] = { rounds: [[]], completedRounds: [] }; });
        }
        function removeTeacher(name) {
            if (!confirm(`'${name}' 교사를 삭제하시겠습니까?`)) return;
            project.teachers = project.teachers.filter(t => t !== name);
            project.papers.forEach(p => delete p.teacherData[name]);
            renderTeacherList();
        }
        function renderTeacherList() {
            document.getElementById('teacherCount').textContent = project.teachers.length + '명';
            document.getElementById('teacherList').innerHTML = project.teachers.map(t =>
                `<span style="background:#e0f2fe;padding:6px 12px;border-radius:20px;display:flex;align-items:center;gap:5px;">${t}<button onclick="removeTeacher('${t}')" style="background:none;border:none;cursor:pointer;color:#dc2626;">✕</button></span>`
            ).join('');
        }

        // === 평가구조 설정 ===
        function addPaper() { project.papers.push({ name: `${project.papers.length + 1}회 지필평가`, score: 100, ratio: 0, excelData: [], categories: [], teacherData: {}, currentRound: 0, scoreMode: 5 }); renderSetup(); }
        function addPerf() { project.perfs.push({ name: `수행평가${project.perfs.length + 1}`, score: 100, ratio: 0, cuts: [0, 0, 0, 0, 0] }); renderSetup(); }
        function removePaper(i) { if (project.papers.length <= 1) return alert('최소 1개 필요'); project.papers.splice(i, 1); renderSetup(); }
        function removePerf(i) { if (project.perfs.length <= 1) return alert('최소 1개 필요'); project.perfs.splice(i, 1); renderSetup(); }

        function renderSetup() {
            renderTeacherList();
            let pSum = 0, fSum = 0;
            document.getElementById('paperTbody').innerHTML = project.papers.map((p, i) => {
                pSum += p.ratio;
                return `<tr><td><input value="${p.name}" onchange="project.papers[${i}].name=this.value" style="width:150px"></td>
        <td><input type="number" value="${p.score}" onchange="project.papers[${i}].score=Number(this.value)" style="width:80px"></td>
        <td><input type="number" value="${p.ratio}" onchange="project.papers[${i}].ratio=Number(this.value);renderSetup()" style="width:80px"></td>
        <td><button class="btn btn-danger btn-sm" onclick="removePaper(${i})">삭제</button></td></tr>`;
            }).join('');
            document.getElementById('perfTbody').innerHTML = project.perfs.map((p, i) => {
                fSum += p.ratio;
                return `<tr><td><input value="${p.name}" onchange="project.perfs[${i}].name=this.value" style="width:150px"></td>
        <td><input type="number" value="${p.score}" onchange="project.perfs[${i}].score=Number(this.value)" style="width:80px"></td>
        <td><input type="number" value="${p.ratio}" onchange="project.perfs[${i}].ratio=Number(this.value);renderSetup()" style="width:80px"></td>
        <td><button class="btn btn-danger btn-sm" onclick="removePerf(${i})">삭제</button></td></tr>`;
            }).join('');
            const total = pSum + fSum;
            document.getElementById('paperRatioTotal').textContent = pSum + '%';
            document.getElementById('paperRatioTotal').className = pSum > 0 ? 'ratio-ok' : 'ratio-warn';
            document.getElementById('perfRatioTotal').textContent = fSum + '%';
            document.getElementById('perfRatioTotal').className = fSum > 0 ? 'ratio-ok' : 'ratio-warn';
            document.getElementById('totalRatio').textContent = total + '%';
        }

        // === 지필평가 탭 ===
        function renderPaperTab() {
            document.getElementById('paperSubTabs').innerHTML = project.papers.map((p, i) =>
                `<div class="sub-tab ${i === currentPaperIdx ? 'active' : ''} ${p.excelData.length > 0 ? 'completed' : ''}" onclick="currentPaperIdx=${i};renderPaperTab()">${p.name}</div>`
            ).join('');
            renderPaperContent();
        }

        function renderPaperContent() {
            const paper = project.papers[currentPaperIdx];
            const fileName = paper.fileName || '선택된 파일 없음';
            let html = `<div class="section-box"><div class="section-title">📁 문항정보표 업로드</div>
        <input type="file" id="fileInput_${currentPaperIdx}" accept=".xlsx,.xls" onchange="handleExcelUpload(event,${currentPaperIdx})" style="display:none">
        <div style="display:flex;align-items:center;gap:10px;">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput_${currentPaperIdx}').click()">파일 선택</button>
            <span id="fileName_${currentPaperIdx}" style="color:#64748b;">${fileName}</span>
        </div>
        <p style="font-size:0.85rem;color:#64748b;margin-top:5px;">* 나이스 양식의 문항정보표 엑셀 파일을 업로드하세요.</p></div>`;

            if (paper.excelData.length > 0) {
                // 문항정보표 상세 테이블
                const selCount = paper.excelData.filter(d => d.type === '선택형').length;
                const subCount = paper.excelData.filter(d => d.type === '서답형').length;
                const totalScore = paper.excelData.reduce((s, d) => s + d.score, 0);

                html += `<div class="section-box" style="background:#f8fafc;">
                    <div class="section-title" style="border-color:#22c55e;">✅ 문항정보표 데이터</div>
                    <div style="margin-bottom:10px;padding:10px;background:#f0fdf4;border-radius:6px;border:1px solid #bbf7d0;">
                        <span style="font-size:1.1rem;font-weight:bold;color:#15803d;">총 ${paper.excelData.length}문항 로드 완료</span>
                        <span style="font-size:0.9rem;color:#334155;margin-left:10px;">(선택형: <b>${selCount}</b> / 서답형: <b>${subCount}</b> / 총배점: <b>${totalScore.toFixed(1)}</b>점)</span>
                    </div>
                    <div style="font-size:0.85rem;color:#64748b;margin-bottom:5px;">전체 문항 리스트 (스크롤하여 확인):</div>
                    <div style="max-height:250px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;">
                        <table style="font-size:0.85rem;background:white;">
                            <thead style="position:sticky;top:0;background:#f1f5f9;z-index:1;">
                                <tr><th style="padding:8px;border-bottom:2px solid #cbd5e1;width:50px;">번호</th>
                                <th style="padding:8px;border-bottom:2px solid #cbd5e1;">문항유형</th>
                                <th style="padding:8px;border-bottom:2px solid #cbd5e1;">난이도</th>
                                <th style="padding:8px;border-bottom:2px solid #cbd5e1;">배점</th></tr>
                            </thead>
                            <tbody>
                                ${paper.excelData.map((item, idx) => `
                                    <tr style="border-bottom:1px solid #f1f5f9;background:${item.type === '서답형' ? '#fff7ed' : 'white'};">
                                        <td style="padding:6px;text-align:center;color:#64748b;">${idx + 1}</td>
                                        <td style="padding:6px;text-align:center;font-weight:${item.type === '서답형' ? 'bold' : 'normal'};color:${item.type === '서답형' ? '#d97706' : 'inherit'}">${item.type}</td>
                                        <td style="padding:6px;text-align:center;">${item.difficulty}</td>
                                        <td style="padding:6px;text-align:center;">${item.score}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;

                html += `<div class="section-box"><div class="section-title">👥 교사 선택</div>
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
                <select id="currentTeacher" onchange="loadTeacherInput()" style="min-width:150px;"><option value="">교사 선택</option>${project.teachers.map(t => `<option value="${t}">${t}</option>`).join('')}</select>
                <span id="currentTeacherLabel" style="color:var(--primary);font-weight:bold;"></span>
            </div></div>`;

                html += `<div class="section-box"><div class="section-title">📝 최소능력자 예상정답률 입력</div>
            <div style="display:flex;gap:15px;align-items:center;margin-bottom:15px;flex-wrap:wrap;">
                <div style="display:flex;gap:15px;align-items:center;background:#f1f5f9;padding:8px 15px;border-radius:8px;">
                    <span style="font-weight:bold;color:#334155;">성취수준:</span>
                    <label style="cursor:pointer;"><input type="radio" name="scoreMode" value="5" ${paper.scoreMode === 5 ? 'checked' : ''} onchange="changeScoreMode(5)"> 5수준(A-E)+미이수(I)</label>
                    <label style="cursor:pointer;"><input type="radio" name="scoreMode" value="4" ${paper.scoreMode === 4 ? 'checked' : ''} onchange="changeScoreMode(4)"> 5수준(A-E)</label>
                </div>
            </div>
            <div id="roundTabsContainer"></div>
            <div id="inputTableContainer"></div>
            <div id="inputButtons" style="display:none;text-align:right;margin-top:15px;">
                <button class="btn btn-primary" onclick="exportTeacherInputToExcel()" style="float:left;">📥 입력값 엑셀 다운로드</button>
                <button class="btn btn-dark" onclick="saveTeacherData()">💾 임시 저장</button>
                <button class="btn btn-success" onclick="finalizeRound()">✅ 입력마감</button>
                <button class="btn btn-danger" onclick="openCancelModal()">🔓 입력마감 취소</button>
            </div></div>`;
                html += `<div class="section-box"><div class="section-title">📋 조회</div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:15px;">
                <label style="font-weight:bold;">라운드 선택:</label>
                <select id="viewRoundSelect" onchange="refreshViewByRound()" style="min-width:120px;">
                    ${(() => {
                        let opts = '';
                        const maxRounds = Math.max(...project.teachers.map(t => paper.teacherData[t]?.rounds?.length || 0));
                        for (let r = 0; r < maxRounds; r++) {
                            opts += `<option value="${r}" ${r === paper.currentRound ? 'selected' : ''}>${r + 1}라운드</option>`;
                        }
                        return opts || '<option value="0">1라운드</option>';
                    })()}
                </select>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="showTeacherView()">교사별입력정보조회</button>
                <button class="btn btn-primary" onclick="showCategoryView()">문항범주별조회</button>
                <button class="btn btn-primary" onclick="showFinalView()">예상추정분할점수조회</button>
                <button class="btn btn-success" style="font-weight:bold;" onclick="openResultModal()">📊 추정분할점수 산출결과</button>
            </div>

            <div id="viewContainer" style="margin-top:15px;"></div></div>`;
            }
            document.getElementById('paperContent').innerHTML = html;
        }

        // === 엑셀 파싱 ===
        function handleExcelUpload(event, paperIdx) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const ws = workbook.Sheets[workbook.SheetNames[0]];
                const raw = XLSX.utils.sheet_to_json(ws, { header: 1 });

                let headerRow = -1, scoreIdx = -1;
                for (let i = 0; i < Math.min(raw.length, 30); i++) {
                    const row = raw[i];
                    if (!row) continue;
                    const str = row.map(c => String(c).replace(/\s/g, '')).join(' ');
                    if (str.includes('배점') && str.includes('문항번호')) {
                        headerRow = i;
                        scoreIdx = row.findIndex(c => String(c).trim() === '배점');
                        break;
                    }
                }
                if (headerRow < 0) { alert('양식 인식 실패'); return; }

                let hardIdx = -1, midIdx = -1, easyIdx = -1;
                for (let r = headerRow; r <= headerRow + 1; r++) {
                    const row = raw[r]; if (!row) continue;
                    row.forEach((c, idx) => {
                        const v = String(c).trim().replace(/\s/g, '');
                        if (v === '어려움') hardIdx = idx;
                        else if (v === '보통') midIdx = idx;
                        else if (v === '쉬움') easyIdx = idx;
                    });
                }
                if (hardIdx < 0) { alert('난이도 열 찾기 실패'); return; }

                const excelData = [];
                let currentType = '';
                for (let i = headerRow + 2; i < raw.length; i++) {
                    const row = raw[i]; if (!row) continue;
                    const txt = row.map(c => String(c)).join('');
                    if (txt.includes('선택형')) { currentType = '선택형'; continue; }
                    if (txt.includes('서답형')) { currentType = '서답형'; continue; }
                    const sc = row[scoreIdx];
                    if (sc === undefined || sc === '' || isNaN(sc)) continue;
                    let diff = '';
                    if (String(row[hardIdx] || '').includes('O') || String(row[hardIdx] || '').includes('○')) diff = '어려움';
                    else if (String(row[midIdx] || '').includes('O') || String(row[midIdx] || '').includes('○')) diff = '보통';
                    else if (String(row[easyIdx] || '').includes('O') || String(row[easyIdx] || '').includes('○')) diff = '쉬움';
                    else continue;
                    excelData.push({ type: currentType || '선택형', difficulty: diff, score: parseFloat(sc) });
                }
                if (excelData.length === 0) { alert('문항 인식 실패'); return; }

                project.papers[paperIdx].excelData = excelData;
                project.papers[paperIdx].fileName = file.name;
                processCategories(paperIdx);
                project.teachers.forEach(t => {
                    if (!project.papers[paperIdx].teacherData[t]) {
                        project.papers[paperIdx].teacherData[t] = { rounds: [[]], completedRounds: [] };
                    }
                });
                renderPaperTab();
            };
            reader.readAsArrayBuffer(file);
        }

        function processCategories(paperIdx) {
            const paper = project.papers[paperIdx];
            const catMap = new Map();
            paper.excelData.forEach(item => {
                const key = `${item.type}|${item.difficulty}`;
                if (!catMap.has(key)) catMap.set(key, { type: item.type, difficulty: item.difficulty, count: 0, totalScore: 0 });
                const cat = catMap.get(key);
                cat.count++; cat.totalScore += item.score;
            });
            const cats = Array.from(catMap.values());
            const order = { '쉬움': 1, '보통': 2, '어려움': 3 };
            cats.sort((a, b) => { if (a.type !== b.type) return a.type === '선택형' ? -1 : 1; return (order[a.difficulty] || 9) - (order[b.difficulty] || 9); });
            paper.categories = cats;
        }

        // === 교사 입력 ===
        function loadTeacherInput() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) { document.getElementById('roundTabsContainer').innerHTML = ''; document.getElementById('inputTableContainer').innerHTML = ''; document.getElementById('inputButtons').style.display = 'none'; return; }
            document.getElementById('currentTeacherLabel').textContent = `- ${name} 선생님`;
            document.getElementById('inputButtons').style.display = 'block';
            renderRoundTabs();
            renderInputTable();
        }

        function renderRoundTabs() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) return;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            if (!td) return;
            let html = '';
            for (let i = 0; i < td.rounds.length; i++) {
                const done = td.completedRounds.includes(i);
                const isActive = i === paper.currentRound;
                html += `<button class="round-tab ${isActive ? 'active' : ''}" onclick="switchRound(${i})">${i + 1}라운드${done ? ' ✓' : ''}</button>`;
            }
            html += `<button class="round-tab add-btn" onclick="addRound()">+ 추가</button>`;
            if (td.rounds.length > 1) {
                html += `<button class="round-tab" style="background:#fee2e2;color:#dc2626;border-color:#fca5a5;margin-left:auto;" onclick="deleteRound()">🗑️ 삭제</button>`;
            }
            document.getElementById('roundTabsContainer').innerHTML = `<div class="round-tabs" style="display:flex;gap:8px;flex-wrap:wrap;">${html}</div>`;
        }

        function switchRound(idx) { project.papers[currentPaperIdx].currentRound = idx; renderRoundTabs(); renderInputTable(); }
        function addRound() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) { alert('교사를 먼저 선택해주세요.'); return; }
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];

            // 모든 교사에게 새 라운드 추가 (현재 교사만 추가하면 동기화 문제 발생)
            const useCopy = confirm('이전 라운드 데이터를 복사하여 시작하시겠습니까?\n[확인]: 복사함 / [취소]: 빈 값으로 시작');

            project.teachers.forEach(t => {
                const teacherData = paper.teacherData[t];
                if (!teacherData) return;

                let newRoundData;
                if (useCopy && teacherData.rounds.length > 0) {
                    // 이전 라운드 데이터 복사
                    const prevRound = teacherData.rounds[teacherData.rounds.length - 1];
                    newRoundData = JSON.parse(JSON.stringify(prevRound));
                } else {
                    // 빈 값으로 시작
                    newRoundData = paper.categories.map(() => Array(5).fill(null));
                }
                teacherData.rounds.push(newRoundData);
            });

            paper.currentRound = td.rounds.length - 1;
            renderRoundTabs(); renderInputTable();
            renderViewRoundSelect();
        }

        function deleteRound() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) return;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];

            if (td.rounds.length <= 1) {
                alert('최소 1개의 라운드가 필요합니다.');
                return;
            }

            const roundToDelete = paper.currentRound;
            if (!confirm(`${roundToDelete + 1}라운드를 삭제하시겠습니까?\n해당 라운드의 모든 데이터가 삭제됩니다.`)) return;

            // 모든 교사의 해당 라운드 삭제
            project.teachers.forEach(t => {
                const teacherData = paper.teacherData[t];
                if (!teacherData) return;
                if (teacherData.rounds.length > roundToDelete) {
                    teacherData.rounds.splice(roundToDelete, 1);
                }
                // completedRounds 업데이트
                const compIdx = teacherData.completedRounds.indexOf(roundToDelete);
                if (compIdx > -1) teacherData.completedRounds.splice(compIdx, 1);
                // 인덱스 조정
                teacherData.completedRounds = teacherData.completedRounds.map(r => r > roundToDelete ? r - 1 : r);
            });

            // 현재 라운드 조정
            if (paper.currentRound >= td.rounds.length) {
                paper.currentRound = Math.max(0, td.rounds.length - 1);
            }

            alert('라운드가 삭제되었습니다.');
            renderRoundTabs(); renderInputTable();
            renderViewRoundSelect();
        }

        function renderInputTable() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) return;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const round = paper.currentRound;
            const isCompleted = td.completedRounds.includes(round);
            const cats = paper.categories;
            const mode = paper.scoreMode || 5;
            const colCount = mode;

            if (!td.rounds[round]) td.rounds[round] = [];
            while (td.rounds[round].length < cats.length) td.rounds[round].push(Array(5).fill(null));

            // 헤더 생성 (4단계 vs 5단계)
            const headers4 = ['A/B(%)', 'B/C(%)', 'C/D(%)', 'D/E(%)'];
            const headers5 = ['A/B(%)', 'B/C(%)', 'C/D(%)', 'D/E(%)', 'E/미도달(%)'];
            const headers = mode === 5 ? headers5 : headers4;

            let html = `<table><thead><tr><th>유형</th><th>난이도</th><th>문항수</th><th>배점합</th>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
            cats.forEach((cat, ci) => {
                const vals = td.rounds[round][ci] || Array(5).fill(null);
                html += `<tr><td>${cat.type}</td><td>${cat.difficulty}</td><td>${cat.count}</td><td>${cat.totalScore.toFixed(1)}</td>`;
                for (let i = 0; i < colCount; i++) {
                    const v = vals[i] !== null ? vals[i] : '';
                    const dis = isCompleted ? 'disabled' : '';
                    // 마지막 컬럼(5단계의 E/미도달)만 1% 단위 입력, 나머지는 5% 단위 select
                    if (mode === 5 && i === 4) {
                        html += `<td><input type="number" class="inp-rate" data-cat="${ci}" data-idx="${i}" value="${v}" min="20" max="100" step="1" style="width:60px" oninput="validateInputs()" ${dis}></td>`;
                    } else {
                        html += `<td><select class="inp-rate" data-cat="${ci}" data-idx="${i}" onchange="validateInputs()" ${dis}><option value="">선택</option>`;
                        for (let o = 0; o <= 100; o += 5) html += `<option value="${o}" ${v === o ? 'selected' : ''}>${o}</option>`;
                        html += `</select></td>`;
                    }
                }
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('inputTableContainer').innerHTML = html;
        }

        function changeScoreMode(mode) {
            project.papers[currentPaperIdx].scoreMode = mode;
            renderInputTable();
        }

        function validateInputs() {
            const inputs = document.querySelectorAll('.inp-rate');
            let valid = true;
            inputs.forEach(inp => { inp.classList.remove('invalid-input', 'warning-diff'); });

            const paper = project.papers[currentPaperIdx];
            const mode = paper.scoreMode || 5;
            const cats = paper.categories;

            // 1. Row check: 상위수준 >= 하위수준 + 20% 차이 경고
            cats.forEach((cat, ci) => {
                for (let c = 0; c < mode - 1; c++) {
                    const left = document.querySelector(`.inp-rate[data-cat="${ci}"][data-idx="${c}"]`);
                    const right = document.querySelector(`.inp-rate[data-cat="${ci}"][data-idx="${c + 1}"]`);
                    if (left && right && left.value !== '' && right.value !== '') {
                        const leftVal = parseFloat(left.value);
                        const rightVal = parseFloat(right.value);
                        // 상위 < 하위이면 오류
                        if (leftVal < rightVal) {
                            left.classList.add('invalid-input');
                            right.classList.add('invalid-input');
                            valid = false;
                        }
                        // 차이가 20% 이상이면 경고 (차하위에 표시)
                        if (leftVal - rightVal >= 20) {
                            right.classList.add('warning-diff');
                        }
                    }
                }
            });

            // 2. Column check: 난이도별 (쉬움 >= 보통 >= 어려움) - 같은 유형 내
            const types = ['선택형', '서답형'];
            const diffOrder = ['쉬움', '보통', '어려움'];

            for (let c = 0; c < mode; c++) {
                types.forEach(type => {
                    // 해당 유형의 난이도별 행 인덱스 찾기
                    const catIndices = {};
                    cats.forEach((cat, idx) => {
                        if (cat.type === type) catIndices[cat.difficulty] = idx;
                    });

                    // 쉬움 >= 보통, 보통 >= 어려움 비교
                    const comparePairs = [['쉬움', '보통'], ['보통', '어려움'], ['쉬움', '어려움']];
                    comparePairs.forEach(([easy, hard]) => {
                        if (catIndices[easy] !== undefined && catIndices[hard] !== undefined) {
                            const easyInp = document.querySelector(`.inp-rate[data-cat="${catIndices[easy]}"][data-idx="${c}"]`);
                            const hardInp = document.querySelector(`.inp-rate[data-cat="${catIndices[hard]}"][data-idx="${c}"]`);
                            if (easyInp && hardInp && easyInp.value !== '' && hardInp.value !== '') {
                                if (parseFloat(easyInp.value) < parseFloat(hardInp.value)) {
                                    easyInp.classList.add('invalid-input');
                                    hardInp.classList.add('invalid-input');
                                    valid = false;
                                }
                            }
                        }
                    });
                });
            }

            return valid;
        }

        function saveTeacherData() {
            if (!validateInputs()) { alert('입력값 오류를 확인하세요.'); return; }
            const name = document.getElementById('currentTeacher').value;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const round = paper.currentRound;
            const inputs = document.querySelectorAll('.inp-rate');
            let complete = true;
            inputs.forEach(inp => {
                const ci = parseInt(inp.dataset.cat), vi = parseInt(inp.dataset.idx);
                const v = inp.value;
                td.rounds[round][ci][vi] = v === '' ? null : parseFloat(v);
                if (v === '') complete = false;
            });
            if (!complete) { alert('모든 항목을 입력하세요.'); return; }
            alert('저장되었습니다.');
        }

        function finalizeRound() {
            if (!validateInputs()) { alert('입력값 오류를 확인하세요.'); return; }
            const name = document.getElementById('currentTeacher').value;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const round = paper.currentRound;
            if (td.completedRounds.includes(round)) { alert('이미 마감됨'); return; }
            saveTeacherData();
            if (!confirm(`${name} 선생님의 ${round + 1}라운드를 마감하시겠습니까?`)) return;
            td.completedRounds.push(round);
            alert('마감 완료');
            renderRoundTabs(); renderInputTable();
            renderViewRoundSelect();
        }

        function openCancelModal() { document.getElementById('cancelModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function confirmCancelFinalize() {
            const reason = document.querySelector('input[name="cancelReason"]:checked');
            if (!reason) { alert('사유 선택 필요'); return; }
            const name = document.getElementById('currentTeacher').value;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const round = paper.currentRound;
            const idx = td.completedRounds.indexOf(round);
            if (idx > -1) td.completedRounds.splice(idx, 1);
            alert('마감 취소됨');
            closeModal('cancelModal');
            renderRoundTabs(); renderInputTable();
            renderViewRoundSelect();
        }

        // === 조회 기능 ===
        function showTeacherView() {
            const paper = project.papers[currentPaperIdx];
            const cats = paper.categories;
            const mode = paper.scoreMode || 5;
            const headers = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E'] : ['A/B', 'B/C', 'C/D', 'D/E'];
            const viewRound = document.getElementById('viewRoundSelect')?.value ?? paper.currentRound;
            const roundIdx = parseInt(viewRound);

            let html = '<div class="info-box" style="background:#fef3c7;border-color:#fcd34d;color:#92400e;margin-bottom:15px;">⚠️ <strong>적색 표시</strong>: 동일 문항범주 내 교사간 정답률 차이가 20% 이상인 경우입니다.</div>';
            html += `<h4>📋 교사별 입력정보 (${roundIdx + 1}라운드)</h4><table><thead><tr><th>유형</th><th>난이도</th><th>교사</th>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;

            cats.forEach((cat, ci) => {
                // 각 컬럼별 모든 교사의 값 수집
                const colValues = [];
                for (let c = 0; c < mode; c++) colValues.push([]);

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td || !td.rounds[roundIdx] || !td.rounds[roundIdx][ci]) return;
                    const vals = td.rounds[roundIdx][ci];
                    for (let c = 0; c < mode; c++) {
                        if (vals[c] !== null && vals[c] !== undefined) {
                            colValues[c].push(parseFloat(vals[c]));
                        }
                    }
                });

                // 최대-최소 차이 계산하여 20 이상이면 플래그
                const diffFlags = colValues.map(arr => {
                    if (arr.length < 2) return false;
                    return (Math.max(...arr) - Math.min(...arr)) >= 20;
                });

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td) return;
                    const vals = td.rounds[roundIdx] && td.rounds[roundIdx][ci] ? td.rounds[roundIdx][ci] : Array(mode).fill('-');
                    html += `<tr><td>${cat.type}</td><td>${cat.difficulty}</td><td>${t}</td>`;
                    for (let c = 0; c < mode; c++) {
                        const v = vals[c] !== null && vals[c] !== undefined ? vals[c] : '-';
                        const cellClass = diffFlags[c] ? 'diff-alert' : '';
                        html += `<td class="${cellClass}">${v}</td>`;
                    }
                    html += '</tr>';
                });
            });
            html += '</tbody></table>';
            document.getElementById('viewContainer').innerHTML = html;
        }

        function showCategoryView() {
            const paper = project.papers[currentPaperIdx];
            const cats = paper.categories;
            const viewRound = document.getElementById('viewRoundSelect')?.value ?? paper.currentRound;
            const roundIdx = parseInt(viewRound);
            const mode = paper.scoreMode || 5;
            const levels = mode === 5 ? ['A', 'B', 'C', 'D', 'E'] : ['A', 'B', 'C', 'D'];

            let html = `<h4>📊 문항 범주별 상세 통계 (${roundIdx + 1}라운드)</h4>`;
            html += '<div style="overflow-x:auto;"><table><thead><tr><th rowspan="2">문항유형</th><th rowspan="2">난이도</th>';
            levels.forEach(lv => {
                html += `<th colspan="4" style="text-align:center;background:#e0f2fe;">${lv}</th>`;
            });
            html += '</tr><tr>';
            levels.forEach(() => {
                html += '<th>평균</th><th>표준편차</th><th>최솟값</th><th>최댓값</th>';
            });
            html += '</tr></thead><tbody>';

            cats.forEach((cat, ci) => {
                // 각 레벨별 데이터 수집
                const levelData = levels.map(() => []);

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td || !td.rounds[roundIdx] || !td.rounds[roundIdx][ci]) return;
                    const vals = td.rounds[roundIdx][ci];
                    for (let c = 0; c < levels.length; c++) {
                        if (vals[c] !== null && vals[c] !== undefined) {
                            levelData[c].push(parseFloat(vals[c]));
                        }
                    }
                });

                html += `<tr><td>${cat.type}</td><td>${cat.difficulty}</td>`;
                levelData.forEach(arr => {
                    if (arr.length === 0) {
                        html += '<td>-</td><td>-</td><td>-</td><td>-</td>';
                    } else {
                        const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
                        const std = Math.sqrt(arr.reduce((a, b) => a + (b - avg) ** 2, 0) / arr.length);
                        const min = Math.min(...arr);
                        const max = Math.max(...arr);
                        html += `<td>${avg.toFixed(2)}</td><td>${std.toFixed(2)}</td><td>${min.toFixed(0)}</td><td>${max.toFixed(0)}</td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            document.getElementById('viewContainer').innerHTML = html;
        }

        function showFinalView() {
            const paper = project.papers[currentPaperIdx];
            const cats = paper.categories;
            const viewRound = document.getElementById('viewRoundSelect')?.value ?? paper.currentRound;
            const roundIdx = parseInt(viewRound);
            const mode = paper.scoreMode || 5;
            const headers = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E/미도달'] : ['A/B', 'B/C', 'C/D', 'D/E'];

            // 각 교사별로 전체 점수 계산
            const teacherScores = headers.map(() => []);

            project.teachers.forEach(t => {
                const td = paper.teacherData[t];
                if (!td || !td.rounds[roundIdx]) return;

                // 해당 모드(4/5)에 필요한 컬럼들이 모두 채워졌는지 확인
                const isComplete = td.rounds[roundIdx].length >= cats.length && td.rounds[roundIdx].every(row => {
                    if (!row) return false;
                    for (let n = 0; n < headers.length; n++) {
                        if (row[n] === null || row[n] === undefined || row[n] === '') return false;
                    }
                    return true;
                });

                if (!isComplete) return;

                const scores = headers.map(() => 0);
                cats.forEach((cat, ci) => {
                    const vals = td.rounds[roundIdx][ci];
                    for (let vi = 0; vi < headers.length; vi++) {
                        scores[vi] += cat.totalScore * (parseFloat(vals[vi]) / 100);
                    }
                });
                scores.forEach((s, i) => teacherScores[i].push(s));
            });

            let html = `<h4>🏆 최종 예상 추정분할점수 (${roundIdx + 1}라운드)</h4>`;
            html += '<table><thead><tr><th>구분</th>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';

            // 평균
            html += '<tr><td style="font-weight:bold;">평균</td>';
            teacherScores.forEach(arr => {
                const avg = arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
                html += `<td style="font-weight:bold;color:#1e40af;">${avg.toFixed(2)}</td>`;
            });
            html += '</tr>';

            // 표준편차
            html += '<tr><td style="font-weight:bold;">표준편차</td>';
            teacherScores.forEach(arr => {
                if (arr.length === 0) { html += '<td>-</td>'; return; }
                const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
                const std = Math.sqrt(arr.reduce((a, b) => a + (b - avg) ** 2, 0) / arr.length);
                html += `<td>${std.toFixed(2)}</td>`;
            });
            html += '</tr>';

            // 최솟값
            html += '<tr><td style="font-weight:bold;">최솟값</td>';
            teacherScores.forEach(arr => {
                html += `<td>${arr.length > 0 ? Math.min(...arr).toFixed(2) : '-'}</td>`;
            });
            html += '</tr>';

            // 최댓값
            html += '<tr><td style="font-weight:bold;">최댓값</td>';
            teacherScores.forEach(arr => {
                html += `<td>${arr.length > 0 ? Math.max(...arr).toFixed(2) : '-'}</td>`;
            });
            html += '</tr>';

            html += '</tbody></table>';
            document.getElementById('viewContainer').innerHTML = html;
        }

        // === 라운드별 조회 기능 ===
        function refreshViewByRound() {
            const select = document.getElementById('viewRoundSelect');
            if (!select) return;
            project.papers[currentPaperIdx].currentRound = parseInt(select.value);
            // 현재 보이는 뷰가 있으면 갱신
            const vc = document.getElementById('viewContainer');
            if (vc && vc.innerHTML.includes('교사별')) showTeacherView();
            else if (vc && vc.innerHTML.includes('예상')) showFinalView();
        }

        function getViewRound() {
            const select = document.getElementById('viewRoundSelect');
            return select ? parseInt(select.value) : project.papers[currentPaperIdx].currentRound;
        }

        // === 추정분할점수 산출결과 모달 ===
        function calculateRoundResult(roundIdx) {
            const paper = project.papers[currentPaperIdx];
            const cats = paper.categories;
            const mode = paper.scoreMode || 5;
            const cols = mode === 5 ? 5 : 4;
            const sums = Array(cols).fill(0);
            let cnt = 0;

            project.teachers.forEach(t => {
                const td = paper.teacherData[t];
                if (!td || !td.rounds[roundIdx]) return;

                const isComplete = td.rounds[roundIdx].length >= cats.length && td.rounds[roundIdx].every(row => {
                    if (!row) return false;
                    for (let n = 0; n < cols; n++) {
                        if (row[n] === null || row[n] === undefined || row[n] === '') return false;
                    }
                    return true;
                });

                if (isComplete) {
                    cats.forEach((cat, ci) => {
                        const vals = td.rounds[roundIdx][ci];
                        for (let vi = 0; vi < cols; vi++) {
                            sums[vi] += cat.totalScore * (parseFloat(vals[vi]) / 100);
                        }
                    });
                    cnt++;
                }
            });
            return { avgs: sums.map(s => cnt > 0 ? (s / cnt) : 0), cnt };
        }

        function openResultModal() {
            const paper = project.papers[currentPaperIdx];
            const maxRounds = Math.max(...project.teachers.map(t => paper.teacherData[t]?.rounds?.length || 0));

            if (maxRounds === 0) {
                alert('입력된 라운드 데이터가 없습니다.');
                return;
            }

            let html = '<div style="overflow-x:auto;">';
            html += '<table><thead><tr><th>라운드</th><th>참여교사</th><th>A/B</th><th>B/C</th><th>C/D</th><th>D/E</th><th>E/미도달</th><th>선택</th></tr></thead><tbody>';

            for (let r = 0; r < maxRounds; r++) {
                const result = calculateRoundResult(r);
                const isSelected = paper.selectedResultRound === r;
                html += `<tr style="${isSelected ? 'background:#dbeafe;' : ''}">
                    <td style="font-weight:bold;">${r + 1}라운드</td>
                    <td>${result.cnt}명</td>
                    ${result.avgs.map(a => `<td style="font-weight:bold;color:#1e40af;">${a.toFixed(2)}</td>`).join('')}
                    <td><button class="btn ${isSelected ? 'btn-success' : 'btn-dark'}" onclick="selectResultRound(${r})">${isSelected ? '✓ 선택됨' : '선택'}</button></td>
                </tr>`;
            }
            html += '</tbody></table></div>';

            // 선택된 라운드 정보
            if (paper.selectedResultRound !== undefined) {
                const selResult = calculateRoundResult(paper.selectedResultRound);
                html += `<div class="info-box" style="margin-top:15px;background:#dcfce7;border-color:#86efac;">
                    ✅ <strong>${paper.selectedResultRound + 1}라운드</strong>가 최종 결과로 선택되었습니다.
                </div>`;
            }

            document.getElementById('resultModalContent').innerHTML = html;
            document.getElementById('resultModal').style.display = 'flex';
        }

        function selectResultRound(roundIdx) {
            project.papers[currentPaperIdx].selectedResultRound = roundIdx;
            openResultModal(); // 모달 갱신
        }

        function exportRoundResultsToExcel() {
            const paper = project.papers[currentPaperIdx];
            const maxRounds = Math.max(...project.teachers.map(t => paper.teacherData[t]?.rounds?.length || 0));

            const data = [['라운드', '참여교사', 'A/B', 'B/C', 'C/D', 'D/E', 'E/미도달']];
            for (let r = 0; r < maxRounds; r++) {
                const result = calculateRoundResult(r);
                data.push([`${r + 1}라운드`, `${result.cnt}명`, ...result.avgs.map(a => a.toFixed(2))]);
            }

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '추정분할점수');

            const now = new Date();
            const filename = `추정분할점수_${paper.name}_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function openApprovalFromResult() {
            const paper = project.papers[currentPaperIdx];
            if (paper.selectedResultRound === undefined) {
                alert('먼저 승인요청할 라운드를 선택해주세요.');
                return;
            }
            closeModal('resultModal');
            // 승인요청 모달 열기
            const select = document.getElementById('approvalRoundSelect');
            select.innerHTML = `<option value="${paper.selectedResultRound}">${paper.selectedResultRound + 1}라운드 (선택됨)</option>`;
            document.getElementById('approvalModal').style.display = 'flex';
        }

        // === 엑셀 출력 개선: 모든 라운드 출력 ===
        function exportTeacherInputToExcel() {
            const name = document.getElementById('currentTeacher').value;
            if (!name) return;
            const paper = project.papers[currentPaperIdx];
            const td = paper.teacherData[name];
            const mode = paper.scoreMode || 5;
            const headers = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E/미도달'] : ['A/B', 'B/C', 'C/D', 'D/E'];

            const wb = XLSX.utils.book_new();
            td.rounds.forEach((roundData, rIdx) => {
                const data = [['유형', '난이도', ...headers]];
                paper.categories.forEach((cat, ci) => {
                    const vals = roundData[ci] || Array(mode).fill('');
                    data.push([cat.type, cat.difficulty, ...vals]);
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, `${rIdx + 1}라운드`);
            });
            XLSX.writeFile(wb, `입력값_${name}_${paper.name}.xlsx`);
        }

        // === 수행평가 탭 ===
        // === 수행평가 탭 ===
        function renderPerfTab() {
            const paper = project.papers[currentPaperIdx] || project.papers[0]; // 현재 선택된 지필평가의 모드 해킹
            const mode = paper.scoreMode || 5;
            const headers = mode === 5
                ? '<tr><th>영역명</th><th>배점</th><th>A/B(%)</th><th>B/C(%)</th><th>C/D(%)</th><th>D/E(%)</th><th>E/미도달(%)</th></tr>'
                : '<tr><th>영역명</th><th>배점</th><th>A/B(%)</th><th>B/C(%)</th><th>C/D(%)</th><th>D/E(%)</th></tr>';

            document.getElementById('perfCutsThead').innerHTML = headers;

            const indices = mode === 5 ? [0, 1, 2, 3, 4] : [0, 1, 2, 3];

            document.getElementById('perfCutsTbody').innerHTML = project.perfs.map((p, i) =>
                `<tr><td>${p.name}</td><td>${p.score}</td>${indices.map(j =>
                    `<td><input type="number" value="${p.cuts[j]}" style="width:60px" onchange="project.perfs[${i}].cuts[${j}]=Number(this.value);calcPerfResult()"></td>`
                ).join('')}</tr>`
            ).join('');
            calcPerfResult();
        }

        function calcPerfResult() {
            const paper = project.papers[currentPaperIdx] || project.papers[0];
            const mode = paper.scoreMode || 5;
            const levels = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E/미도달'] : ['A/B', 'B/C', 'C/D', 'D/E'];

            const grid = document.getElementById('perfResultGrid');
            let html = '';
            levels.forEach((lv, i) => {
                let total = project.perfs.reduce((s, p) => s + (p.cuts[i] * p.ratio / 100), 0);
                html += `<div class="summary-card"><div style="font-weight:bold;color:#1e40af;margin-bottom:8px;">${lv}</div><div class="score-val">${total.toFixed(2)}</div></div>`;
            });
            grid.innerHTML = html;
        }

        // === 최종결과 ===
        function calculateFinal() {
            const grid = document.getElementById('finalResultGrid');
            const breakdown = document.getElementById('detailBreakdown');

            const paper = project.papers[currentPaperIdx] || project.papers[0];
            const mode = paper.scoreMode || 5;
            const levels = mode === 5 ? ['A/B', 'B/C', 'C/D', 'D/E', 'E/미도달'] : ['A/B', 'B/C', 'C/D', 'D/E'];

            let paperTotals = [0, 0, 0, 0, 0], perfTotals = [0, 0, 0, 0, 0];
            let paperRows = '';

            // 지필평가 합산
            project.papers.forEach(paper => {
                if (paper.categories.length === 0) {
                    paperRows += `<tr><td>${paper.name}</td><td>${paper.ratio}%</td><td colspan="5">-</td></tr>`;
                    return;
                }

                // 선택된 라운드가 있으면 그것을, 없으면 현재 라운드를 사용
                const targetRound = paper.selectedResultRound !== undefined ? paper.selectedResultRound : paper.currentRound;

                let cnt = 0;
                const sums = [0, 0, 0, 0, 0];
                const mode = paper.scoreMode || 5;
                const cols = mode === 5 ? 5 : 4;

                project.teachers.forEach(t => {
                    const td = paper.teacherData[t];
                    if (!td || !td.rounds[targetRound]) return;

                    const isComplete = td.rounds[targetRound].length >= paper.categories.length && td.rounds[targetRound].every(row => {
                        if (!row) return false;
                        for (let n = 0; n < cols; n++) {
                            if (row[n] === null || row[n] === undefined || row[n] === '') return false;
                        }
                        return true;
                    });

                    if (isComplete) {
                        paper.categories.forEach((cat, ci) => {
                            const vals = td.rounds[targetRound][ci];
                            for (let vi = 0; vi < cols; vi++) {
                                sums[vi] += cat.totalScore * (parseFloat(vals[vi]) / 100);
                            }
                        });
                        cnt++;
                    }
                });

                if (cnt > 0) {
                    const avgs = sums.map(s => s / cnt);
                    avgs.forEach((s, i) => paperTotals[i] += s * paper.ratio / 100);

                    paperRows += `<tr><td>${paper.name} <span style="font-size:0.8em;color:#666;">(${targetRound + 1}R)</span></td><td>${paper.ratio}%</td>`;
                    avgs.forEach((v, i) => {
                        if (mode === 4 && i === 4) paperRows += '<td>-</td>';
                        else paperRows += `<td>${v.toFixed(2)}</td>`;
                    });
                    paperRows += '</tr>';
                } else {
                    paperRows += `<tr><td>${paper.name}</td><td>${paper.ratio}%</td><td colspan="5">-</td></tr>`;
                }
            });

            // 수행평가 합산
            project.perfs.forEach(p => {
                p.cuts.forEach((c, i) => {
                    // mode 4일 때 E(index 4)는 합산하지 않음 (0 처리)
                    // 각 지필평가 별로 mode가 다를 수 없다고 가정 (currentPaper 기준)
                    const curPaper = project.papers[currentPaperIdx] || project.papers[0];
                    const mode = curPaper.scoreMode || 5;
                    if (mode === 4 && i === 4) return;

                    perfTotals[i] += c * p.ratio / 100;
                });
            });

            const finals = paperTotals.map((p, i) => p + perfTotals[i]);

            grid.innerHTML = levels.map((lv, i) =>
                `<div class="summary-card"><div style="font-weight:bold;color:#1e40af;margin-bottom:10px;">${lv}</div><div class="score-val">${finals[i].toFixed(2)}</div><div style="font-size:0.85rem;color:#64748b;">지필 ${paperTotals[i].toFixed(1)} + 수행 ${perfTotals[i].toFixed(1)}</div></div>`
            ).join('');

            let bhtml = '<table><thead><tr><th>구분</th><th>비율</th>' + levels.map(l => `<th>${l}</th>`).join('') + '</tr></thead><tbody>';
            bhtml += paperRows;
            bhtml += `<tr style="background:#f0f9ff;"><td><strong>지필 소계</strong></td><td><strong>${project.papers.reduce((s, p) => s + p.ratio, 0)}%</strong></td>${paperTotals.slice(0, levels.length).map(t => `<td><strong>${t.toFixed(2)}</strong></td>`).join('')}</tr>`;
            project.perfs.forEach(p => { bhtml += `<tr><td>${p.name}</td><td>${p.ratio}%</td>${p.cuts.slice(0, levels.length).map((c, i) => `<td>${(c * p.ratio / 100).toFixed(2)}</td>`).join('')}</tr>`; });
            bhtml += `<tr style="background:#f0f9ff;"><td><strong>수행 소계</strong></td><td><strong>${project.perfs.reduce((s, p) => s + p.ratio, 0)}%</strong></td>${perfTotals.slice(0, levels.length).map(t => `<td><strong>${t.toFixed(2)}</strong></td>`).join('')}</tr>`;
            bhtml += `<tr style="background:#dbeafe;font-size:1.1rem;"><td><strong>🏆 최종</strong></td><td><strong>100%</strong></td>${finals.slice(0, levels.length).map(f => `<td><strong>${f.toFixed(2)}</strong></td>`).join('')}</tr></tbody></table>`;
            breakdown.innerHTML = bhtml;
        }

        // === 저장/불러오기 ===
        function saveFullProject() {
            project.info.year = document.getElementById('year').value;
            project.info.semester = document.getElementById('semester').value;
            project.info.subject = document.getElementById('subject').value;
            const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            a.download = `나이스 추정분할점수 산출(${year}-${month}-${day}_${hours}${minutes}).json`;
            a.click();
        }

        function loadFullProject(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (ev) {
                try {
                    project = JSON.parse(ev.target.result);
                    document.getElementById('year').value = project.info?.year || '2026';
                    document.getElementById('semester').value = project.info?.semester || '1학기';
                    document.getElementById('subject').value = project.info?.subject || '';
                    if (project.accessGranted) switchTab(1);
                    else switchTab(0);
                    alert('✅ 불러오기 완료');
                } catch (err) { alert('파일 오류'); }
            };
            reader.readAsText(file);
        }

        function exportFinalReport() { calculateFinal(); saveFullProject(); }

        // 초기화
        window.onload = function () { switchTab(0); };
    </script>
</body>

</html>