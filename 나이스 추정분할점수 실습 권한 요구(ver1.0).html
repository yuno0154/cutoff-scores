<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEIS ë¬¸í•­ì •ë³´í‘œ ê¸°ë°˜ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --border: #cbd5e1;
            --danger: #ef4444;
            --success: #22c55e;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-box h2 { margin: 0 0 10px 0; color: #1e293b; font-size: 1.8rem; }
        .login-box .subtitle { color: #64748b; margin-bottom: 30px; font-size: 0.95rem; }
        .login-box .lock-icon { font-size: 4rem; margin-bottom: 20px; }

        .login-box input[type="password"] {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            box-sizing: border-box;
            text-align: center;
            letter-spacing: 3px;
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }

        .login-box input[type="password"]:focus { outline: none; border-color: #2563eb; }

        .login-box button {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .login-box button:hover { background: #1d4ed8; }
        .login-box .error-msg { color: #dc2626; margin-top: 15px; font-size: 0.9rem; display: none; }

        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999999;
            justify-content: center;
            align-items: center;
        }

        .admin-modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; }
        .admin-modal h3 { margin: 0 0 20px 0; color: #1e293b; }
        .admin-modal input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        .admin-modal .hash-output { background: #f1f5f9; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 0.85rem; word-break: break-all; margin: 15px 0; border: 1px solid #e2e8f0; }
        .admin-modal .instructions { background: #fef3c7; padding: 15px; border-radius: 6px; font-size: 0.85rem; color: #92400e; margin-top: 15px; }

        .invalid-input { color: #dc2626 !important; font-weight: bold; background-color: #fee2e2 !important; border-color: #ef4444 !important; }

        .warning-diff {
            color: #dc2626 !important;
            font-weight: bold;
            border: 3px solid #dc2626 !important;
            background-color: #fef2f2 !important;
            box-shadow: 0 0 8px rgba(220, 38, 38, 0.6) !important;
            animation: pulse-warning 1s ease-in-out infinite;
        }

        select.warning-diff, input.warning-diff {
            color: #dc2626 !important;
            font-weight: bold;
            border: 3px solid #dc2626 !important;
            background-color: #fef2f2 !important;
            box-shadow: 0 0 8px rgba(220, 38, 38, 0.6) !important;
        }

        td.warning-cell { color: #dc2626 !important; font-weight: bold; background-color: #fef2f2 !important; border: 2px solid #dc2626 !important; }

        @keyframes pulse-warning {
            0%, 100% { box-shadow: 0 0 5px rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 15px rgba(220, 38, 38, 0.8); }
        }

        body { font-family: 'Pretendard', -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: 80vh;
            display: none;
        }

        .container.unlocked { display: block; }

        header { background: #1e293b; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.5rem; }

        .tabs { display: flex; background: #334155; overflow-x: auto; }
        .tab { padding: 15px 25px; color: #94a3b8; cursor: pointer; border: none; background: none; font-size: 1rem; transition: 0.2s; white-space: nowrap; }
        .tab:hover { color: white; background: #475569; }
        .tab.active { color: white; background: var(--primary); font-weight: bold; border-bottom: 3px solid #60a5fa; }

        .content { padding: 30px; display: none; }
        .content.active { display: block; animation: fadeIn 0.3s ease-in-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .section-box { border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; background: #fff; }
        .section-title { font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: #0f172a; border-left: 4px solid var(--primary); padding-left: 10px; }

        .radio-group { display: flex; gap: 20px; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0; }
        .radio-label { display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.95rem; }

        input[type="file"] { border: 1px solid var(--border); padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .teacher-control { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        input[type="text"], input[type="number"], select { padding: 8px; border: 1px solid var(--border); border-radius: 4px; }
        td select { width: 80px; text-align: center; appearance: auto; background: white; padding-right: 25px; }

        button { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 500; transition: background 0.2s; }
        button:hover { background: #1d4ed8; }
        button.danger { background: var(--danger); }
        button.danger:hover { background: #dc2626; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem; }
        th, td { border: 1px solid var(--border); padding: 10px; text-align: center; }
        th { background: #f8fafc; font-weight: 600; color: #334155; white-space: nowrap; }
        td input { width: 70px; text-align: center; }
        tr:hover { background: #f8fafc; }
        .total-row { background: #eff6ff; font-weight: bold; }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: linear-gradient(to bottom right, #ffffff, #eff6ff); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #bfdbfe; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }

        .delete-round-btn { background: #ef4444; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 16px; line-height: 1; cursor: pointer; margin-left: -3px; margin-right: 5px; vertical-align: middle; padding: 0; display: inline-flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .delete-round-btn:hover { background: #dc2626; }
        .card h3 { margin: 0 0 10px 0; color: #1e40af; font-size: 1rem; }
        .card .score { font-size: 2.5rem; font-weight: 800; color: #2563eb; margin: 10px 0; }
        .card .desc { font-size: 0.9rem; color: #64748b; }
        .badge { background: #e2e8f0; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; margin-left: 5px; }
        .current-teacher { color: var(--primary); font-weight: bold; margin-left: auto; }
        .alert-box { padding: 15px; border-radius: 8px; margin-bottom: 20px; background: #fff1f2; color: #9f1239; border: 1px solid #fecdd3; display: none; }

        .round-tabs { display: flex; gap: 5px; margin-bottom: 10px; border-bottom: 2px solid #e2e8f0; }
        .round-tab { padding: 8px 16px; border: 1px solid #e2e8f0; border-bottom: none; background: #f8fafc; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; color: #64748b; transition: all 0.2s; }
        .round-tab.active { background: white; color: #2563eb; border-color: #2563eb; border-bottom: 2px solid white; margin-bottom: -2px; }
        .round-tab:hover:not(.active) { background: #e2e8f0; }
        .round-tab.add-btn { background: #ecfdf5; color: #059669; border-color: #a7f3d0; }
        .round-tab.add-btn:hover { background: #d1fae5; }

        .diff-warning-box { display: none; padding: 10px 15px; margin-top: 10px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; color: #991b1b; font-size: 0.9rem; }
        .diff-warning-box.show { display: block; }
    </style>
</head>

<body>

    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <div class="lock-icon">ğŸ”’</div>
            <h2>ì ‘ê·¼ ê¶Œí•œ í™•ì¸</h2>
            <p class="subtitle">í—ˆê°€ëœ ì‚¬ìš©ìë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
            <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.key==='Enter') checkPassword()">
            <button onclick="checkPassword()">í™•ì¸</button>
            <p id="errorMsg" class="error-msg">âš ï¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
        </div>
    </div>

    <div id="adminModal" class="admin-modal">
        <div class="admin-modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">ğŸ”§ ê´€ë¦¬ì ë„êµ¬ - ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ ìƒì„±ê¸°</h3>
                <button onclick="closeAdminModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">âœ•</button>
            </div>
            <label style="font-weight:bold; display:block; margin-bottom:5px;">ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥:</label>
            <input type="text" id="newPasswordInput" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" oninput="generateHash()">
            <label style="font-weight:bold; display:block; margin-bottom:5px; margin-top:15px;">ìƒì„±ëœ í•´ì‹œê°’:</label>
            <div class="hash-output" id="hashOutput">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ í•´ì‹œê°’ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
            <button onclick="copyHash()" style="width:100%; margin-top:10px;">ğŸ“‹ í•´ì‹œê°’ ë³µì‚¬</button>
            <div class="instructions">
                <strong>ğŸ“ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë°©ë²•:</strong><br>
                1. ìœ„ì— ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥<br>
                2. ìƒì„±ëœ í•´ì‹œê°’ ë³µì‚¬<br>
                3. HTML íŒŒì¼ì„ ë©”ëª¨ì¥ìœ¼ë¡œ ì—´ê¸°<br>
                4. <code>PASSWORD_HASH</code> ê°’ì„ ìƒˆ í•´ì‹œë¡œ êµì²´<br>
                5. ì €ì¥ í›„ ì¬ë°°í¬
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer">
        <header>
            <div style="display:flex; align-items:center; width: 100%;">
                <div>
                    <h1>ğŸ“Š ì§€í•„í‰ê°€ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ</h1>
                    <div style="font-size: 0.85rem; opacity: 0.8;">
                        NEIS Ver. 1.0 | ë§Œë“ ì´: ì‚¬ê³¡ê³  ìµœì—°í˜¸
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-left: auto;">
                    <input type="file" id="loadProjectInput" accept=".json" style="display:none;" onchange="loadProjectData(this)">
                    <button onclick="document.getElementById('loadProjectInput').click()" style="background:#20bf6b;">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button onclick="saveProjectData()" style="background:#0f172a;">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                    <button onclick="logout()" style="background:#ef4444;">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('input')">1. ì˜ˆìƒì •ë‹µë¥ ì…ë ¥</button>
            <button class="tab" onclick="switchTab('teacherView')">2. êµì‚¬ë³„ ì…ë ¥ì •ë³´ì¡°íšŒ</button>
            <button class="tab" onclick="switchTab('categoryView')">3. ë¬¸í•­ë²”ì£¼ë³„ì¡°íšŒ</button>
            <button class="tab" onclick="switchTab('finalView')">4. ì˜ˆìƒì¶”ì •ë¶„í• ì ìˆ˜ì¡°íšŒ</button>
        </div>

        <div id="tab-input" class="content active">
            <div id="uploadAlert" class="alert-box">ğŸš¨ ì—‘ì…€ íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</div>
            <div class="section-box">
                <div class="section-title">ğŸ“ STEP 1: ë¬¸í•­ì •ë³´í‘œ ì—…ë¡œë“œ</div>
                <input type="file" id="fileInput" accept=".xlsx, .xls" onchange="handleFileUpload(event)">
                <p style="font-size:0.8rem; color:#64748b; margin-top:5px;">* ë¬¸í•­ì •ë³´í‘œ ì—‘ì…€ íŒŒì¼(ë‚˜ì´ìŠ¤ ì–‘ì‹)ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
            </div>

            <div class="section-box" id="previewSection" style="display:none; background-color:#f8fafc;">
                <div class="section-title" style="border-left-color: #10b981;">âœ… ë°ì´í„° ë¡œë“œ ì„±ê³µ</div>
                <div style="margin-bottom:10px; padding: 10px; background: #f0fdf4; border-radius: 6px;">
                    <span id="previewSummary" style="font-size:1.1rem; font-weight:bold; color:#15803d;"></span>
                </div>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 4px;">
                    <table style="width:100%; font-size:0.85rem; background:white;">
                        <thead style="position: sticky; top: 0; background: #f1f5f9;">
                            <tr><th style="padding:8px;">ë²ˆí˜¸</th><th style="padding:8px;">ë¬¸í•­ìœ í˜•</th><th style="padding:8px;">ë‚œì´ë„</th><th style="padding:8px;">ë°°ì </th></tr>
                        </thead>
                        <tbody id="previewTbody"></tbody>
                    </table>
                </div>
            </div>

            <div class="section-box" id="teacherSection" style="display:none;">
                <div class="section-title">ğŸ‘¥ STEP 2-1: ë¶„í• ì ìˆ˜ ì‚°ì¶œ ë‹¨ê³„ ì„¤ì •</div>
                <div class="radio-group">
                    <label class="radio-label"><input type="radio" name="scoreMode" value="5" checked onchange="changeScoreMode()"><strong>5ë‹¨ê³„ ë¶„í• ì ìˆ˜ (A/B ~ E/ë¯¸ë„ë‹¬)</strong></label>
                    <label class="radio-label"><input type="radio" name="scoreMode" value="4" onchange="changeScoreMode()"><strong>4ë‹¨ê³„ ë¶„í• ì ìˆ˜ (A/B ~ D/E)</strong></label>
                </div>
                <p style="font-size:0.8rem; color:#dc2626; margin-top:-10px; margin-bottom:20px;">â€» ê²½ê³ : ì„¤ì • ë³€ê²½ ì‹œ ì…ë ¥ëœ ëª¨ë“  êµì‚¬ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p>
                <div class="section-title">ğŸ‘¥ STEP 2-2: êµì‚¬ ë“±ë¡ ë° ì„ íƒ</div>
                <div class="teacher-control">
                    <input type="text" id="newTeacherName" placeholder="êµì‚¬ëª… ì…ë ¥" onkeypress="if(event.key==='Enter') addTeacher()">
                    <button onclick="addTeacher()">+ ì¶”ê°€</button>
                    <div style="margin-left: 20px;">ë“±ë¡ëœ êµì‚¬: <span id="teacherListBadge" class="badge" style="background:#dbeafe; color:#1e40af;">0ëª…</span></div>
                </div>
                <div style="margin-top:20px; padding-top:20px; border-top:1px dashed #cbd5e1; display:flex; align-items:center; gap:10px;">
                    <label style="font-weight:bold;">âœï¸ ì…ë ¥í•  êµì‚¬ ì„ íƒ: </label>
                    <select id="currentTeacherSelect" onchange="loadTeacherData()" style="padding:8px; min-width: 200px;"><option value="">êµì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option></select>
                </div>
            </div>

            <div class="section-box" id="inputTableSection" style="display:none;">
                <div class="section-title">ğŸ“ STEP 3: ì •ë‹µë¥ (%) ì…ë ¥ <span id="currentTeacherLabel" class="current-teacher"></span></div>
                <p style="font-size:0.9rem; color:#475569; margin-bottom:10px;">* ê° ë¬¸í•­ ë²”ì£¼ë³„ë¡œ ì˜ˆìƒë˜ëŠ” ì •ë‹µë¥ ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
                <div id="roundTabContainer" class="round-tabs"></div>
                <div style="overflow-x: auto;">
                    <table id="inputTable"><thead id="inputThead"></thead><tbody id="inputTbody"></tbody></table>
                </div>
                <div id="diffWarningBox" class="diff-warning-box">âš ï¸ <strong>ì£¼ì˜:</strong> ì´ì›ƒí•œ ë¶„í• ì ìˆ˜ ê°„ ì°¨ì´ê°€ 20% ì´ìƒì¸ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.</div>
                <div id="validationErrorMsg" style="color:#dc2626; font-size:0.9rem; margin-top:10px; font-weight:bold; display:none;">â€» ì œì•½ ì¡°ê±´ ë¯¸ì¶©ì¡±</div>
                <div style="text-align: right; margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="saveCurrentTeacherData()" style="padding: 12px 24px; font-size: 1.1rem; background: #64748b;">ğŸ’¾ ì„ì‹œ ì €ì¥</button>
                    <button onclick="finalizeCurrentRound()" style="padding: 12px 24px; font-size: 1.1rem; background: #22c55e;">âœ… ë§ˆê°í•˜ê¸°</button>
                    <button onclick="openCancelFinalizePopup()" style="padding: 12px 24px; font-size: 1.1rem; background: #ef4444;">ğŸ”“ ì…ë ¥ë§ˆê° ì·¨ì†Œ</button>
                </div>
            </div>
        </div>

        <div id="tab-teacherView" class="content">
            <div class="section-box">
                <div class="section-title" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ“‹ êµì‚¬ë³„ í™˜ì‚° ì ìˆ˜ í˜„í™©</span>
                    <select id="viewRoundSelect" onchange="updateTeacherStatusTable()" style="font-size:0.9rem; padding:4px;"></select>
                </div>
                <p style="margin-bottom:15px; color:#64748b;">ê° êµì‚¬ê°€ ì…ë ¥í•œ ì˜ˆìƒ ì •ë‹µë¥ ì…ë‹ˆë‹¤.</p>
                <div id="teacherDiffWarningBox" class="diff-warning-box" style="margin-bottom:15px;">âš ï¸ <strong>ì£¼ì˜:</strong> êµì‚¬ ê°„ ì ìˆ˜ ì°¨ì´ê°€ 20% ì´ìƒì¸ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.</div>
                <div style="overflow-x: auto;">
                    <table id="teacherStatusTable"><thead id="teacherStatusThead"></thead><tbody id="teacherStatusTbody"><tr><td colspan="6">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr></tbody></table>
                </div>
            </div>
        </div>

        <div id="tab-categoryView" class="content">
            <div class="section-box">
                <div class="section-title">ğŸ“Š ë¬¸í•­ ë²”ì£¼ë³„ ìƒì„¸ í†µê³„</div>
                <div style="overflow-x: auto;">
                    <table id="categoryStatsTable"><thead></thead><tbody id="categoryStatsTbody"><tr><td colspan="5">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr></tbody></table>
                </div>
            </div>
        </div>

        <div id="tab-finalView" class="content">
            <div class="section-box">
                <div class="section-title">ğŸ† ìµœì¢… ì˜ˆìƒ ì¶”ì •ë¶„í• ì ìˆ˜</div>
                <div class="result-grid" id="finalResultGrid"></div>
                <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                    <h4 style="margin-top:0;">ğŸ’¡ ì°¸ê³ ì‚¬í•­</h4>
                    <ul style="color:#475569; padding-left:20px;"><li>ì°¸ì—¬ êµì‚¬ ìˆ˜: <strong id="participatedTeacherCount">0</strong>ëª…</li></ul>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="openApprovalPopup()" style="padding: 14px 32px; font-size: 1.1rem; font-weight: bold;">ğŸ“ ìŠ¹ì¸ ìš”ì²­</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="approvalModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">ğŸ“Š ì§€í•„í‰ê°€ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ</h2>
                <button onclick="closeApprovalPopup()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">âœ•</button>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">ì˜ˆìƒì •ë‹µë¥  ì„ íƒ:</label>
                <select id="roundSelectForApproval" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px;"></select>
            </div>
            <div style="background: #fef3c7; padding: 15px; border-radius: 6px; margin-bottom: 20px;"><p style="margin: 0; color: #92400e;">âš ï¸ ë‚˜ì´ìŠ¤ì—ì„œ ì„ íƒ í›„ ìƒì‹ í•¨</p></div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;"><button onclick="closeApprovalPopup()" style="padding: 10px 20px; background: #e2e8f0; color: #475569;">ë‹«ê¸°</button></div>
        </div>
    </div>

    <div id="cancelFinalizeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">ğŸ”“ ì…ë ¥ë§ˆê° ì·¨ì†Œ</h2>
                <button onclick="closeCancelFinalizePopup()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">âœ•</button>
            </div>
            <div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; color: #991b1b;">âš ï¸ ê²½ê³ : ë§ˆê°ì„ ì·¨ì†Œí•˜ë©´ í•´ë‹¹ ë¼ìš´ë“œë¥¼ ë‹¤ì‹œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">ì·¨ì†Œ ì‚¬ìœ  ì„ íƒ (í•„ìˆ˜):</label>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="display: flex; align-items: center; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer;"><input type="radio" name="cancelReason" value="ë¬¸í•­ ì˜¤ë¥˜ë¡œ ì¸í•œ ë§Œì  ë³€ë™" style="margin-right: 10px;"><span>ë¬¸í•­ ì˜¤ë¥˜ë¡œ ì¸í•œ ë§Œì  ë³€ë™</span></label>
                    <label style="display: flex; align-items: center; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer;"><input type="radio" name="cancelReason" value="ì „ë©´ ì¬ì‹œí—˜" style="margin-right: 10px;"><span>ì „ë©´ ì¬ì‹œí—˜</span></label>
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeCancelFinalizePopup()" style="padding: 10px 20px; background: #e2e8f0; color: #475569;">ì·¨ì†Œ</button>
                <button onclick="confirmCancelFinalize()" style="padding: 10px 20px; background: #ef4444; color: white; font-weight: bold;">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        const PASSWORD_HASH = "b5ebe8df6c812527c958756e0a6515ff280316428554085177e36fe71b1ac11b";

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const hash = await sha256(input);
            if (hash === PASSWORD_HASH) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContainer').classList.add('unlocked');
                sessionStorage.setItem('authenticated', 'true');
            } else {
                document.getElementById('errorMsg').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        function logout() {
            sessionStorage.removeItem('authenticated');
            document.getElementById('mainContainer').classList.remove('unlocked');
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('errorMsg').style.display = 'none';
        }

        function checkSession() {
            if (sessionStorage.getItem('authenticated') === 'true') {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContainer').classList.add('unlocked');
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                document.getElementById('adminModal').style.display = 'flex';
            }
        });

        function closeAdminModal() { document.getElementById('adminModal').style.display = 'none'; }

        async function generateHash() {
            const password = document.getElementById('newPasswordInput').value;
            document.getElementById('hashOutput').textContent = password ? await sha256(password) : 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ í•´ì‹œê°’ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤';
        }

        function copyHash() {
            const hash = document.getElementById('hashOutput').textContent;
            if (hash && !hash.includes('ë¹„ë°€ë²ˆí˜¸ë¥¼')) navigator.clipboard.writeText(hash).then(() => alert('í•´ì‹œê°’ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'));
        }

        let rawData = [], excelData = [], categories = [], teachers = [], currentRound = 0, currentScoreMode = 5;
        const DIFF_THRESHOLD = 20;

        const SCORE_CONFIG = {
            4: { headers: ['A/B (%)', 'B/C (%)', 'C/D (%)', 'D/E (%)'], keys: ['ab', 'bc', 'cd', 'de'], descriptions: ['A/B ê²½ê³„', 'B/C ê²½ê³„', 'C/D ê²½ê³„', 'D/E ê²½ê³„'] },
            5: { headers: ['A/B (%)', 'B/C (%)', 'C/D (%)', 'D/E (%)', 'E/ë¯¸ë„ë‹¬ (%)'], keys: ['ab', 'bc', 'cd', 'de', 'ef'], descriptions: ['A/B ê²½ê³„', 'B/C ê²½ê³„', 'C/D ê²½ê³„', 'D/E ê²½ê³„', 'E/ë¯¸ë„ë‹¬ ê²½ê³„'] }
        };

        window.onload = function () { checkSession(); switchTab('input'); };

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelector(`button[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.querySelector(`#tab-${tabId}`).classList.add('active');
            if (tabId === 'teacherView') updateTeacherStatusTable();
            if (tabId === 'categoryView') updateCategoryStatsTable();
            if (tabId === 'finalView') updateFinalResult();
        }

        function changeScoreMode() {
            const radios = document.getElementsByName('scoreMode');
            let selected;
            for (const r of radios) { if (r.checked) selected = parseInt(r.value); }
            if (selected === currentScoreMode) return;
            if (teachers.length > 0) {
                if (!confirm("ì„¤ì •ì„ ë³€ê²½í•˜ë©´ ë“±ë¡ëœ ëª¨ë“  êµì‚¬ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    for (const r of radios) { if (parseInt(r.value) === currentScoreMode) r.checked = true; }
                    return;
                }
                teachers = [];
                updateTeacherUI();
                document.getElementById('inputTableSection').style.display = 'none';
            }
            currentScoreMode = selected;
        }

        const getMean = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
        const getSD = (arr) => { if (arr.length <= 1) return 0; const mean = getMean(arr); return Math.sqrt(arr.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (arr.length - 1)); };
        const getMin = (arr) => arr.length ? Math.min(...arr) : 0;
        const getMax = (arr) => arr.length ? Math.max(...arr) : 0;

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                if (rawData.length < 1) { alert("ë°ì´í„°ê°€ ì—†ëŠ” ì—‘ì…€ íŒŒì¼ì…ë‹ˆë‹¤."); return; }

                let headerRowIdx = -1, scoreIdx = -1;
                for (let i = 0; i < Math.min(rawData.length, 30); i++) {
                    const row = rawData[i];
                    if (!row || row.length === 0) continue;
                    const rowStr = row.map(c => String(c).replace(/\s/g, '')).join(' ');
                    if (rowStr.includes('ë°°ì ') && rowStr.includes('ë¬¸í•­ë²ˆí˜¸')) { headerRowIdx = i; scoreIdx = row.findIndex(c => String(c).trim() === 'ë°°ì '); break; }
                }
                if (headerRowIdx === -1 || scoreIdx === -1) { alert("ì–‘ì‹ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

                let hardIdx = -1, midIdx = -1, easyIdx = -1;
                for (let r = headerRowIdx; r <= headerRowIdx + 1; r++) {
                    const row = rawData[r];
                    if (!row) continue;
                    row.forEach((cell, idx) => {
                        const val = String(cell).trim().replace(/\s/g, '');
                        if (val === 'ì–´ë ¤ì›€') hardIdx = idx;
                        else if (val === 'ë³´í†µ') midIdx = idx;
                        else if (val === 'ì‰¬ì›€') easyIdx = idx;
                    });
                }
                if (hardIdx === -1) { alert("ë‚œì´ë„ êµ¬ë¶„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

                excelData = [];
                let currentType = '';
                for (let i = headerRowIdx + 2; i < rawData.length; i++) {
                    const row = rawData[i];
                    if (!row) continue;
                    const fullText = row.map(c => String(c)).join('');
                    if (fullText.includes('ì„ íƒí˜• ë¬¸í•­') || fullText.includes('ì„ íƒí˜•ë¬¸í•­')) { currentType = 'ì„ íƒí˜•'; continue; }
                    if (fullText.includes('ì„œë‹µí˜• ë¬¸í•­') || fullText.includes('ì„œë‹µí˜•ë¬¸í•­')) { currentType = 'ì„œë‹µí˜•'; continue; }
                    const scoreVal = row[scoreIdx];
                    if (scoreVal === undefined || scoreVal === null || scoreVal === '' || isNaN(scoreVal)) continue;
                    let difficulty = '';
                    if (String(row[hardIdx] || '').includes('O') || String(row[hardIdx] || '').includes('â—‹')) difficulty = 'ì–´ë ¤ì›€';
                    else if (String(row[midIdx] || '').includes('O') || String(row[midIdx] || '').includes('â—‹')) difficulty = 'ë³´í†µ';
                    else if (String(row[easyIdx] || '').includes('O') || String(row[easyIdx] || '').includes('â—‹')) difficulty = 'ì‰¬ì›€';
                    else continue;
                    excelData.push({ type: currentType || 'ì„ íƒí˜•', difficulty, score: parseFloat(scoreVal) });
                }
                if (excelData.length === 0) { alert("ë¬¸í•­ ë°ì´í„°ë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); return; }

                processCategories();
                document.getElementById('teacherSection').style.display = 'block';
                document.getElementById('uploadAlert').style.display = 'none';
                renderPreview(excelData);
                event.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        function renderPreview(data) {
            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('previewSummary').innerHTML = `ì´ ${data.length}ë¬¸í•­ ë¡œë“œ ì™„ë£Œ (ì„ íƒí˜•: ${data.filter(d => d.type === 'ì„ íƒí˜•').length} / ì„œë‹µí˜•: ${data.filter(d => d.type === 'ì„œë‹µí˜•').length})`;
            document.getElementById('previewTbody').innerHTML = data.map((item, i) => `<tr style="background:${item.type === 'ì„œë‹µí˜•' ? '#fff7ed' : 'white'}"><td>${i + 1}</td><td>${item.type}</td><td>${item.difficulty}</td><td>${item.score}</td></tr>`).join('');
        }

        function processCategories() {
            const catMap = new Map();
            excelData.forEach(item => {
                const key = `${item.type}|${item.difficulty}`;
                if (!catMap.has(key)) catMap.set(key, { type: item.type, difficulty: item.difficulty, count: 0, totalScore: 0 });
                const cat = catMap.get(key);
                cat.count++;
                cat.totalScore += item.score;
            });
            categories = Array.from(catMap.values());
            const diffOrder = { 'ì‰¬ì›€': 1, 'ë³´í†µ': 2, 'ì–´ë ¤ì›€': 3 };
            categories.sort((a, b) => a.type !== b.type ? (a.type === 'ì„ íƒí˜•' ? -1 : 1) : (diffOrder[a.difficulty] || 99) - (diffOrder[b.difficulty] || 99));
        }

        function addTeacher() {
            const name = document.getElementById('newTeacherName').value.trim();
            if (!name) { alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
            if (teachers.some(t => t.name === name)) { alert("ì´ë¯¸ ìˆìŠµë‹ˆë‹¤."); return; }
            teachers.push({ name, rounds: [categories.map(() => Array(currentScoreMode).fill(null))], completedRounds: [] });
            document.getElementById('newTeacherName').value = '';
            updateTeacherUI();
            alert(`'${name}' êµì‚¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        function updateTeacherUI() {
            document.getElementById('teacherListBadge').textContent = `${teachers.length}ëª…`;
            const select = document.getElementById('currentTeacherSelect');
            const currentVal = select.value;
            select.innerHTML = '<option value="">êµì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            teachers.forEach((t, idx) => { const opt = document.createElement('option'); opt.value = idx; opt.textContent = t.name; select.appendChild(opt); });
            select.value = currentVal;
            if (typeof renderRoundTabs === 'function') renderRoundTabs();
        }

        function loadTeacherData() {
            const idx = document.getElementById('currentTeacherSelect').value;
            if (idx === "") { document.getElementById('inputTableSection').style.display = 'none'; return; }
            document.getElementById('inputTableSection').style.display = 'block';
            document.getElementById('currentTeacherLabel').textContent = `- ${teachers[idx].name} ì„ ìƒë‹˜`;
            renderRoundTabs();
            renderInputTable(teachers[idx]);
        }

        function renderInputTable(teacher) {
            const thead = document.getElementById('inputThead'), tbody = document.getElementById('inputTbody'), config = SCORE_CONFIG[currentScoreMode];
            thead.innerHTML = `<tr><th>ë¬¸í•­ìœ í˜•</th><th>ë‚œì´ë„</th><th>ë¬¸í•­ìˆ˜</th><th>ë°°ì í•©</th>${config.headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            tbody.innerHTML = '';
            categories.forEach((cat, catIdx) => {
                const tr = document.createElement('tr');
                if (!teacher.rounds[currentRound]) teacher.rounds[currentRound] = categories.map(() => Array(config.keys.length).fill(null));
                const values = teacher.rounds[currentRound][catIdx] || Array(config.keys.length).fill(null);
                let html = `<td>${cat.type}</td><td>${cat.difficulty}</td><td>${cat.count}</td><td>${cat.totalScore.toFixed(1)}</td>`;
                for (let i = 0; i < config.keys.length; i++) {
                    const val = values[i] !== null ? values[i] : '';
                    const disabled = teacher.completedRounds && teacher.completedRounds.includes(currentRound) ? 'disabled' : '';
                    if (currentScoreMode === 5 && i === 4) {
                        html += `<td><input type="number" min="20" max="100" step="1" class="inp-rate" data-cat="${catIdx}" data-idx="${i}" value="${val}" oninput="onInputChange()" ${disabled}></td>`;
                    } else {
                        let opts = '<option value="">ì„ íƒ</option>';
                        for (let o = 0; o <= 100; o += 5) opts += `<option value="${o}" ${val !== '' && parseInt(val) === o ? 'selected' : ''}>${o}</option>`;
                        html += `<td><select class="inp-rate" data-cat="${catIdx}" data-idx="${i}" onchange="onInputChange()" ${disabled}>${opts}</select></td>`;
                    }
                }
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
            setTimeout(() => { validateInputs(); checkNeighborDiff(); }, 50);
        }

        function onInputChange() { validateInputs(); checkNeighborDiff(); }

        function checkNeighborDiff() {
            const diffWarningBox = document.getElementById('diffWarningBox'), inputs = document.querySelectorAll('.inp-rate'), config = SCORE_CONFIG[currentScoreMode];
            let hasDiff = false;
            inputs.forEach(inp => inp.classList.remove('warning-diff'));
            categories.forEach((cat, catIdx) => {
                for (let colIdx = 0; colIdx < config.keys.length - 1; colIdx++) {
                    const leftInp = document.querySelector(`.inp-rate[data-cat="${catIdx}"][data-idx="${colIdx}"]`);
                    const rightInp = document.querySelector(`.inp-rate[data-cat="${catIdx}"][data-idx="${colIdx + 1}"]`);
                    if (leftInp && rightInp && leftInp.value !== '' && rightInp.value !== '' && Math.abs(parseFloat(leftInp.value) - parseFloat(rightInp.value)) >= DIFF_THRESHOLD) {
                        leftInp.classList.add('warning-diff'); rightInp.classList.add('warning-diff'); hasDiff = true;
                    }
                }
            });
            if (diffWarningBox) diffWarningBox.classList.toggle('show', hasDiff);
        }

        function validateInputs() {
            const inputs = document.querySelectorAll('.inp-rate');
            let isValid = true;
            inputs.forEach(inp => inp.classList.remove('invalid-input'));
            inputs.forEach(inp => {
                const valStr = inp.value, colIdx = parseInt(inp.dataset.idx);
                if (valStr === '') return;
                const val = parseFloat(valStr);
                if (val < 0 || val > 100) { inp.classList.add('invalid-input'); isValid = false; return; }
                if (currentScoreMode === 5 && colIdx === 4) { if (val < 20 || !Number.isInteger(val)) { inp.classList.add('invalid-input'); isValid = false; return; } }
                else { if (val % 5 !== 0) { inp.classList.add('invalid-input'); isValid = false; } }
            });
            const config = SCORE_CONFIG[currentScoreMode];
            categories.forEach((cat, rIdx) => {
                for (let c = 0; c < config.keys.length - 1; c++) {
                    const left = document.querySelector(`.inp-rate[data-cat="${rIdx}"][data-idx="${c}"]`);
                    const right = document.querySelector(`.inp-rate[data-cat="${rIdx}"][data-idx="${c + 1}"]`);
                    if (left && right && left.value !== '' && right.value !== '' && parseFloat(left.value) < parseFloat(right.value)) {
                        left.classList.add('invalid-input'); right.classList.add('invalid-input'); isValid = false;
                    }
                }
            });
            ['ì„ íƒí˜•', 'ì„œë‹µí˜•'].forEach(type => {
                for (let c = 0; c < config.keys.length; c++) {
                    const catIndices = {};
                    categories.forEach((cat, idx) => { if (cat.type === type) catIndices[cat.difficulty] = idx; });
                    [['ì‰¬ì›€', 'ë³´í†µ'], ['ë³´í†µ', 'ì–´ë ¤ì›€'], ['ì‰¬ì›€', 'ì–´ë ¤ì›€']].forEach(([e, h]) => {
                        if (catIndices[e] !== undefined && catIndices[h] !== undefined) {
                            const eInp = document.querySelector(`.inp-rate[data-cat="${catIndices[e]}"][data-idx="${c}"]`);
                            const hInp = document.querySelector(`.inp-rate[data-cat="${catIndices[h]}"][data-idx="${c}"]`);
                            if (eInp && hInp && eInp.value !== '' && hInp.value !== '' && parseFloat(eInp.value) < parseFloat(hInp.value)) {
                                eInp.classList.add('invalid-input'); hInp.classList.add('invalid-input'); isValid = false;
                            }
                        }
                    });
                }
            });
            document.getElementById('validationErrorMsg').style.display = isValid ? 'none' : 'block';
            return isValid;
        }

        function saveCurrentTeacherData() {
            if (!validateInputs()) { alert("ì…ë ¥ê°’ ì œì•½ ì¡°ê±´ì„ í™•ì¸í•˜ì„¸ìš”."); return; }
            const idx = document.getElementById('currentTeacherSelect').value;
            if (idx === "") return;
            const teacher = teachers[idx], inputs = document.querySelectorAll('.inp-rate');
            let isComplete = true;
            inputs.forEach(inp => {
                const catIdx = parseInt(inp.dataset.cat), valIdx = parseInt(inp.dataset.idx), val = inp.value;
                if (!teacher.rounds[currentRound]) teacher.rounds[currentRound] = JSON.parse(JSON.stringify(teacher.rounds[0]));
                teacher.rounds[currentRound][catIdx][valIdx] = val === '' ? null : parseFloat(val);
                if (val === '') isComplete = false;
            });
            if (!isComplete) { alert("ëª¨ë“  ë¬¸í•­ì— ëŒ€í•œ ì •ë‹µë¥ ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."); return; }
            alert(`ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (${currentRound + 1}ë¼ìš´ë“œ)`);
        }

        function finalizeCurrentRound() {
            const idx = document.getElementById('currentTeacherSelect').value;
            if (idx === "") { alert("êµì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            const teacher = teachers[idx];
            if (!validateInputs()) { alert("ì…ë ¥ê°’ ì œì•½ ì¡°ê±´ì„ í™•ì¸í•˜ì„¸ìš”."); return; }
            const inputs = document.querySelectorAll('.inp-rate');
            let isComplete = true;
            inputs.forEach(inp => {
                const catIdx = parseInt(inp.dataset.cat), valIdx = parseInt(inp.dataset.idx), val = inp.value;
                if (!teacher.rounds[currentRound]) teacher.rounds[currentRound] = JSON.parse(JSON.stringify(teacher.rounds[0]));
                teacher.rounds[currentRound][catIdx][valIdx] = val === '' ? null : parseFloat(val);
                if (val === '') isComplete = false;
            });
            if (!isComplete) { alert("ëª¨ë“  ë¬¸í•­ì— ëŒ€í•œ ì •ë‹µë¥ ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."); return; }
            if (!teacher.completedRounds) teacher.completedRounds = [];
            if (teacher.completedRounds.includes(currentRound)) { alert("ì´ë¯¸ ë§ˆê°ëœ ë¼ìš´ë“œì…ë‹ˆë‹¤."); return; }
            if (!confirm(`${teacher.name} ì„ ìƒë‹˜ì˜ ${currentRound + 1}ë¼ìš´ë“œë¥¼ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            teacher.completedRounds.push(currentRound);
            alert(`${teacher.name} ì„ ìƒë‹˜ì˜ ${currentRound + 1}ë¼ìš´ë“œê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            if (teachers.every(t => t.completedRounds && t.completedRounds.includes(currentRound)) && confirm(`ëª¨ë“  êµì‚¬ê°€ ë§ˆê°í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const useCopy = confirm("ì´ì „ ë¼ìš´ë“œ ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                teachers.forEach(t => { t.rounds.push(useCopy ? JSON.parse(JSON.stringify(t.rounds[t.rounds.length - 1])) : categories.map(() => Array(currentScoreMode).fill(null))); });
                switchRound(teachers[0].rounds.length - 1);
            }
            renderInputTable(teacher); renderRoundTabs();
        }

        function updateTeacherStatusTable() {
            const select = document.getElementById('viewRoundSelect');
            let targetRound = currentRound;
            if (select) {
                const maxRound = (teachers.length > 0 && teachers[0].rounds) ? teachers[0].rounds.length : 1;
                const savedVal = select.value;
                select.innerHTML = '';
                for (let i = 0; i < maxRound; i++) {
                    if (teachers.length > 0 && teachers.every(t => t.completedRounds && t.completedRounds.includes(i))) {
                        const opt = document.createElement('option'); opt.value = i; opt.text = (i + 1) + "ë¼ìš´ë“œ"; select.appendChild(opt);
                    }
                }
                if (savedVal !== '' && select.querySelector(`option[value="${savedVal}"]`)) select.value = savedVal;
                else if (select.options.length > 0) select.value = select.options[0].value;
                if (select.value !== "") targetRound = parseInt(select.value);
            }
            const thead = document.getElementById('teacherStatusThead'), tbody = document.getElementById('teacherStatusTbody'), config = SCORE_CONFIG[currentScoreMode];
            const labels = currentScoreMode === 5 ? ['A', 'B', 'C', 'D', 'E'] : ['A', 'B', 'C', 'D'];
            thead.innerHTML = `<tr><th rowspan="2">ë¬¸í•­ìœ í˜•</th><th rowspan="2">ë‚œì´ë„</th><th rowspan="2">êµì‚¬</th><th rowspan="2">ë°°ì í•©(ë¬¸í•­ìˆ˜)</th><th colspan="${config.keys.length}">ì„±ì·¨ìˆ˜ì¤€</th></tr><tr>${labels.map(l => `<th>${l}</th>`).join('')}</tr>`;
            tbody.innerHTML = '';
            if (categories.length === 0 || teachers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${4 + config.keys.length}">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                document.getElementById('teacherDiffWarningBox').classList.remove('show');
                return;
            }
            const teacherValues = {};
            let hasTeacherDiff = false;
            const diffCells = new Set();
            categories.forEach((cat, catIdx) => {
                teachers.forEach((teacher, tIdx) => {
                    const inputsForRound = teacher.rounds[targetRound];
                    const inputsForCategory = (inputsForRound && inputsForRound[catIdx]) || Array(config.keys.length).fill(null);
                    inputsForCategory.forEach((val, colIdx) => {
                        const key = `${catIdx}_${colIdx}`;
                        if (!teacherValues[key]) teacherValues[key] = [];
                        teacherValues[key].push({ tIdx, val });
                    });
                });
            });
            Object.keys(teacherValues).forEach(key => {
                const values = teacherValues[key].filter(v => v.val !== null);
                if (values.length >= 2 && Math.max(...values.map(v => v.val)) - Math.min(...values.map(v => v.val)) >= DIFF_THRESHOLD) {
                    hasTeacherDiff = true;
                    values.forEach(v => { diffCells.add(`${key}_${v.tIdx}`); });
                }
            });
            categories.forEach((cat, catIdx) => {
                teachers.forEach((teacher, tIdx) => {
                    const tr = document.createElement('tr');
                    const inputsForRound = teacher.rounds[targetRound];
                    const inputsForCategory = (inputsForRound && inputsForRound[catIdx]) || Array(config.keys.length).fill(null);
                    const isAllComplete = inputsForRound && inputsForRound.every(row => row && row.every(v => v !== null));
                    let rowHTML = `<td>${cat.type}</td><td>${cat.difficulty}</td><td style="text-align:left; padding-left:10px;">${isAllComplete ? '[ë§ˆê°]' : '[ì§„í–‰]'}${teacher.name}</td><td>${cat.totalScore.toFixed(0)}(${cat.count})</td>`;
                    inputsForCategory.forEach((val, colIdx) => {
                        rowHTML += `<td class="${diffCells.has(`${catIdx}_${colIdx}_${tIdx}`) ? 'warning-cell' : ''}">${val !== null ? val : ''}</td>`;
                    });
                    tr.innerHTML = rowHTML;
                    tbody.appendChild(tr);
                });
            });
            document.getElementById('teacherDiffWarningBox').classList.toggle('show', hasTeacherDiff);
        }

        function updateCategoryStatsTable() {
            const table = document.getElementById('categoryStatsTable'), thead = table.querySelector('thead'), tbody = document.getElementById('categoryStatsTbody');
            const config = SCORE_CONFIG[currentScoreMode], labels = currentScoreMode === 5 ? ['A', 'B', 'C', 'D', 'E'] : ['A', 'B', 'C', 'D'];
            thead.innerHTML = `<tr><th rowspan="2">ë¬¸í•­ìœ í˜•</th><th rowspan="2">ë‚œì´ë„</th>${labels.map(l => `<th colspan="4">${l}</th>`).join('')}</tr><tr>${config.keys.map(() => `<th>í‰ê· </th><th>í‘œì¤€í¸ì°¨</th><th>ìµœì†Ÿê°’</th><th>ìµœëŒ“ê°’</th>`).join('')}</tr>`;
            tbody.innerHTML = '';
            if (categories.length === 0) { tbody.innerHTML = `<tr><td colspan="${2 + config.keys.length * 4}">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; return; }
            categories.forEach((cat, catIdx) => {
                const tr = document.createElement('tr');
                let rowHtml = `<td>${cat.type}</td><td>${cat.difficulty}</td>`;
                config.keys.forEach((_, colIdx) => {
                    const values = [];
                    teachers.forEach(t => { if (t.rounds[currentRound] && t.rounds[currentRound][catIdx]) { const val = t.rounds[currentRound][catIdx][colIdx]; if (val !== null) values.push(parseFloat(val)); } });
                    rowHtml += `<td>${values.length ? getMean(values).toFixed(2) : '-'}</td><td>${values.length ? getSD(values).toFixed(2) : '-'}</td><td>${values.length ? getMin(values) : '-'}</td><td>${values.length ? getMax(values) : '-'}</td>`;
                });
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        }

        function updateFinalResult() {
            const config = SCORE_CONFIG[currentScoreMode], grid = document.getElementById('finalResultGrid');
            grid.innerHTML = '';
            const levelScores = Array(config.keys.length).fill(null).map(() => []);
            let validTeacherCount = 0;
            teachers.forEach(t => {
                const currentInputs = t.rounds[currentRound];
                if (currentInputs && currentInputs.every(row => row && row.every(v => v !== null))) {
                    calculateCutScores(t).forEach((s, i) => levelScores[i].push(s));
                    validTeacherCount++;
                }
            });
            document.getElementById('participatedTeacherCount').innerText = `${validTeacherCount} (Round ${currentRound + 1})`;
            const table = document.createElement('table');
            table.style.width = '100%';
            table.innerHTML = `<thead><tr><th>êµ¬ë¶„</th>${config.headers.map(h => `<th>${h.split(' ')[0]}</th>`).join('')}</tr></thead><tbody>${[{ label: 'í‰ê· ', fn: getMean }, { label: 'í‘œì¤€í¸ì°¨', fn: getSD }, { label: 'ìµœì†Ÿê°’', fn: getMin }, { label: 'ìµœëŒ“ê°’', fn: getMax }].map(stat => `<tr><td>${stat.label}</td>${levelScores.map(scores => `<td>${scores.length ? stat.fn(scores).toFixed(2) : '-'}</td>`).join('')}</tr>`).join('')}</tbody>`;
            grid.appendChild(table);
        }

        function calculateCutScores(teacher) {
            const config = SCORE_CONFIG[currentScoreMode], results = Array(config.keys.length).fill(0), currentInputs = teacher.rounds[currentRound] || [];
            currentInputs.forEach((rowValues, catIdx) => { rowValues.forEach((val, valIdx) => { if (val !== null) results[valIdx] += categories[catIdx].totalScore * (val / 100); }); });
            return results;
        }

        function renderRoundTabs() {
            const maxRound = (teachers.length > 0 && teachers[0].rounds) ? teachers[0].rounds.length : 1;
            const tabContainer = document.getElementById('roundTabContainer');
            if (!tabContainer) return;
            let html = '';
            for (let i = 0; i < maxRound; i++) {
                const allCompleted = teachers.length > 0 && teachers.every(t => t.completedRounds && t.completedRounds.includes(i));
                html += `<button class="round-tab ${i === currentRound ? 'active' : ''}" onclick="switchRound(${i})">${i + 1}ë¼ìš´ë“œ${allCompleted ? ' âœ“' : ''}</button>`;
                if (i > 0) html += `<button class="delete-round-btn" onclick="deleteRound(${i})">Ã—</button>`;
            }
            html += `<button class="round-tab add-btn" onclick="addNewRound()">+ ì¶”ê°€</button>`;
            tabContainer.innerHTML = html;
        }

        function switchRound(roundIdx) {
            currentRound = roundIdx;
            renderRoundTabs();
            loadTeacherData();
            updateTeacherStatusTable();
            updateFinalResult();
            updateCategoryStatsTable();
            const idx = document.getElementById('currentTeacherSelect').value;
            if (idx !== "") document.getElementById('currentTeacherLabel').textContent = `- ${teachers[idx].name} ì„ ìƒë‹˜ (${currentRound + 1}ë¼ìš´ë“œ)`;
        }

        function addNewRound() {
            if (teachers.length === 0) { alert("êµì‚¬ë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”."); return; }
            if (!confirm("ìƒˆë¡œìš´ í‰ê°€ ë¼ìš´ë“œë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const useCopy = confirm("ì´ì „ ë¼ìš´ë“œ ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            teachers.forEach(t => { t.rounds.push(useCopy ? JSON.parse(JSON.stringify(t.rounds[t.rounds.length - 1])) : categories.map(() => Array(currentScoreMode).fill(null))); });
            switchRound(teachers[0].rounds.length - 1);
        }

        function saveProjectData() {
            if (teachers.length === 0 && excelData.length === 0) { alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
            const data = { timestamp: new Date().toISOString(), currentScoreMode, currentRound, teachers, excelData, categories, rawData };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const now = new Date();
            a.download = `ì§€í•„í‰ê°€ ì¶”ì •ë¶„í• ì ìˆ˜ ì‚°ì¶œ(${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}).json`;
            a.click();
        }

        function loadProjectData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.currentScoreMode) currentScoreMode = data.currentScoreMode;
                    if (data.currentRound !== undefined) currentRound = data.currentRound;
                    if (data.teachers) teachers = data.teachers;
                    if (data.excelData) excelData = data.excelData;
                    if (data.categories) categories = data.categories;
                    if (data.rawData) rawData = data.rawData;
                    const radio = document.querySelector(`input[name="scoreMode"][value="${currentScoreMode}"]`);
                    if (radio) radio.checked = true;
                    if (excelData.length > 0) { document.getElementById('teacherSection').style.display = 'block'; document.getElementById('uploadAlert').style.display = 'none'; renderPreview(excelData); }
                    updateTeacherUI();
                    renderRoundTabs();
                    switchRound(currentRound);
                    alert("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                } catch (err) { alert("íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜: " + err.message); }
                input.value = '';
            };
            reader.readAsText(file);
        }

        function openApprovalPopup() {
            const modal = document.getElementById('approvalModal'), roundSelect = document.getElementById('roundSelectForApproval'), config = SCORE_CONFIG[currentScoreMode];
            roundSelect.innerHTML = '';
            const maxRound = (teachers.length > 0 && teachers[0].rounds) ? teachers[0].rounds.length : 1;
            for (let i = 0; i < maxRound; i++) {
                if (teachers.length > 0 && teachers.every(t => t.completedRounds && t.completedRounds.includes(i))) {
                    const sums = Array(config.keys.length).fill(0);
                    let validCount = 0;
                    teachers.forEach(t => {
                        const roundInputs = t.rounds[i];
                        if (roundInputs && roundInputs.every(row => row && row.every(v => v !== null))) {
                            const savedRound = currentRound; currentRound = i;
                            calculateCutScores(t).forEach((s, idx) => sums[idx] += s);
                            currentRound = savedRound; validCount++;
                        }
                    });
                    const option = document.createElement('option');
                    option.value = i;
                    option.text = `${i + 1}ë¼ìš´ë“œ ê²°ê³¼: [${sums.map(s => validCount > 0 ? (s / validCount).toFixed(2) : '-').join(', ')}]`;
                    roundSelect.appendChild(option);
                }
            }
            modal.style.display = 'flex';
        }

        function closeApprovalPopup() { document.getElementById('approvalModal').style.display = 'none'; }

        function openCancelFinalizePopup() {
            const idx = document.getElementById('currentTeacherSelect').value;
            if (idx === "") { alert("êµì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            if (!teachers[idx].completedRounds || !teachers[idx].completedRounds.includes(currentRound)) { alert("í˜„ì¬ ë¼ìš´ë“œëŠ” ë§ˆê°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }
            document.querySelectorAll('input[name="cancelReason"]').forEach(r => { r.checked = false; });
            document.getElementById('cancelFinalizeModal').style.display = 'flex';
        }

        function closeCancelFinalizePopup() { document.getElementById('cancelFinalizeModal').style.display = 'none'; }

        function confirmCancelFinalize() {
            const selectedReason = document.querySelector('input[name="cancelReason"]:checked');
            if (!selectedReason) { alert("ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            if (!confirm(`ì…ë ¥ë§ˆê°ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚¬ìœ : ${selectedReason.value}`)) return;
            teachers.forEach(t => { if (t.completedRounds) { const index = t.completedRounds.indexOf(currentRound); if (index > -1) t.completedRounds.splice(index, 1); } });
            alert(`${currentRound + 1}ë¼ìš´ë“œì˜ ì…ë ¥ë§ˆê°ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            const idx = document.getElementById('currentTeacherSelect').value;
            if (idx !== "") renderInputTable(teachers[idx]);
            renderRoundTabs();
            updateTeacherStatusTable();
            closeCancelFinalizePopup();
        }

        function deleteRound(roundIndex) {
            if (roundIndex === 0) { alert("ì²« ë²ˆì§¸ ë¼ìš´ë“œëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            if (!confirm(`${roundIndex + 1}ë¼ìš´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            teachers.forEach(t => { t.rounds.splice(roundIndex, 1); if (t.completedRounds) t.completedRounds = t.completedRounds.filter(r => r !== roundIndex).map(r => r > roundIndex ? r - 1 : r); });
            if (currentRound >= roundIndex) currentRound = Math.max(0, currentRound - 1);
            alert(`${roundIndex + 1}ë¼ìš´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            switchRound(currentRound);
        }
    </script>
</body>
</html>
